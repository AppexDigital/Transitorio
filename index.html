<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sensación Boogaloo | Elite Dance Academy</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fuentes Premium -->
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;600;700&family=Cinzel:wght@400;700;900&family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400&family=Montserrat:wght@300;400;700&family=Lato:wght@300;400;700&family=Bodoni+Moda:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        void: '#020203',     // Negro Absoluto (Fondo)
                        panel: '#08090B',    // Paneles Secundarios
                        surface: '#121418',  // Tarjetas
                        gold: 'var(--color-gold)', // Dinámico
                        neon: 'var(--color-neon)', // Dinámico
                        success: '#00E676',
                        danger: '#FF1744'
                    },
                    fontFamily: {
                        sans: ['Space Grotesk', 'sans-serif'],
                        serif: ['Cinzel', 'serif'],
                    },
                    backgroundImage: {
                        'grid-pattern': "url('https://www.transparenttextures.com/patterns/carbon-fibre.png')",
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(20px) scale(0.98)' },
                            '100%': { opacity: '1', transform: 'translateY(0) scale(1)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --color-gold: #9e9634;
            --color-neon: #00F3FF;

            --font-serif: 'Cinzel', serif;
            --font-sans: 'Space Grotesk', sans-serif;
        }

        .font-serif { font-family: var(--font-serif) !important; }
        .font-sans { font-family: var(--font-sans) !important; }

        body { background-color: var(--color-void); color: #E0E0E0; overflow-x: hidden; }
        
        /* MOTOR SPA */
        section.app-view { display: none !important; }
        section.app-view.active { display: block !important; animation: fadeIn 0.5s ease-out forwards; }
        
        #view-inicio.active { display: flex !important; }

        /* Glassmorphism Ultra-Dark */
        .glass-nav {
            background: rgba(2, 2, 3, 0.9);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .glass-card {
            background: rgba(20, 22, 26, 0.6);
            backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .glass-card:hover {
            border-color: var(--color-gold);
            transform: translateY(-5px);
            box-shadow: 0 20px 50px -10px rgba(0, 0, 0, 0.5);
        }

        /* Botones Galácticos */
        .btn-galaxy {
            background: linear-gradient(135deg, var(--color-gold) 0%, #B8860B 100%);
            color: #000000 !important;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border: none;
        }
        .btn-galaxy::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: 0.5s;
        }
        .btn-galaxy:hover::before { left: 100%; }
        .btn-galaxy:hover { box-shadow: 0 0 20px var(--color-gold); transform: scale(1.02); color: #000; }

        .btn-neon {
            background: transparent;
            border: 1px solid var(--color-neon);
            color: var(--color-neon);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            transition: all 0.3s ease;
        }
        .btn-neon:hover {
            background: var(--color-neon);
            color: #000;
            box-shadow: 0 0 25px var(--color-neon);
        }

        /* Inputs Flotantes (Floating Labels) */
        .input-group { position: relative; margin-bottom: 1.5rem; }
        .input-field {
            width: 100%;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            color: white;
            outline: none;
            font-size: 1rem;
            transition: border-color 0.3s, background 0.3s;
        }
        .input-field:focus { border-color: var(--color-gold); background: rgba(255, 255, 255, 0.05); }
        .input-label {
            position: absolute;
            top: 1rem;
            left: 1rem;
            color: #6b7280;
            pointer-events: none;
            transition: all 0.3s ease;
            background-color: transparent;
            padding: 0 0.25rem;
            font-size: 0.9rem;
        }
        
        .input-field:focus ~ .input-label,
        .input-field:not(:placeholder-shown) ~ .input-label {
            top: -0.75rem;
            left: 0.75rem;
            font-size: 0.75rem;
            color: var(--color-gold);
            background-color: var(--color-void); /* Tapa el borde */
            font-weight: bold;
            letter-spacing: 0.05em;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #020203; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--color-gold); }
        
        /* ANIMACIONES DEL PRELOADER */
        @keyframes pulse-slow {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }
        .animate-pulse-slow { animation: pulse-slow 3s infinite ease-in-out; }

        @keyframes slide-up {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-up { animation: slide-up 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .delay-100 { animation-delay: 0.1s; }

        @keyframes progress-fill {
            0% { width: 0%; }
            40% { width: 30%; }
            80% { width: 70%; }
            100% { width: 100%; }
        }
        .animate-progress-fill { animation: progress-fill 2.5s cubic-bezier(0.22, 1, 0.36, 1) forwards; }


        /* Animación del reflejo metálico */
        @keyframes gold-reflection {
            0% { background-position: -200% center; }
            100% { background-position: 200% center; }
        }

        /* Efecto de Oro Estático con brillo metálico */
        .gold-metal-effect {
            /* CAPA 1: Reflejo blanco traslúcido (arriba) */
            /* CAPA 2: Color Gold sólido de la base (abajo) */
            background-image: 
                linear-gradient(
                    135deg, 
                    transparent 25%, 
                    rgba(255, 255, 255, 0.638) 50%, 
                    transparent 75%
                ),
                linear-gradient(
                    var(--color-gold), 
                    var(--color-gold)
                );
            
            /* El tamaño del fondo debe ser suficiente para que el reflejo sea ancho y suave */
            background-size: 100% 100%;
            
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: inline-block;
            
            /* Mantenemos la palpitación original */
            animation: pulse-slow 3s infinite ease-in-out;
            
            /* Sombra para dar relieve metálico */
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.5));
        }

        /* Bloqueo de scroll principal para modo inmersivo */
        body.admin-mode {
            overflow: hidden !important;
            height: 100vh;
        }

        /* Aseguramos que el panel lateral no genere scroll si no es necesario */
        #view-admin aside nav {
            scrollbar-width: none; /* Firefox */
        }
        #view-admin aside nav::-webkit-scrollbar {
            display: none; /* Chrome/Safari */
        }

        /* Ajuste de precisión para el contenedor Admin */
        #view-admin {
            top: 0 !important; /* Forzamos el inicio en el pixel 0 */
            height: 100vh !important;
            position: fixed; /* Lo sacamos del flujo para que no lo empuje el menú */
            z-index: 40;
        }

        /* Bloqueo total del cuerpo */
        body.admin-mode {
            overflow: hidden !important;
            position: fixed;
            width: 100%;
        }


        /* Ocultar iconos nativos de fecha/hora en Webkit */
        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="time"]::-webkit-calendar-picker-indicator {
            background: transparent;
            bottom: 0; color: transparent; cursor: pointer;
            height: auto; left: 0; position: absolute;
            right: 0; top: 0; width: auto;
        }
        /* Contenedor relativo para que el click funcione en todo el area */
        .input-wrapper { position: relative; }



    </style>
</head>
<body class="flex flex-col min-h-screen font-sans antialiased selection:bg-gold selection:text-black">

    <div id="app-preloader" class="fixed inset-0 z-[9999] bg-void flex flex-col items-center justify-center transition-opacity duration-1000">
        
        <div class="relative w-20 h-20 mb-6 flex items-center justify-center animate-pulse-slow">
            <div class="absolute inset-0 rounded-full border border-gold/20 scale-150 animate-ping opacity-20"></div>
            <div class="absolute inset-0 rounded-full border border-gold/40"></div>
            <i class="fa-solid fa-crown text-4xl text-gold drop-shadow-[0_0_15px_rgba(212,175,55,0.6)]"></i>
        </div>

        <div class="text-center space-y-2 mb-10 overflow-hidden">
            <h1 class="text-2xl font-serif font-bold text-white tracking-[0.2em] animate-slide-up">SENSACIÓN</h1>
            <p class="text-[10px] text-gray-500 uppercase tracking-[0.4em] animate-slide-up delay-100">Boogaloo</p>
        </div>

        <div class="w-48 h-0.5 bg-white/10 rounded-full overflow-hidden relative">
            <div class="absolute top-0 left-0 h-full bg-gradient-to-r from-gold to-neon w-0 animate-progress-fill"></div>
        </div>
    </div>

    <!-- NAVEGACIÓN -->
    <nav class="glass-nav fixed w-full z-50 top-0 h-20 flex items-center justify-between px-6 lg:px-12 transition-all duration-500">
        <a href="#" onclick="Router.go('inicio')" class="flex items-center gap-3 group cursor-pointer select-none">
            <div class="relative w-10 h-10 flex items-center justify-center">
                <div class="absolute inset-0 rounded-full border border-gold/30 group-hover:scale-110 transition-transform duration-500"></div>
                <div class="absolute inset-0 rounded-full border border-white/10 rotate-45 group-hover:rotate-90 transition-transform duration-700"></div>
                <i class="fa-solid fa-crown text-gold text-sm group-hover:text-neon transition-colors"></i>
            </div>
            <div class="flex flex-col">
                <span class="text-xl font-serif font-black text-white tracking-widest leading-none group-hover:text-gold transition-colors duration-300">SENSACIÓN</span>
                <span class="text-[8px] text-gray-500 font-bold uppercase tracking-[0.4em] leading-none ml-0.5">Boogaloo</span>
            </div>
        </a>

        <div class="hidden lg:flex items-center gap-8">
            <div class="flex gap-6 text-sm font-bold uppercase tracking-widest text-gray-400" id="nav-links">
                <button id="nav-inicio" onclick="Router.go('inicio')" class="text-gold border-b-2 border-gold px-2 py-1 transition-all duration-300">Inicio</button>
                <button id="nav-nosotros" onclick="Router.go('nosotros')" class="hover:text-white py-2 transition-all border-b-2">Nosotros</button>
                <button id="nav-clases" onclick="Router.go('clases')" class="hover:text-white py-2 transition-all border-b-2 border-transparent">Clases</button>
                <button id="nav-membresias" onclick="Router.go('membresias')" class="hover:text-white py-2 transition-all border-b-2 border-transparent">Membresías</button>
                <button id="nav-agenda" onclick="Router.go('agenda')" class="hover:text-white py-2 transition-all border-b-2 border-transparent">Agenda</button>
                <button id="nav-alquiler" onclick="Router.go('alquiler')" class="hover:text-white py-2 transition-all border-b-2 border-transparent">Espacios</button>
                <button id="nav-talento" onclick="Router.go('talento')" class="hover:text-white py-2 transition-all border-b-2 border-transparent">Talento</button>
            </div>

            <div class="w-px h-8 bg-white/10"></div>

            <div class="flex items-center gap-4">
                <button onclick="App.toggleCurrency()" class="flex items-center gap-2 px-3 py-1.5 rounded-full border border-white/10 bg-white/5 hover:border-gold transition-all group">
                    <span class="w-1.5 h-1.5 rounded-full bg-gold group-hover:scale-125 transition-transform"></span>
                    <span id="currency-label" class="text-[10px] font-bold text-white group-hover:text-gold">CRC</span>
                </button>

                <button onclick="App.toggleLoginModal()" class="btn-galaxy px-6 py-2.5 rounded-full text-xs shadow-lg hover:shadow-gold/20">
                    PORTAL
                </button>
            </div>
        </div>

        <button class="lg:hidden text-2xl text-gold hover:text-white transition-colors" onclick="App.toggleMobileMenu()">
            <i class="fa-solid fa-bars-staggered"></i>
        </button>
    </nav>

    <div id="mobile-menu" class="hidden fixed inset-0 z-[100] bg-void/95 backdrop-blur-xl flex-col overflow-y-auto transition-all duration-300 opacity-0">
        
        <div class="fixed top-6 right-6 z-50">
            <button onclick="App.toggleMobileMenu()" class="text-white/50 hover:text-gold transition-colors p-2 bg-black/20 rounded-full backdrop-blur-md">
                <i class="fa-solid fa-xmark text-3xl"></i>
            </button>
        </div>

        <div class="fixed inset-0 flex items-center justify-center pointer-events-none z-0">
            <i class="fa-solid fa-crown text-[150px] text-white/5 animate-pulse-slow"></i>
        </div>

        <div class="relative z-10 w-full min-h-screen flex flex-col items-center justify-center py-16">
            
            <div class="flex flex-col items-center gap-1 mb-2">
                <button onclick="Router.go('inicio'); App.toggleMobileMenu()" class="text-4xl text-white hover:text-gold transition-colors leading-tight" style="font-family: 'Playfair Display', serif !important;">Inicio</button>
                <button onclick="Router.go('nosotros'); App.toggleMobileMenu()" class="text-4xl text-white hover:text-gold transition-colors leading-tight" style="font-family: 'Playfair Display', serif !important;">Nosotros</button>
                <button onclick="Router.go('clases'); App.toggleMobileMenu()" class="text-4xl text-white hover:text-gold transition-colors leading-tight" style="font-family: 'Playfair Display', serif !important;">Clases</button>
                
                <button onclick="Router.go('membresias'); App.toggleMobileMenu()" class="text-4xl text-white hover:text-gold transition-colors leading-tight" style="font-family: 'Playfair Display', serif !important;">Membresías</button>
                
                <button onclick="Router.go('agenda'); App.toggleMobileMenu()" class="text-4xl text-white hover:text-gold transition-colors leading-tight" style="font-family: 'Playfair Display', serif !important;">Agenda</button>
                <button onclick="Router.go('alquiler'); App.toggleMobileMenu()" class="text-4xl text-white hover:text-gold transition-colors leading-tight" style="font-family: 'Playfair Display', serif !important;">Espacios</button>
                <button onclick="Router.go('talento'); App.toggleMobileMenu()" class="text-4xl text-white hover:text-gold transition-colors leading-tight" style="font-family: 'Playfair Display', serif !important;">Talento</button>
            </div>

            <div class="mt-2 mb-8">
                <button onclick="App.toggleCurrency()" class="flex items-center gap-2 px-4 py-2 rounded-full border border-white/10 bg-white/5 hover:border-gold transition-colors group">
                    <span class="w-2 h-2 rounded-full bg-gold group-hover:scale-125 transition-transform"></span>
                    <span class="text-xs font-bold text-white uppercase tracking-wider group-hover:text-gold">CRC</span>
                </button>
            </div>

            <button onclick="App.toggleLoginModal(); App.toggleMobileMenu()" class="btn-galaxy px-10 py-4 rounded-full text-xs font-bold shadow-lg shrink-0 tracking-widest uppercase transform hover:scale-105 transition-all text-black">
                PORTAL
            </button>

        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <main id="app-container" class="flex-grow pt-20 relative w-full">

        <!-- 1. VISTA INICIO (HERO VIDEO) -->
        <section id="view-inicio" class="app-view active relative w-full h-[calc(100vh-80px)] flex flex-col items-center justify-center overflow-hidden bg-void">
            
            <div class="absolute inset-0 z-0">
                
                <div class="absolute inset-0 bg-cover bg-center bg-no-repeat transition-all duration-1000 opacity-60" id="hero-bg-image"></div>
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_center,transparent_0%,var(--color-void)_100%)] opacity-80"></div>
            </div>

            <div class="relative z-20 flex flex-col items-center justify-center text-center px-6 w-full max-w-4xl mx-auto">
                
                <h1 id="hero-title-display" class="text-5xl md:text-7xl lg:text-8xl font-serif font-black text-white leading-[1.1] tracking-tight drop-shadow-2xl mb-8 w-full">
                    RITMO FUTURO
                </h1>
                
                <div class="w-20 h-1 bg-gold rounded-full shadow-[0_0_20px_var(--color-gold)] mb-8 opacity-80"></div>

                <p id="hero-desc-display" class="text-gray-200 text-base md:text-xl font-sans font-light max-w-2xl mx-auto mb-12 leading-relaxed opacity-90 drop-shadow-lg">
                    Descripción del sitio...
                </p>

                <div class="flex flex-col sm:flex-row gap-5 justify-center items-center w-full">
                    <button id="hero-btn-primary" class="btn-galaxy px-10 py-4 rounded-full shadow-2xl hover:shadow-gold/50 transform hover:-translate-y-1 transition-all text-xs font-bold tracking-widest min-w-[180px]">
                        ACCIÓN 1
                    </button>
                    <button id="hero-btn-secondary" class="px-10 py-4 rounded-full border border-white/20 hover:border-neon hover:bg-neon/10 hover:text-neon text-white backdrop-blur-sm transition-all text-xs font-bold tracking-widest min-w-[180px]">
                        ACCIÓN 2
                    </button>
                </div>
            </div>
        </section>

        <!-- 2. VISTA NOSOTROS (DARK & PREMIUM) -->
        <section id="view-nosotros" class="app-view px-6 py-24 bg-void relative overflow-hidden">
            
            <div class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none z-0 flex items-center justify-center">
                <h2 id="nos-bg-text" class="text-[18vw] lg:text-[22rem] font-serif font-black text-white/5 whitespace-nowrap absolute top-5 lg:-top-20 left-1/2 -translate-x-1/2 -rotate-6 select-none transition-all duration-500">
                    BOOGALOO
                </h2>
                <div class="absolute top-1/4 right-0 w-[500px] h-[500px] bg-gold/10 rounded-full blur-[120px]"></div>
                <div class="absolute bottom-0 left-10 w-[300px] h-[300px] bg-rose/10 rounded-full blur-[100px]"></div>
            </div>

            <div class="container mx-auto max-w-7xl relative z-10">
                
                <div class="grid lg:grid-cols-2 gap-16 items-start mb-32">
                    
                    <div class="space-y-8 pt-10">
                        <div>
                            <span id="nos-pre" class="text-neon text-xs font-bold uppercase tracking-[0.4em] mb-4 flex items-center gap-3">
                                <span class="w-12 h-[2px] bg-neon"></span> IDENTIDAD
                            </span>
                            <h2 id="nos-tit" class="text-5xl md:text-7xl font-serif font-black text-white leading-[0.9]">
                                RITMO CON <br>PROPÓSITO
                            </h2>
                        </div>

                        <div class="relative">
                            <div class="absolute left-0 top-0 w-1 h-full bg-gradient-to-b from-rose to-transparent"></div>
                            <p id="nosotros-historia-txt" class="pl-8 text-xl text-gray-300 font-light leading-relaxed">
                                Sensación Boogaloo no es solo una academia...
                            </p>
                        </div>

                        <div class="glass-card p-8 bg-white/5 border border-white/10 rounded-br-3xl rounded-tl-3xl relative mt-8 group hover:border-gold/30 transition-colors">
                            <i class="fa-solid fa-quote-right absolute top-4 right-4 text-white/10 text-4xl group-hover:text-gold/20 transition-colors"></i>
                            <p id="nosotros-filosofia-txt" class="text-white font-serif italic text-lg relative z-10">
                                "El bailarín caribeño tiene algo que no se enseña..."
                            </p>
                        </div>
                    </div>

                    <div class="flex flex-col gap-6 w-full max-w-full overflow-hidden"> 
                        <div id="video-container" class="relative w-full aspect-video rounded-2xl overflow-hidden shadow-2xl border border-white/10 bg-black group">
                            <iframe id="main-video-frame" class="w-full h-full object-cover" src="..." ...></iframe>
                            <div class="absolute inset-0 border-2 border-transparent group-hover:border-gold/50 rounded-2xl transition-colors pointer-events-none"></div>
                        </div>

                        <div class="flex gap-4 overflow-x-auto pb-4 custom-scrollbar" id="video-thumbnails">
                            <button class="w-40 aspect-video rounded-lg border-2 border-gold overflow-hidden relative group shrink-0 transition-all transform hover:-translate-y-1" onclick="App.changeVideo('dQw4w9WgXcQ', this)">
                                <img src="https://img.youtube.com/vi/dQw4w9WgXcQ/0.jpg" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity">
                                <div class="absolute inset-0 flex items-center justify-center"><i class="fa-solid fa-play text-white drop-shadow-md"></i></div>
                            </button>
                            <button class="w-40 aspect-video rounded-lg border-2 border-white/10 overflow-hidden relative group shrink-0 transition-all transform hover:-translate-y-1 hover:border-white/50" onclick="App.changeVideo('tgbNymZ7vqY', this)">
                                <img src="https://img.youtube.com/vi/tgbNymZ7vqY/0.jpg" class="w-full h-full object-cover opacity-60 group-hover:opacity-100 transition-opacity">
                                <div class="absolute inset-0 flex items-center justify-center"><i class="fa-solid fa-play text-white/70 group-hover:text-white drop-shadow-md"></i></div>
                            </button>
                            <button class="w-40 aspect-video rounded-lg border-2 border-white/10 overflow-hidden relative group shrink-0 transition-all transform hover:-translate-y-1 hover:border-white/50" onclick="App.changeVideo('dQw4w9WgXcQ', this)">
                                <img src="https://images.unsplash.com/photo-1545959570-a9477eb37265?q=80&w=400" class="w-full h-full object-cover opacity-60 group-hover:opacity-100 transition-opacity">
                                <div class="absolute bottom-0 left-0 w-full p-1 text-[10px] bg-black/60 text-white text-center">Clase Abierta</div>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="mb-32">
                    <div class="text-center mb-12">
                        <h3 class="text-4xl font-serif text-white">Galería <span class="text-neon italic">En Movimiento</span></h3>
                        <div class="w-16 h-1 bg-neon mx-auto mt-4 rounded-full shadow-[0_0_15px_var(--color-neon)]"></div>
                    </div>

                    <div id="galeria-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4 h-[600px] md:h-[500px]">
                        
                        <div class="col-span-1 row-span-2 relative group overflow-hidden rounded-2xl border border-white/5 cursor-pointer">
                            <img src="https://lh3.googleusercontent.com/d/1gohtlhOlFEEdFHHR23fb5jN4c9RcGsAE" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110 group-hover:rotate-1">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex flex-col justify-end p-6">
                                <span class="text-neon text-xs font-bold uppercase">Social Dance</span>
                                <p class="text-white font-serif">Conexión</p>
                            </div>
                        </div>

                        <div class="col-span-2 row-span-1 relative group overflow-hidden rounded-2xl border border-white/5 cursor-pointer">
                            <img src="https://lh3.googleusercontent.com/d/1gohtlhOlFEEdFHHR23fb5jN4c9RcGsAE" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105 filter brightness-90 group-hover:brightness-100">
                            <div class="absolute bottom-4 left-4 bg-black/60 backdrop-blur-md px-4 py-2 rounded-full border border-white/10 opacity-0 group-hover:opacity-100 transition-all translate-y-2 group-hover:translate-y-0">
                                <span class="text-gold text-xs font-bold uppercase">Shows en Vivo</span>
                            </div>
                        </div>

                        <div class="col-span-1 row-span-1 relative group overflow-hidden rounded-2xl border border-white/5 cursor-pointer">
                            <img src="https://lh3.googleusercontent.com/d/1gohtlhOlFEEdFHHR23fb5jN4c9RcGsAE" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">
                        </div>

                        <div class="col-span-1 row-span-1 relative group overflow-hidden rounded-2xl border border-white/5 cursor-pointer">
                            <img src="https://lh3.googleusercontent.com/d/1gohtlhOlFEEdFHHR23fb5jN4c9RcGsAE" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">
                        </div>

                        <div class="col-span-2 row-span-1 relative group overflow-hidden rounded-2xl border border-white/5 cursor-pointer">
                            <img src="https://lh3.googleusercontent.com/d/1gohtlhOlFEEdFHHR23fb5jN4c9RcGsAE" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105 object-center">
                            <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                <div class="w-16 h-16 rounded-full bg-white/10 backdrop-blur-md flex items-center justify-center border border-white/20">
                                    <i class="fa-solid fa-plus text-white text-xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="border-t border-white/10 pt-16">
                    <h3 class="text-center text-4xl font-serif text-white mb-12">Nuestra <span class="text-gold">Trayectoria</span></h3>
                    
                    <div id="premios-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="glass-card p-8 rounded-xl border border-white/5 relative overflow-hidden group hover:border-gold transition-all duration-300 hover:shadow-[0_0_30px_rgba(212,175,55,0.2)] hover:-translate-y-2">
                            <div class="flex justify-between items-start mb-4">
                                <span class="text-4xl font-black text-white group-hover:text-gold transition-colors">2023</span>
                                <i class="fa-solid fa-trophy text-3xl text-white/10 group-hover:text-gold transition-colors duration-500 group-hover:rotate-12"></i>
                            </div>
                            <h4 class="text-lg font-bold text-gray-200 mb-1">Campeones Nacionales</h4>
                            <p class="text-[10px] text-rose font-bold uppercase tracking-widest">Salsa Casino • FECOBADE</p>
                        </div>

                        <div class="glass-card p-8 rounded-xl border border-white/5 relative overflow-hidden group hover:border-neon transition-all duration-300 hover:shadow-[0_0_30px_rgba(3,236,217,0.2)] hover:-translate-y-2">
                            <div class="flex justify-between items-start mb-4">
                                <span class="text-4xl font-black text-white group-hover:text-neon transition-colors">INTL</span>
                                <i class="fa-solid fa-globe text-3xl text-white/10 group-hover:text-neon transition-colors duration-500 group-hover:scale-110"></i>
                            </div>
                            <h4 class="text-lg font-bold text-gray-200 mb-1">Gira Europea</h4>
                            <p class="text-[10px] text-rose font-bold uppercase tracking-widest">Representación CR</p>
                        </div>

                        <div class="glass-card p-8 rounded-xl border border-white/5 relative overflow-hidden group hover:border-gold transition-all duration-300 hover:shadow-[0_0_30px_rgba(212,175,55,0.2)] hover:-translate-y-2">
                            <div class="flex justify-between items-start mb-4">
                                <span class="text-4xl font-black text-white group-hover:text-gold transition-colors">100%</span>
                                <i class="fa-solid fa-certificate text-3xl text-white/10 group-hover:text-gold transition-colors duration-500"></i>
                            </div>
                            <h4 class="text-lg font-bold text-gray-200 mb-1">Certificación</h4>
                            <p class="text-[10px] text-rose font-bold uppercase tracking-widest">Instructores Titulados</p>
                        </div>

                        <div class="glass-card p-8 rounded-xl border border-white/5 relative overflow-hidden group hover:border-neon transition-all duration-300 hover:shadow-[0_0_30px_rgba(3,236,217,0.2)] hover:-translate-y-2">
                            <div class="flex justify-between items-start mb-4">
                                <span class="text-4xl font-black text-white group-hover:text-neon transition-colors">500+</span>
                                <i class="fa-solid fa-users text-3xl text-white/10 group-hover:text-neon transition-colors duration-500"></i>
                            </div>
                            <h4 class="text-lg font-bold text-gray-200 mb-1">Alumnos Graduados</h4>
                            <p class="text-[10px] text-rose font-bold uppercase tracking-widest">Comunidad Activa</p>
                        </div>
                    </div>
                </div>

            </div>
        </section>

        <!-- 3. VISTA CLASES (Cards Oscuras) -->
        <section id="view-clases" class="app-view px-6 py-20 bg-void">
            <div class="container mx-auto max-w-7xl">
                <div class="flex flex-col md:flex-row justify-between items-end mb-16 gap-6">
                    <div>
                        <span class="text-gold text-xs font-bold uppercase tracking-widest mb-2 block">Formación Artística</span>
                        <h2 class="text-5xl font-serif font-bold text-white">Nuestras Clases</h2>
                    </div>
                    <button onclick="App.toggleCurrency()" class="px-6 py-2 border border-white/10 rounded-full text-xs font-bold text-gray-400 hover:text-white hover:border-gold transition-colors" id="btn-currency-page">
                        Ver Precios en USD
                    </button>
                </div>

                <div id="classes-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <!-- Cards Generadas por JS -->
                </div>
            </div>
        </section>

        <section id="view-membresias" class="app-view px-6 py-20 bg-void">
            <div class="container mx-auto max-w-6xl">
                <div class="text-center mb-16">
                    <h2 class="text-4xl md:text-5xl font-serif font-bold text-white mb-4">Membresías</h2>
                    <div class="w-24 h-1 bg-gold mx-auto rounded-full"></div>
                </div>
                <div id="memberships-grid" class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    </div>
            </div>
        </section>

        <!-- 4. VISTA AGENDA (Timeline Vertical) -->
        <section id="view-agenda" class="app-view px-6 py-20 bg-void">
            <div class="container mx-auto max-w-7xl">
                <h2 class="text-5xl font-serif font-bold text-white mb-16 text-center">Agenda Semanal</h2>
                <!-- Grid de Días -->
                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-6" id="agenda-container">
                    <!-- Columnas inyectadas por JS -->
                </div>
            </div>
        </section>

        <!-- 5. VISTA ALQUILER / EVENTOS (Dark Lux) -->
        <section id="view-alquiler" class="app-view px-6 py-20 bg-panel">
            <div class="container mx-auto max-w-6xl">
                <div class="grid lg:grid-cols-2 gap-16 items-center">
                    <div class="order-2 lg:order-1">
                        <span class="text-neon text-xs font-bold uppercase tracking-widest mb-4 block">Creative Hub</span>
                        <h2 class="text-5xl font-serif font-bold text-white mb-8">El Escenario<br>Perfecto</h2>
                        <p class="text-gray-400 mb-10 leading-relaxed text-lg">
                            120m² de piso profesional flotante, espejos panorámicos, climatización y sonido Hi-Fi. El espacio ideal para materializar tu visión.
                        </p>
                        
                        <div class="space-y-4 mb-10">
                            <div class="glass-card p-5 rounded-xl flex items-center gap-5 group cursor-pointer hover:border-gold">
                                <div class="w-12 h-12 rounded-full bg-gold/10 flex items-center justify-center text-gold"><i class="fa-solid fa-champagne-glasses text-xl"></i></div>
                                <div><h4 class="text-white font-bold text-lg">Eventos Privados</h4><p class="text-xs text-gray-500">Bodas boutique, cócteles.</p></div>
                            </div>
                            <div class="glass-card p-5 rounded-xl flex items-center gap-5 group cursor-pointer hover:border-neon">
                                <div class="w-12 h-12 rounded-full bg-neon/10 flex items-center justify-center text-neon"><i class="fa-solid fa-video text-xl"></i></div>
                                <div><h4 class="text-white font-bold text-lg">Producciones</h4><p class="text-xs text-gray-500">Videoclips, fotografía, castings.</p></div>
                            </div>
                        </div>
                        <button onclick="App.openModal('contacto', 'Cotizar Espacio')" class="btn-galaxy px-10 py-3 rounded-full text-xs">Solicitar Cotización</button>
                    </div>
                    
                    <div class="order-1 lg:order-2 grid grid-cols-2 gap-6 h-full relative">
                        <div class="absolute inset-0 bg-gold/5 blur-[100px] rounded-full pointer-events-none"></div>
                        <img src="https://images.unsplash.com/photo-1519671482502-9759101d4561?auto=format&fit=crop&w=400" class="rounded-xl object-cover h-80 w-full relative z-10 transform translate-y-8 shadow-2xl opacity-80 hover:opacity-100 transition-opacity">
                        <img src="https://images.unsplash.com/photo-1545959570-a9477eb37265?auto=format&fit=crop&w=400" class="rounded-xl object-cover h-80 w-full relative z-10 shadow-2xl opacity-80 hover:opacity-100 transition-opacity">
                    </div>
                </div>
            </div>
        </section>

        <!-- 6. VISTA TALENTO / AUDICIONES -->
        <section id="view-talento" class="app-view px-6 py-20 bg-void">
            <div class="container mx-auto max-w-5xl text-center">
                <span class="text-danger text-xs font-bold uppercase tracking-[0.5em] mb-4 block animate-pulse">Reclutamiento Activo</span>
                <h2 class="text-6xl lg:text-8xl font-serif font-black text-white mb-10 leading-none">TEAM<br><span class="text-transparent bg-clip-text bg-gradient-to-b from-white to-gray-800">ELITE</span></h2>
                
                <div class="grid md:grid-cols-3 gap-8 mb-16 text-left">
                    <!-- Cards -->
                    <div class="glass-card p-8 rounded-2xl relative overflow-hidden group hover:border-gold">
                        <i class="fa-solid fa-trophy text-4xl text-gold mb-6 group-hover:scale-110 transition-transform"></i>
                        <h4 class="text-white font-bold text-xl mb-2">Competición</h4>
                        <p class="text-gray-500 text-sm">Circuito Nacional FECOBADE y giras internacionales.</p>
                    </div>
                    <div class="glass-card p-8 rounded-2xl relative overflow-hidden group hover:border-neon">
                        <i class="fa-solid fa-shirt text-4xl text-neon mb-6 group-hover:scale-110 transition-transform"></i>
                        <h4 class="text-white font-bold text-xl mb-2">Imagen Pro</h4>
                        <p class="text-gray-500 text-sm">Diseño de vestuario exclusivo y proyección escénica.</p>
                    </div>
                    <div class="glass-card p-8 rounded-2xl relative overflow-hidden group hover:border-rose">
                        <i class="fa-solid fa-fire text-4xl text-rose mb-6 group-hover:scale-110 transition-transform"></i>
                        <h4 class="text-white font-bold text-xl mb-2">Alto Nivel</h4>
                        <p class="text-gray-500 text-sm">Entrenamiento físico y técnico intensivo de atletas.</p>
                    </div>
                </div>
                
                <button onclick="App.openModal('audicion', 'Aplicar al Team Elite')" class="btn-neon px-12 py-4 rounded-full text-sm font-bold shadow-lg shadow-neon/20 hover:shadow-neon/40">Iniciar Proceso de Audición</button>
            </div>
        </section>

        <!-- 7. PORTAL ALUMNO (Dashboard) -->
        <section id="view-alumno" class="app-view px-6 py-12 bg-panel">
            <div class="container mx-auto max-w-6xl">
                <div class="flex justify-between items-center mb-12 border-b border-white/10 pb-6">
                    <h1 class="text-3xl font-serif font-bold text-white">Hola, <span class="text-neon" id="student-name">Estudiante</span></h1>
                    <button onclick="App.logout()" class="text-xs text-danger border border-danger/30 px-6 py-2 rounded-full hover:bg-danger/10 transition-colors">Salir</button>
                </div>
                <div class="grid md:grid-cols-3 gap-8">
                    <!-- Status Card -->
                    <div class="glass-card p-8 rounded-2xl bg-gradient-to-br from-panel to-black border-gold/30">
                        <p class="text-gray-500 text-[10px] uppercase font-bold mb-2">Clases Disponibles</p>
                        <p class="text-6xl font-serif text-white font-bold">6 <span class="text-lg text-gray-600">/ 8</span></p>
                        <div class="mt-4 w-full bg-gray-800 h-1 rounded-full"><div class="bg-gold w-3/4 h-full shadow-[0_0_10px_#D4AF37]"></div></div>
                        <p class="text-[10px] text-gray-500 mt-4">Renueva: 30 SEP</p>
                    </div>
                    <!-- Acciones -->
                    <button class="glass-card p-8 rounded-2xl flex flex-col items-center justify-center hover:border-neon group" onclick="alert('Scanner activado')">
                        <i class="fa-solid fa-qrcode text-4xl text-gray-600 group-hover:text-neon mb-4 transition-colors"></i>
                        <h3 class="text-white font-bold">Marcar Asistencia</h3>
                    </button>
                    <button class="glass-card p-8 rounded-2xl flex flex-col items-center justify-center hover:border-success group" onclick="App.openModal('pago', 'Reportar Pago')">
                        <i class="fa-solid fa-receipt text-4xl text-gray-600 group-hover:text-success mb-4 transition-colors"></i>
                        <h3 class="text-white font-bold">Historial Pagos</h3>
                    </button>
                </div>
            </div>
        </section>

        <!-- 8. CENTRO DE MANDO (ADMIN CMS TOTAL) -->
        <section id="view-admin" class="app-view hidden w-full h-screen bg-void text-white overflow-hidden pt-0">
            <div class="flex h-full">
                <aside class="w-64 bg-panel border-r border-white/10 flex flex-col hidden md:flex h-full overflow-hidden pt-24">
                    <nav id="admin-nav" class="flex-1 overflow-y-auto pb-6 space-y-1 custom-scrollbar">
                        <button onclick="Admin.switchTab('dash')" id="btn-tab-dash" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium text-gray-400 hover:bg-white/5 transition-all border-l-4 border-transparent">
                            <i class="fa-solid fa-chart-pie w-5"></i> Dashboard
                        </button>
                        <button onclick="Admin.switchTab('web')" id="btn-tab-web" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium text-gray-400 hover:bg-white/5 transition-all border-l-4 border-transparent">
                            <i class="fa-solid fa-desktop w-5"></i> Web Editor
                        </button>
                        <button onclick="Admin.switchTab('nosotros')" id="btn-tab-nosotros" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium text-gray-400 hover:bg-white/5 transition-all border-l-4 border-transparent">
                            <i class="fa-solid fa-users-gear w-5"></i> Nosotros
                        </button>
                        <button onclick="Admin.switchTab('clases')" id="btn-tab-clases" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium text-gray-400 hover:bg-white/5 transition-all border-l-4 border-transparent">
                            <i class="fa-solid fa-person-chalkboard w-5"></i> Clases
                        </button>
                        <button onclick="Admin.switchTab('membresias')" id="btn-tab-membresias" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium text-gray-400 hover:bg-white/5 transition-all border-l-4 border-transparent">
                            <i class="fa-solid fa-id-card w-5"></i> Membresías
                        </button>
                        <button onclick="Admin.switchTab('alumnos')" id="btn-tab-alumnos" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium text-gray-400 hover:bg-white/5 transition-all border-l-4 border-transparent">
                            <i class="fa-solid fa-users w-5"></i> Alumnos
                        </button>
                        <button onclick="Admin.switchTab('espacios')" id="btn-tab-espacios" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium text-gray-400 hover:bg-white/5 transition-all border-l-4 border-transparent">
                            <i class="fa-solid fa-building w-5"></i> Espacios
                        </button> 
                        <button onclick="Admin.switchTab('talento')" id="btn-tab-talento" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium text-gray-400 hover:bg-white/5 transition-all border-l-4 border-transparent">
                            <i class="fa-solid fa-star w-5"></i> Talento
                        </button>
                        <button onclick="Admin.switchTab('finanzas')" id="btn-tab-finanzas" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium text-gray-400 hover:bg-white/5 transition-all border-l-4 border-transparent">
                            <i class="fa-solid fa-coins w-5"></i> Finanzas
                        </button>
                        <button onclick="Admin.switchTab('config')" id="btn-tab-config" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium text-gray-400 hover:bg-white/5 transition-all border-l-4 border-transparent">
                            <i class="fa-solid fa-sliders w-5"></i> Ajustes
                        </button>
                    </nav>
                    <div class="p-4 border-t border-white/10 bg-panel">
                        <button onclick="App.logout()" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-bold text-red-400 hover:bg-red-950/30 rounded-xl transition-all duration-300">
                            <i class="fa-solid fa-power-off"></i> <span>Cerrar Sesión</span>
                        </button>
                    </div>
                </aside>

                <main class="flex-1 overflow-y-auto bg-void p-8 pt-24 relative custom-scrollbar">
                    <div id="admin-tab-dash" class="admin-tab">
                        <div class="flex justify-between items-end mb-8">
                            <div><h1 class="text-3xl font-serif font-bold text-white">Centro de Mando</h1><p class="text-gray-400 text-sm mt-1">Resumen operativo</p></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                            <div class="bg-panel p-6 rounded-2xl border border-white/5 shadow-lg relative overflow-hidden group hover:border-gold/30 transition-colors">
                                <div class="flex justify-between mb-4"><i class="fa-solid fa-users text-blue-400 p-2 bg-blue-950/30 rounded-lg"></i></div>
                                <h3 class="text-3xl font-bold text-white mb-1" id="kpi-alumnos">0</h3>
                                <p class="text-xs text-gray-400 uppercase tracking-wider">Alumnos Activos</p>
                            </div>
                            <div class="bg-panel p-6 rounded-2xl border border-white/5 shadow-lg relative overflow-hidden group hover:border-gold/30 transition-colors">
                                <div class="flex justify-between mb-4"><i class="fa-solid fa-coins text-green-400 p-2 bg-green-950/30 rounded-lg"></i></div>
                                <h3 class="text-3xl font-bold text-white mb-1" id="kpi-ingresos">₡0</h3>
                                <p class="text-xs text-gray-400 uppercase tracking-wider">Ingresos Mes</p>
                            </div>
                            <div class="bg-panel p-6 rounded-2xl border border-white/5 shadow-lg relative overflow-hidden group hover:border-gold/30 transition-colors">
                                <div class="flex justify-between mb-4"><i class="fa-solid fa-id-card text-gold p-2 bg-gold/10 rounded-lg"></i></div>
                                <h3 class="text-3xl font-bold text-white mb-1" id="kpi-membresias">0</h3>
                                <p class="text-xs text-gray-400 uppercase tracking-wider">Planes Activos</p>
                            </div>
                        </div>
                        <div class="bg-panel p-6 rounded-2xl border border-white/5 shadow-lg h-80">
                            <canvas id="chart-finanzas"></canvas>
                        </div>
                    </div>

                    <div id="admin-tab-dash" class="admin-tab"></div>
                    <div id="admin-tab-web" class="admin-tab hidden"></div>
                    <div id="admin-tab-nosotros" class="admin-tab hidden"></div> 
                    <div id="admin-tab-clases" class="admin-tab hidden"></div>                    
                    <div id="admin-tab-agenda" class="admin-tab hidden"></div>
                    <div id="admin-tab-membresias" class="admin-tab hidden"></div>
                    <div id="admin-tab-espacios" class="admin-tab hidden"></div> 
                    <div id="admin-tab-talento" class="admin-tab hidden"></div>
                    <div id="admin-tab-alumnos" class="admin-tab hidden"></div>
                    <div id="admin-tab-finanzas" class="admin-tab hidden"></div>
                    <div id="admin-tab-config" class="admin-tab hidden"></div>

                </main>
            </div>

            <div id="admin-modal" class="fixed inset-0 z-[200] hidden flex items-center justify-center md:items-start md:pt-24 pt-20 px-0 pb-0 md:p-4 transition-all duration-300">
                
                <div class="absolute inset-0 bg-black/95 backdrop-blur-md transition-opacity opacity-0" id="modal-backdrop" onclick="Admin.closeModal()"></div>

                <div id="modal-panel" class="w-full h-full md:h-[571px] md:max-h-[85vh] max-w-lg bg-[#050505] border border-white/10 md:rounded-2xl shadow-2xl transform scale-95 opacity-0 transition-all duration-500 relative z-10 flex flex-col my-auto group">
                    
                    <div class="flex justify-between items-center p-6 pb-4 border-b border-white/5 bg-[#05060b] shrink-0 md:rounded-t-2xl">
                        <div class="text-center w-full relative pr-8"> <h3 class="text-2xl font-serif font-bold text-gold tracking-widest truncate" id="modal-title">TÍTULO</h3>
                            <p class="text-[10px] text-gray-500 uppercase tracking-[0.2em] mt-1" id="modal-subtitle">SUBTÍTULO</p>
                        </div>
                        <button onclick="Admin.closeModal()" class="absolute top-5 right-5 text-gray-500 hover:text-red-500 p-2 bg-black/20 rounded-full md:bg-transparent transition-colors"><i class="fa-solid fa-xmark text-xl"></i></button>
                    </div>

                    <div id="modal-body" class="p-6 md:p-8 overflow-y-auto custom-scrollbar flex-1 bg-[#05060b]">
                        </div>

                    <div class="p-4 border-t border-white/5 bg-[#05060b] shrink-0 flex flex-row gap-3 md:rounded-b-2xl">
                        <button onclick="Admin.closeModal()" class="flex-1 text-xs font-bold text-gray-400 hover:text-white uppercase tracking-wider py-3 border border-white/10 rounded-xl transition-colors order-1">
                            CANCELAR
                        </button>
                        <button id="modal-save-btn" class="flex-[2] bg-gold text-black font-bold py-3 rounded-xl text-xs uppercase tracking-widest hover:bg-white hover:text-black transition-all duration-300 shadow-lg order-2">
                            GUARDAR
                        </button>
                    </div>
                </div>
            </div>

            <button onclick="Admin.toggleMobileSidebar()" class="md:hidden fixed bottom-6 right-6 z-[110] w-12 h-12 bg-gold text-black rounded-full shadow-[0_0_20px_rgba(158,150,52,0.4)] flex items-center justify-center transition-transform active:scale-90 border-none">
                <i class="fa-solid fa-screwdriver-wrench text-black"></i>
            </button>

        </section>

    </main>

    <!-- LOGIN MODAL (FIXED CENTERED & DARK) -->
    <div id="login-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4 bg-void/95 backdrop-blur-xl transition-opacity opacity-0 duration-300">
        <div class="glass-card w-full max-w-sm p-10 rounded-2xl border-t border-white/10 shadow-2xl relative transform scale-95 transition-transform duration-300" id="login-panel">
            <button onclick="App.toggleLoginModal()" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            <div class="text-center mb-10">
                <div class="w-16 h-16 mx-auto mb-4 border border-gold/30 rounded-full flex items-center justify-center shadow-[0_0_15px_rgba(212,175,55,0.2)]">
                    <i class="fa-solid fa-user-astronaut text-2xl text-gold"></i>
                </div>
                <h2 class="text-2xl font-serif font-bold text-white tracking-wide">Acceso Seguro</h2>
            </div>
            <form onsubmit="App.handleLogin(event)" class="space-y-4">
                <div class="input-group">
                    <input type="text" id="login-id" class="input-field" placeholder=" ">
                    <label class="input-label">ID Usuario</label>
                </div>
                <div class="input-group">
                    <input type="password" id="login-pass" class="input-field" placeholder=" ">
                    <label class="input-label">Contraseña</label>
                </div>
                <button type="submit" class="btn-galaxy w-full py-4 rounded-xl font-bold">
                    INGRESAR AL PORTAL
                </button>
            </form>
            <div class="mt-8 text-center pt-6 border-t border-white/5 flex justify-center gap-6 text-[10px] text-gray-500 font-mono">
                <span class="cursor-pointer hover:text-white" onclick="$('#login-id').value='alumno';$('#login-pass').value='1234'">alumno / 1234</span>
                <span class="cursor-pointer hover:text-white" onclick="$('#login-id').value='admin';$('#login-pass').value='admin'">admin / admin</span>
            </div>
        </div>
    </div>

    <!-- MODAL UNIVERSAL -->
    <div id="modal" class="fixed inset-0 z-[200] hidden flex items-center justify-center p-0 md:p-4 transition-all duration-300 opacity-0">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-sm transition-opacity" onclick="App.closeModal()"></div>
        
        <div class="w-full h-full md:h-auto md:max-w-md bg-[#08090B] border-0 md:border border-white/10 md:rounded-2xl relative transform scale-100 md:scale-95 transition-all duration-300 flex flex-col" id="modal-panel">
            
            <div class="p-6 pb-2 shrink-0 flex justify-between items-center bg-[#08090B]">
                <h3 id="uni-modal-title" class="text-2xl font-serif font-bold text-gold text-center w-full">Cargando...</h3>
                <button onclick="App.closeModal()" class="absolute top-6 right-6 text-gray-500 hover:text-white transition-colors z-50"><i class="fa-solid fa-xmark text-2xl"></i></button>
            </div>
            
            <div id="uni-modal-body" class="p-6 pt-4 overflow-y-auto flex-1 custom-scrollbar bg-[#08090B]"></div>
        </div>
    </div>

    <!-- LÓGICA DEL SISTEMA -->
    <script>
        const $ = (s) => document.querySelector(s);

        // =================================================================
        // 1. ADN DEL PROYECTO (DATOS COMPLETOS Y REALISTAS)
        // =================================================================
        const DefaultData = {
            config: {
                colors: { void: '#020203', panel: '#08090B', surface: '#121418', gold: '#D4AF37', neon: '#00F3FF', rose: '#FF2D55', textMain: '#E0E0E0', textMuted: '#9CA3AF' },
                fonts: { heading: 'Cinzel', body: 'Space Grotesk' },
                enableAnimations: true,
                hero: {
                    title: "Sensación Boogaloo",
                    subtitle: "La evolución del baile latino. Técnica de salón, alma caribeña y proyección internacional.",
                    bgImage: "https://lh3.googleusercontent.com/d/1gohtlhOlFEEdFHHR23fb5jN4c9RcGsAE",
                    agendaBg: "https://lh3.googleusercontent.com/d/1F_KYBe4suK060PYvVaRe7t_v80DBvOqe",
                    ctaPrimary: { text: "Explora nuestras Clases", link: "clases" },
                    ctaSecondary: { text: "Audiciones", link: "talento" },
                    cancellationHours: 12 // Horas mínimas para cancelar sin perder el crédito
                },
                
                nosotrosContent: {
                    pretitle: "IDENTIDAD",
                    title: "RITMO CON PROPÓSITO",
                    historia: "Sensación Boogaloo no es solo una academia, es la custodia del sabor limonense. Fusionamos la disciplina académica global con el movimiento innato del Caribe.",
                    cita: "El bailarín caribeño tiene algo que no se enseña en aulas tradicionales: tiene el mar en el movimiento.",
                    autorCita: "Dirección Artística",
                    // Videoteca: ID de Youtube y URL de la imagen miniatura
                    videos: [
                        { id: "16QrU3iQO88", thumb: "https://img.youtube.com/vi/16QrU3iQO88/0.jpg", label: "Video Principal" },
                        { id: "knZqfUOs7dM", thumb: "https://img.youtube.com/vi/knZqfUOs7dM/0.jpg", label: "Clase Abierta" },
                        { id: "VAMooF_U26A", thumb: "https://img.youtube.com/vi/VAMooF_U26A/0.jpg", label: "Clase Abierta" },
                        { id: "8-ziyyXBtqE", thumb: "https://img.youtube.com/vi/8-ziyyXBtqE/0.jpg", label: "Clase Abierta" },
                        { id: "jWFr13BuZz0", thumb: "https://img.youtube.com/vi/jWFr13BuZz0/0.jpg", label: "Clase Abierta" }
                    ],
                    // Galería: 5 Imágenes fijas para el Bento Grid (Orden: Vertical, Horizontal, Cuadro 1, Cuadro 2, Horizontal Abajo)
                    galeria: [
                        "https://lh3.googleusercontent.com/d/1vwxCH0E6MXf11_Yb-hLSEhxbUTAwSEGl", // 1. Vertical Grande
                        "https://lh3.googleusercontent.com/d/1kkSKz8u5ElL-hcuueTx3_AJ2vBWPUTAa", // 2. Horizontal Superior
                        "https://lh3.googleusercontent.com/d/13rphiYQi-ZNEfc1vQ4WxDWTZ0Aey_6dX", // 3. Cuadro Izq
                        "https://lh3.googleusercontent.com/d/1DXGIQ1zKC-I3UEkU3Zh-wlxWOQ-i6enL", // 4. Cuadro Der
                        "https://lh3.googleusercontent.com/d/1IFMpwyFar_dJWhYKuPzzZCU6kXLRPshn", // 
                        "https://lh3.googleusercontent.com/d/1oz1e13XaS8uofbkx8n9JaRP7lDQqxkkP",
                        "https://lh3.googleusercontent.com/d/1fU1B-1_sx54MkRhsL2g8GyGNKsqRUVYX", //
                        "https://lh3.googleusercontent.com/d/1MAwesmJXKfsiEL6hudk6axxniYpBMqiF", // 
                        "https://lh3.googleusercontent.com/d/1zPxdDxA00ITB17AFRD3K4pQoHjuTnqkG", //
                        "https://lh3.googleusercontent.com/d/1BvsvMxdyfeMFmGR3cgwGZ0CBXVe3QCHA" // 
                    ],
                    // Logros: Ahora incluye el icono como dato editable
                    logros: [
                        { id: 1, year: "2023", title: "Campeones Nacionales", sub: "Salsa Casino • FECOBADE", icon: "fa-trophy", color: "gold" },
                        { id: 2, year: "INTL", title: "Gira Europea", sub: "Representación CR", icon: "fa-globe", color: "neon" },
                        { id: 3, year: "100%", title: "Certificación", sub: "Instructores Titulados", icon: "fa-certificate", color: "gold" },
                        { id: 4, year: "500+", title: "Alumnos Graduados", sub: "Comunidad Activa", icon: "fa-users", color: "neon" }
                    ]



                }
            },

            mensajes: [],// { id, studentId, text, reply, date, read }
            reservas: [], 
            sesiones: [],
            clases: [
                { 
                    id: 1, 
                    name: "Salsa Casino",
                    visible: true,
                    level: "Principiante", 
                    // Lunes 7:00 PM
                    schedules: [ {day: 1, time: "19:00"}, {day: 2, time: "19:00"} ], 
                    showSchedule: true,
                    defaultCapacity: 25,
                    img: "https://lh3.googleusercontent.com/d/1gohtlhOlFEEdFHHR23fb5jN4c9RcGsAE",
                    gallery: [
                        "https://lh3.googleusercontent.com/d/1gohtlhOlFEEdFHHR23fb5jN4c9RcGsAE",
                        "https://lh3.googleusercontent.com/d/1VQU7adEJIShExiZSPbKIlh7CPhaZB7XB"
                    ],
                    priceCRC: "25000", priceUSD: "50", showPrice: true,
                    desc: "Domina la rueda de casino, el tiempo y la guía básica.", 
                    details: "* TEMARIO DEL CURSO\n- Paso base y tiempo musical\n- Figuras fundamentales\n- Rueda de Casino" 
                },
                { 
                    id: 2, 
                    name: "Bachata Sensual", 
                    visible: true,
                    level: "Intermedio", 
                    // Miércoles 8:00 PM
                    schedules: [ {day: 3, time: "20:00"} ], 
                    showSchedule: true,
                    defaultCapacity: 20,
                    img: "https://lh3.googleusercontent.com/d/1jmhE89QKKl1KTtOgkczuayRviCrL2RHt",
                    gallery: [
                        "https://lh3.googleusercontent.com/d/1jmhE89QKKl1KTtOgkczuayRviCrL2RHt",
                        "https://lh3.googleusercontent.com/d/1IFMpwyFar_dJWhYKuPzzZCU6kXLRPshn"
                    ],
                    priceCRC: "25000", priceUSD: "50", showPrice: true, 
                    desc: "Técnica de disociación, ondas y conexión en pareja.",
                    details: "* CONTENIDO\n- Ondas corporales\n- Conexión frame\n- Figuras complejas"
                },
                { 
                    id: 3, 
                    name: "Kizomba Fusion",
                    visible: true, 
                    level: "Open Level", 
                    // Jueves 7:00 PM
                    schedules: [ {day: 4, time: "19:00"} ], 
                    showSchedule: true,
                    defaultCapacity: 20,
                    img: "https://lh3.googleusercontent.com/d/1fU1B-1_sx54MkRhsL2g8GyGNKsqRUVYX",
                    gallery: [
                        "https://lh3.googleusercontent.com/d/1fU1B-1_sx54MkRhsL2g8GyGNKsqRUVYX",
                        "https://lh3.googleusercontent.com/d/1MAwesmJXKfsiEL6hudk6axxniYpBMqiF"
                    ],
                    priceCRC: "25000", priceUSD: "50", showPrice: true, 
                    desc: "Musicalidad y conexión suave con influencias modernas.",
                    details: "* APRENDERÁS\n- Pasos básicos\n- Saidas\n- Musicalidad Tarraxinha"
                },
                { 
                    id: 4, 
                    name: "Lady Style",
                    visible: true, 
                    level: "Avanzado", 
                    // Sábado 10:00 AM
                    schedules: [ {day: 6, time: "10:00"} ], 
                    showSchedule: true,
                    defaultCapacity: 15,
                    img: "https://lh3.googleusercontent.com/d/1zPxdDxA00ITB17AFRD3K4pQoHjuTnqkG",
                    gallery: [
                        "https://lh3.googleusercontent.com/d/1zPxdDxA00ITB17AFRD3K4pQoHjuTnqkG",
                        "https://lh3.googleusercontent.com/d/1BvsvMxdyfeMFmGR3cgwGZ0CBXVe3QCHA"
                    ],
                    priceCRC: "25000", priceUSD: "50", showPrice: true, 
                    desc: "Expresión corporal, brazos y técnica de giro para ellas.",
                    details: "* TÉCNICA\n- Brazos y manos\n- Giros múltiples\n- Actitud escénica"
                }
            ],

            membresias: [
                { 
                    id: 1, 
                    name: "Plan Semestral", 
                    priceCRC: "35000", 
                    priceUSD: "70", 
                    weeklyLimit: 7,
                    summary: "- Acceso Ilimitado\n- Matrícula Gratis\n- Descuento en Eventos",
                    details: "* BENEFICIOS EXCLUSIVOS\n- Acceso a todas las sedes\n- Congelamiento por 15 días\n\n* INCLUYE\n- Camiseta Oficial\n- Carnet Digital",
                    popular: true,
                    legal: "Pago único anticipado. No reembolsable."
                },
                { 
                    id: 2, 
                    name: "Tiquetera 8", 
                    priceCRC: "28000", 
                    priceUSD: "55", 
                    weeklyLimit: 5,
                    summary: "- 8 Clases al mes\n- Vence en 45 días\n- Transferible",
                    details: "* CONDICIONES\n- Válido para cualquier estilo\n- Se puede compartir con un amigo\n- Requiere reservación previa",
                    popular: false,
                    legal: "Vigencia estricta de 45 días."
                },
                { 
                    id: 3, 
                    name: "Full Pass Pareja", 
                    priceCRC: "60000", 
                    priceUSD: "110", 
                    weeklyLimit: 4,
                    summary: "- 2 Personas\n- Acceso Total\n- Sin Matrícula",
                    details: "* PARA DOS PERSONAS\n- Deben inscribirse juntos\n- Acceso ilimitado para ambos\n- Descuento en talleres internacionales",
                    popular: false,
                    legal: "Precio por pareja mensual."
                }
            ],
            alumnos: [
                // USUARIO 1: EL PROFESOR (ADMIN)
                { 
                    id: "admin",          // Cédula (Nuevo Usuario)
                    name: "Georgzua Director",
                    pass: "admin",            // Contraseña
                    role: "admin",            // Rol crítico
                    phone: "8888-8888",       // Para icono WhatsApp
                    email: "director@sensacion.cr", // Para icono Sobre
                    birthDate: "1999-01-01",  // Para icono Pastel
                    joinDate: "2020-01-01",
                    planId: null,             // Admin no tiene plan
                    extraCredits: 0, 
                    active: true 
                },
                
                // USUARIO 2: EL ESTUDIANTE
                { 
                    id: "alumno",          // Cédula
                    name: "Luis Sibaja Alumno",
                    pass: "1234", 
                    role: "student", 
                    phone: "7086-6080",
                    email: "luis18sibaja@gmail.com",
                    birthDate: "1995-07-18", 
                    joinDate: "2023-09-01",
                    planId: 1,                // Plan Semestral
                    extraCredits: 0, 
                    active: true 
                }
            ],
            
            espacios: [
                { id: 1, name: "Salón Principal", capacity: "60", desc: "120m², Piso flotante, Espejos panorámicos, Aire Acondicionado.", img: "https://images.unsplash.com/photo-1519671482502-9759101d4561?auto=format&fit=crop&w=600" },
                { id: 2, name: "Studio B", capacity: "15", desc: "Ideal para clases privadas, grabaciones y ensayos de grupos pequeños.", img: "https://images.unsplash.com/photo-1571216682227-e4bb00b3d87b?auto=format&fit=crop&w=600" }
            ],
            talento: [
                { id: 1, name: "Georgzua", role: "Director Artístico", bio: "Campeón Nacional de Salsa 2022. 15 años de experiencia formando bailarines.", img: "https://images.unsplash.com/photo-1542596594-649edbc13630?auto=format&fit=crop&w=600" },
                { id: 2, name: "Dania", role: "Instructora Senior", bio: "Especialista en Bachata Sensual y Lady Style. Coreógrafa internacional.", img: "https://images.unsplash.com/photo-1494790108377-be9c29b29330?auto=format&fit=crop&w=600" },
                { id: 3, name: "Javier", role: "Instructor Kizomba", bio: "Pionero del Urban Kizz en la región.", img: "https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?auto=format&fit=crop&w=600" }
            ],
            finanzas: [
                { id: 1, concept: "Pago Mensualidad (Ana S.)", type: "ingreso", amount: "35000" },
                { id: 2, concept: "Clase Suelta (Visita)", type: "ingreso", amount: "5000" },
                { id: 3, concept: "Pago Alquiler Local", type: "gasto", amount: "-450000" },
                { id: 4, concept: "Tiquetera (Carlos V.)", type: "ingreso", amount: "28000" },
                { id: 5, concept: "Mantenimiento A/C", type: "gasto", amount: "-25000" }
            ]
        };
        // =================================================================
        // 2. GESTOR DE DATOS (DATA MANAGER - CON PERSISTENCIA)
        // =================================================================
        
        const DataManager = {
            KEY: 'SB_DATA_V2',
            state: null, // Estado interno explícito

            init() {
                // AL REFRESCAR: Ignoramos la memoria guardada y cargamos siempre los datos de fábrica
                sessionStorage.clear(); 
                this.state = JSON.parse(JSON.stringify(DefaultData));
                window.Store = this.state; 
                this.applyStyles();
            },

            get() {
                // Protección contra llamadas antes de init
                if (!this.state) this.init();
                return this.state; 
            },

            save(newState) {
                this.state = newState;
                sessionStorage.setItem(this.KEY, JSON.stringify(this.state));
                this.applyStyles();
                // Si App existe, renderizamos. Si no, esperamos.
                if (typeof App !== 'undefined' && App.renderAll) App.renderAll();
            },

            applyStyles() {
                if (!this.state || !this.state.config) return;
                const c = this.state.config.colors;
                const root = document.documentElement;
                root.style.setProperty('--color-void', c.void);
                root.style.setProperty('--color-panel', c.panel);
                root.style.setProperty('--color-surface', c.surface);
                root.style.setProperty('--color-gold', c.gold);
                root.style.setProperty('--color-neon', c.neon);
                root.style.setProperty('--color-rose', c.rose);
                root.style.setProperty('--color-text-main', c.textMain);
                root.style.setProperty('--color-text-muted', c.textMuted);
            }
        };

        // =================================================================
        // 3. APP PRINCIPAL (PUBLIC VIEW)
        // =================================================================
        const App = {
            currentRole: null,

            // Archivo: IndexV5.html (DENTRO DE App.init)
            init() {
                DataManager.init();
                
                const savedRole = sessionStorage.getItem('app_role');
                if (savedRole) {
                    this.currentRole = savedRole;
                }
                
                // 1. Renderizado de Componentes Públicos
                this.renderPublic();
                this.renderNosotros();
                this.renderAgenda(); // <--- NUEVO: Carga la agenda semanal en la web pública

                // 2. Lógica de Navegación Inicial Inteligente
                let startView = 'inicio';

                if (this.currentRole === 'admin') {
                    startView = 'admin';
                } 
                else if (this.currentRole === 'alumno') {
                    startView = 'alumno';
                    setTimeout(() => this.renderStudentPortal(), 100); // <--- NUEVO: Carga los datos privados del alumno
                }

                // 3. Ejecutar Navegación
                Router.go(startView);
            },

            toggleMobileMenu() { 
                $('#mobile-menu').classList.toggle('hidden'); 
                $('#mobile-menu').classList.toggle('opacity-0'); 
            },

            
            toggleCurrency() { 
                const b=$('#currency-label'); 
                const isCRC = b.innerText === 'CRC';
                b.innerText = isCRC ? 'USD' : 'CRC';
                
                // Busca los elementos con la nueva clase 'currency-dynamic'
                document.querySelectorAll('.currency-dynamic').forEach(el => {
                    // Si estamos en CRC, muestra el precio en Dólares (dataset.usd)
                    // Si estamos en USD, muestra el precio en Colones (dataset.crc)
                    // (La lógica es inversa al botón: si el botón dice CRC, estoy viendo Colones, al hacer click paso a USD)
                    
                    const price = isCRC ? el.dataset.usd : el.dataset.crc;
                    const symbol = isCRC ? '$' : '₡';
                    
                    // Evita mostrar "NaN" si no hay precio definido
                    const finalPrice = price ? parseInt(price).toLocaleString() : '0';
                    el.innerText = `${symbol}${finalPrice}`;
                });
            },

            toggleLoginModal() {
                // Si ya hay sesión, vamos directo sin abrir modal
                if (this.currentRole) {
                    Router.go(this.currentRole);
                    return;
                }
                const modal = $('#login-modal');
                if (modal.classList.contains('hidden')) {
                    modal.classList.remove('hidden');
                    setTimeout(() => modal.classList.remove('opacity-0'), 10);
                } else {
                    modal.classList.add('opacity-0');
                    setTimeout(() => modal.classList.add('hidden'), 300);
                }
            },

            handleLogin(event) { 
                event.preventDefault(); 
                const u = $('#login-id').value; 
                const p = $('#login-pass').value;
                
                const d = DataManager.get();
                // BÚSQUEDA REAL EN LA BASE DE DATOS LOCAL
                const user = d.alumnos.find(a => a.id === u && a.pass === p);

                if (user) {
                    // SI EXISTE EL USUARIO Y LA CONTRASEÑA COINCIDE
                    App.currentRole = user.role; // Puede ser 'admin' o 'student'
                    
                    // Si es admin o teacher, van al panel administrativo
                    if (user.role === 'admin' || user.role === 'teacher') {
                        App.currentRole = 'admin'; 
                    } else {
                        App.currentRole = 'alumno';
                    }
                    
                    // Guardamos el ID del usuario actual para saber quién está logueado
                    sessionStorage.setItem('current_user_id', user.id);
                    
                    App.finalizeLogin();
                } else { 
                    Swal.fire({
                        icon: 'error',
                        title: 'Error de Acceso',
                        text: 'Credenciales incorrectas',
                        background: '#08090B',
                        color: '#E0E0E0',
                        confirmButtonColor: '#9e9634'
                    });
                }
            },

            finalizeLogin() {
                // Primero cerramos el modal
                const modal = $('#login-modal');
                modal.classList.add('opacity-0');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    // Limpiamos campos
                    $('#login-id').value = '';
                    $('#login-pass').value = '';
                    
                    // --- CORRECCIÓN CLAVE: INICIAR EL PANEL ---
                    if (App.currentRole === 'alumno') {
                        App.renderStudentPortal(); // <--- ESTA LÍNEA FALTABA
                    }
                    // ------------------------------------------

                    // Navegamos a la vista correspondiente
                    Router.go(App.currentRole); 
                }, 300);
            },
            
            logout() { 
                this.currentRole = null; 
                sessionStorage.removeItem('app_role');
                document.body.classList.remove('admin-mode'); // Liberamos el scroll
                Router.go('inicio');
                this.toggleLoginModal();
            },


            // --- PEGAR DENTRO DE APP (Reemplaza la anterior) ---
            renderPublic() {
                const h = Store.config.hero;
                
                // 1. Textos
                const titleEl = document.getElementById('hero-title-display');
                if(titleEl) {
                    // Mantenemos tu efecto de palabras doradas si hay más de 1 palabra
                    const words = h.title.split(' ');
                    if (words.length >= 2) {
                        words[1] = `<span class="gold-metal-effect">${words[1]}</span>`;
                        titleEl.innerHTML = words.join(' ');
                    } else {
                        titleEl.innerText = h.title;
                    }
                }
                
                const subEl = document.getElementById('hero-desc-display');
                if(subEl) subEl.innerText = h.subtitle;

                // 2. IMAGEN DE FONDO (ESTO ES LO QUE FALTABA)
                const bgEl = document.getElementById('hero-bg-image');
                if(bgEl && h.bgImage) {
                    // Forzamos el cambio de imagen via CSS inline
                    bgEl.style.backgroundImage = `url('${h.bgImage}')`;
                    bgEl.style.opacity = "0.6"; // Aseguramos visibilidad
                }

                // 3. Botones (Actualizar textos y links)
                const btn1 = document.getElementById('hero-btn-primary');
                if(btn1) {
                    btn1.innerText = h.ctaPrimary.text;
                    btn1.onclick = () => Router.go(h.ctaPrimary.link);
                }
                
                const btn2 = document.getElementById('hero-btn-secondary');
                if(btn2) {
                    btn2.innerText = h.ctaSecondary.text;
                    btn2.onclick = () => Router.go(h.ctaSecondary.link);
                }
                
                
                // 4. Clases (Grid) - Renderizado Dinámico 2.0
                const classesGrid = document.getElementById('classes-grid');
                
                // FILTRO: Solo visibles
                const clasesData = (DataManager.get().clases || []).filter(c => c.visible !== false);
                const animEnabled = DataManager.get().config.enableAnimations;
                
                if(classesGrid) {
                    if (clasesData.length === 0) {
                        classesGrid.innerHTML = `<div class="col-span-full text-center text-gray-500 py-10">No hay clases activas en este momento.</div>`;
                    } else {
                        classesGrid.innerHTML = clasesData.map(c => `
                            <div class="glass-card rounded-xl overflow-hidden group border border-white/5 hover:border-gold/50 transition-all duration-500 flex flex-col h-full">
                               
                                <div class="h-56 relative overflow-hidden bg-black">
                                    <div class="flex w-full h-full transition-transform duration-1000" 
                                         style="width:${(c.gallery||[c.img]).length}00%; 
                                         ${animEnabled ? `animation: slideX ${(c.gallery||[c.img]).length * 3}s infinite alternate ease-in-out;` : ''}">
                                        ${(c.gallery || [c.img]).map(img => `<img src="${img}" class="w-full h-full object-cover filter brightness-75 group-hover:brightness-100">`).join('')}
                                    </div>
                                    <style> @keyframes slideX { 0% { transform: translateX(0); } 100% { transform: translateX(-${(c.gallery||[c.img]).length > 1 ? ((c.gallery||[c.img]).length - 1) * (100 / (c.gallery||[c.img]).length) : 0}%); } } </style>
                                    
                                    <div class="absolute inset-0 bg-gradient-to-t from-panel via-transparent to-transparent opacity-90"></div>
                                    
                                    <span class="absolute top-3 right-3 px-3 py-1 rounded-full text-[10px] uppercase font-black border z-10 backdrop-blur-md shadow-xl
                                        ${c.level.includes('Principiante') ? 'bg-emerald-950/80 text-emerald-400 border-emerald-500/50' : 
                                          c.level.includes('Intermedio') ? 'bg-amber-950/80 text-amber-400 border-amber-500/50' : 
                                          c.level.includes('Avanzado') ? 'bg-rose-950/80 text-rose-400 border-rose-500/50' :
                                          'bg-blue-950/80 text-blue-400 border-blue-500/50'}">
                                        ${c.level}
                                    </span>
                                </div>

                                <div class="p-6 flex-1 flex flex-col relative overflow-hidden">
                                    
                                    
                                    <div class="mb-auto z-10">
                                        <div class="flex justify-between items-start mb-2 gap-2">
                                            <h3 class="text-2xl font-serif font-bold text-white group-hover:text-gold transition-colors leading-tight">${c.name}</h3>
                                            
                                            ${c.showPrice ? `
                                            <span class="text-xs font-mono font-bold text-gold bg-gold/10 px-3 py-1.5 rounded-lg border border-gold/20 whitespace-nowrap currency-dynamic" 
                                                  data-crc="${c.priceCRC || 0}" 
                                                  data-usd="${c.priceUSD || 0}">
                                                ₡${parseInt(c.priceCRC || 0).toLocaleString()}
                                            </span>` : ''}

                                        </div>

                                        ${c.showSchedule !== false ? `
                                        <div class="flex flex-col gap-1 mb-4 text-xs font-mono text-gold/80 border-b border-white/5 pb-3">
                                            <div class="flex items-center gap-2">
                                                <i class="fa-regular fa-clock text-gold"></i>
                                                <span class="text-gray-300">
                                                    ${(c.schedules && c.schedules.length > 0) 
                                                        ? c.schedules.map(s => {
                                                            const days = ["Dom","Lun","Mar","Mié","Jue","Vie","Sáb"];
                                                            return `<span class="text-white font-bold">${days[s.day]}</span> ${s.time}`;
                                                          }).join('<span class="mx-2 text-white/20">|</span>')
                                                        : (c.schedule || 'Horario por definir')}
                                                </span>
                                            </div>
                                        </div>` : '<div class="mb-4"></div>'}
                                        
                                        <p class="text-sm text-gray-400 leading-relaxed font-light line-clamp-3">${c.desc}</p>
                                    </div>
                                    
                                    <button onclick="App.openClassDetails(${c.id})" class="btn-galaxy w-full py-3 rounded-full text-[10px] font-bold tracking-[0.25em] mt-6 shadow-lg z-10 hover:scale-105 transition-transform">
                                        DESCUBRIR MÁS
                                    </button>
                                    
                                    <div class="absolute -bottom-10 -right-10 w-32 h-32 bg-gold/5 rounded-full blur-2xl group-hover:bg-gold/10 transition-colors"></div>
                                </div>


                            </div>`).join('');
                    }
                }

                // 5. Membresías (Renderizado Dinámico Luxury con Resumen Inteligente)
                const membGrid = document.getElementById('memberships-grid');
                const membData = DataManager.get().membresias || [];
                
                // Helper Nuevo: Formatea el resumen respetando *, - y texto normal
                const formatSummary = (text) => {
                    if(!text) return '';
                    return text.split('\n').map(line => {
                        const l = line.trim();
                        if(!l) return ''; // Ignorar líneas vacías
                        
                        // Caso 1: Título (*)
                        if(l.startsWith('*')) {
                            return `<h4 class="text-gold text-[10px] font-bold uppercase tracking-widest mt-3 mb-1 border-l-2 border-gold pl-2">${l.substring(1)}</h4>`;
                        }
                        // Caso 2: Lista (-)
                        if(l.startsWith('-')) {
                            return `<div class="flex items-start gap-3 text-sm text-gray-300 font-light mb-1"><i class="fa-solid fa-check text-gold mt-1 text-[10px] shrink-0"></i> <span>${l.substring(1)}</span></div>`;
                        }
                        // Caso 3: Texto Normal (Prosa)
                        return `<p class="text-xs text-gray-400 font-light mb-2 leading-relaxed">${l}</p>`;
                    }).join('');
                };
                
                if(membGrid) {
                    if (membData.length === 0) {
                        membGrid.innerHTML = `<div class="col-span-full text-center text-gray-500 py-10">No hay planes activos.</div>`;
                    } else {
                        membGrid.innerHTML = membData.map(m => {
                            // Lógica Visual "Popular"
                            const isPop = m.popular;
                            // AJUSTE: Fondo unificado bg-panel para todas
                            const scaleClass = isPop ? 'scale-105 z-10 border-gold shadow-[0_0_40px_rgba(212,175,55,0.15)] bg-panel' : 'border-white/5 hover:border-gold/30 bg-panel hover:-translate-y-2';
                            const titleColor = isPop ? 'text-gold' : 'text-white';
                            const badge = isPop ? `<div class="absolute -top-4 left-1/2 -translate-x-1/2 bg-gold text-black text-[10px] font-bold uppercase tracking-[0.2em] px-6 py-1.5 rounded-full shadow-lg z-20">Más Popular</div>` : '';

                            return `
                                <div class="glass-card p-8 rounded-2xl border ${scaleClass} relative flex flex-col transition-all duration-500 group h-full">
                                    ${badge}
                                    
                                    <div class="text-center mb-6 border-b border-white/5 pb-6 relative">
                                        <h3 class="text-xl font-serif font-bold ${titleColor} mb-2 uppercase tracking-widest">${m.name}</h3>
                                        <div class="flex justify-center items-baseline gap-1 text-white">
                                            <span class="text-4xl font-bold currency-dynamic font-sans tracking-tight" 
                                                  data-crc="${m.priceCRC}" 
                                                  data-usd="${m.priceUSD}">
                                                ₡${parseInt(m.priceCRC).toLocaleString()}
                                            </span>
                                            <span class="text-xs text-gray-500 font-normal uppercase tracking-wider">/ mes</span>
                                        </div>
                                    </div>
                                    
                                    <div class="space-y-1 mb-8 flex-1">
                                        ${formatSummary(m.summary)}
                                    </div>
                                    
                                    <div class="mt-auto flex flex-col gap-2">
                                        <button onclick="App.openMembershipDetails(${m.id})" class="btn-galaxy w-full py-4 rounded-lg font-bold text-[10px] uppercase tracking-[0.2em] shadow-lg hover:scale-105 transition-transform">
                                            EXPLORAR BENEFICIOS
                                        </button>
                                        <button onclick="App.openSubscriptionModal(${m.id}, '${m.name}')" class="w-full py-3 rounded-lg font-bold text-[10px] uppercase tracking-[0.2em] border border-white/10 hover:bg-white hover:text-black transition-colors text-white">
                                            SUSCRIBIRSE AHORA
                                        </button>
                                        ${m.legal ? `<p class="text-[9px] text-gray-600 text-center mt-4 italic">${m.legal}</p>` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                }



            },
            
        
            // --- PEGAR DENTRO DE APP (Reemplaza la función anterior) ---
            renderNosotros() {
                const data = DataManager.get().config.nosotrosContent;
                if (!data) return;

                // 1. FILTRO INDUSTRIAL DE URLS (La solución definitiva)
                const getCleanId = (url) => {
                    if (!url) return "";
                    // Esta fórmula matemática extrae el ID exacto de cualquier tipo de link de YouTube
                    const match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/);
                    return (match && match[2].length === 11) ? match[2] : url;
                };

                // 1. Textos
                const setHtml = (id, v) => { const e=document.getElementById(id); if(e) e.innerHTML=v; };
                const setText = (id, v) => { const e=document.getElementById(id); if(e) e.innerText=v; };

                setHtml('nos-pre', `<span class="w-12 h-[2px] bg-neon"></span> ${data.pretitle || 'IDENTIDAD'}`);
                setHtml('nos-title', data.title);
                setText('nosotros-historia-txt', data.historia);
                setText('nosotros-filosofia-txt', `"${data.cita}"`);
                setText('nos-bg-text', data.bgText || 'BOOGALOO');

                // 3. VIDEOTECA (Miniaturas)
                const vidCont = document.getElementById('video-thumbnails');
                if(vidCont && data.videos) {
                    vidCont.innerHTML = data.videos.map((v, i) => {
                        const cleanId = getCleanId(v.id); 
                        const thumb = cleanId ? `https://img.youtube.com/vi/${cleanId}/0.jpg` : '';
                        
                        // Pasamos el ID LIMPIO a la función de cambio
                        return `<button class="w-40 aspect-video rounded-lg border-2 ${i===0?'border-gold':'border-white/10'} overflow-hidden relative group shrink-0 transition-all transform hover:-translate-y-1" onclick="App.changeVideo('${cleanId}', this)">
                            <img src="${thumb}" class="w-full h-full object-cover ${i===0?'opacity-100':'opacity-60'} group-hover:opacity-100 transition-opacity">
                            <div class="absolute inset-0 flex items-center justify-center"><i class="fa-solid fa-play text-white drop-shadow-md"></i></div>
                            <div class="absolute bottom-0 left-0 w-full p-1 text-[10px] bg-black/60 text-white text-center truncate">${v.label}</div>
                        </button>`;
                    }).join('');
                    
                    // 4. VIDEO PRINCIPAL (Carga Inicial Limpia)
                    const container = document.getElementById('video-container'); // Usamos el contenedor, no el iframe directo
                    if(container && data.videos.length > 0) {
                        const firstId = getCleanId(data.videos[0].id);
                        if(firstId) {
                            // Inyectamos HTML limpio desde el principio
                            
                            container.innerHTML = `
                                <iframe id="main-video-frame" class="absolute top-0 left-0 w-full h-full" 
                                    src="https://www.youtube.com/embed/${firstId}?enablejsapi=1&rel=0" 
                                    frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
                                </iframe>
                                <div class="absolute inset-0 border-2 border-transparent group-hover:border-gold/50 rounded-2xl transition-colors pointer-events-none"></div>
                            `;
                        }
                    }
                }

                // 3. GALERÍA INTELIGENTE (Sin huecos negros + Lightbox)
                const galeriaGrid = document.getElementById('galeria-grid');
                if(galeriaGrid && data.galeria) {
                    // Grid denso para rellenar
                    galeriaGrid.className = "grid grid-cols-2 md:grid-cols-4 gap-4 auto-rows-[220px] grid-flow-dense";
                    const total = data.galeria.length;

                    galeriaGrid.innerHTML = data.galeria.map((img, i) => {
                        // LÓGICA ANTI-HUECOS:
                        // Si estamos en los últimos 2 elementos, forzamos tamaño 1x1 para tapar agujeros.
                        const isEnd = i >= total - 2; 
                        
                        let clase = "col-span-1 row-span-1"; // Normal
                        
                        if (!isEnd) {
                            if (i % 8 === 0) clase = "col-span-2 row-span-2";      // Gigante
                            else if (i % 8 === 4) clase = "col-span-2 row-span-1"; // Panorámica
                            else if (i % 8 === 5) clase = "col-span-1 row-span-2"; // Vertical
                        }

                        return `
                        <div class="${clase} relative group overflow-hidden rounded-xl border border-white/5 cursor-pointer" onclick="App.openLightbox(${i})">
                            <img src="${img}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110 opacity-90 group-hover:opacity-100">
                            <div class="absolute inset-0 bg-black/20 group-hover:bg-transparent transition-colors"></div>
                            <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                                <i class="fa-solid fa-expand text-white drop-shadow-lg text-2xl"></i>
                            </div>
                        </div>`;
                    }).join('');
                }

                // 4. Logros
                const logGrid = document.getElementById('premios-grid');
                if(logGrid && data.logros) {
                    logGrid.innerHTML = data.logros.map(l => `
                        <div class="glass-card p-8 rounded-xl border border-white/5 relative group hover:border-gold/50 transition-all hover:-translate-y-2">
                            <div class="absolute top-4 right-4 opacity-20"><i class="fa-solid ${l.icon} text-5xl text-gold"></i></div>
                            <span class="text-3xl font-black text-white block mb-2 text-gold">${l.year}</span>
                            <h4 class="text-lg font-bold text-gray-200">${l.title}</h4>
                            <p class="text-[10px] text-rose font-bold uppercase tracking-widest mt-1">${l.sub}</p>
                        </div>
                    `).join('');
                }

                // 5. INYECCIÓN DEL VISOR (LIGHTBOX)
                if(!document.getElementById('app-lightbox')) {
                    document.body.insertAdjacentHTML('beforeend', `
                        <div id="app-lightbox" class="fixed inset-0 z-[200] bg-black/95 backdrop-blur-xl hidden flex items-center justify-center opacity-0 transition-opacity duration-300">
                            <button onclick="App.closeLightbox()" class="absolute top-6 right-6 text-white/50 hover:text-white text-4xl z-50"><i class="fa-solid fa-xmark"></i></button>
                            
                            <button onclick="App.slide(-1)" class="absolute left-4 text-white/50 hover:text-gold text-4xl p-4 z-50"><i class="fa-solid fa-chevron-left"></i></button>
                            <button onclick="App.slide(1)" class="absolute right-4 text-white/50 hover:text-gold text-4xl p-4 z-50"><i class="fa-solid fa-chevron-right"></i></button>
                            
                            <img id="lb-img" src="" class="max-h-[85vh] max-w-[90vw] object-contain rounded-lg shadow-[0_0_50px_rgba(0,0,0,0.5)] transform scale-95 transition-transform duration-300">
                            <p id="lb-count" class="absolute bottom-6 text-xs text-gray-500 font-mono tracking-widest">1 / 1</p>
                        </div>
                    `);
                }



            },


            changeVideo(rawInput, btnElement) {
                const container = document.getElementById('video-container');
                if (!container) return;

                // 1. FILTRO INDUSTRIAL (Repetimos la lógica para seguridad total)
                const getCleanId = (url) => {
                    if (!url) return "";
                    const match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/);
                    return (match && match[2].length === 11) ? match[2] : url;
                };

                const cleanId = getCleanId(rawInput); // Obtenemos el ID puro (ej: DV4O3xjWnRc)

                // 2. HARD RESET: Borrar y Crear
                // Esto es vital. Al destruir el iframe viejo, matamos cualquier error previo.
                container.innerHTML = `
                    <iframe id="main-video-frame" class="w-full h-full object-cover" 
                        src="https://www.youtube.com/embed/${cleanId}?enablejsapi=1&autoplay=1&rel=0" 
                        frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen>
                    </iframe>
                    <div class="absolute inset-0 border-2 border-transparent group-hover:border-gold/50 rounded-2xl transition-colors pointer-events-none"></div>
                `;

                // 3. ESTILOS VISUALES
                document.querySelectorAll('#video-thumbnails button').forEach(b => {
                    b.classList.remove('border-gold');
                    b.classList.add('border-white/10');
                    const img = b.querySelector('img');
                    if(img) { img.classList.remove('opacity-100'); img.classList.add('opacity-60'); }
                });

                if(btnElement) {
                    btnElement.classList.remove('border-white/10');
                    btnElement.classList.add('border-gold');
                    const img = btnElement.querySelector('img');
                    if(img) { img.classList.remove('opacity-60'); img.classList.add('opacity-100'); }
                }
            },

            // --- FUNCIONES DEL LIGHTBOX (Pegar dentro de App) ---
            
            lightboxIdx: 0,

            openLightbox(index) {
                const gallery = DataManager.get().config.nosotrosContent.galeria;
                if(!gallery || gallery.length === 0) return;
                
                this.lightboxIdx = index;
                this.updateLightbox();
                
                const lb = document.getElementById('app-lightbox');
                lb.classList.remove('hidden');
                // Pequeño delay para la animación de opacidad
                setTimeout(() => {
                    lb.classList.remove('opacity-0');
                    document.getElementById('lb-img').classList.remove('scale-95');
                    document.getElementById('lb-img').classList.add('scale-100');
                }, 10);
                document.body.style.overflow = 'hidden'; // Bloquear scroll
            },

            closeLightbox() {
                const lb = document.getElementById('app-lightbox');
                lb.classList.add('opacity-0');
                document.getElementById('lb-img').classList.remove('scale-100');
                document.getElementById('lb-img').classList.add('scale-95');
                
                setTimeout(() => {
                    lb.classList.add('hidden');
                    document.body.style.overflow = ''; // Liberar scroll
                }, 300);
            },

            slide(dir) {
                const gallery = DataManager.get().config.nosotrosContent.galeria;
                // Matemática para loop infinito (si llega al final vuelve al inicio)
                this.lightboxIdx = (this.lightboxIdx + dir + gallery.length) % gallery.length;
                
                // Efecto visual rápido de cambio
                const img = document.getElementById('lb-img');
                img.style.opacity = '0.5';
                setTimeout(() => {
                    this.updateLightbox();
                    img.style.opacity = '1';
                }, 150);
            },

            updateLightbox() {
                const gallery = DataManager.get().config.nosotrosContent.galeria;
                const imgUrl = gallery[this.lightboxIdx];
                document.getElementById('lb-img').src = imgUrl;
                document.getElementById('lb-count').innerText = `${this.lightboxIdx + 1} / ${gallery.length}`;
            },


            // --- NUEVO SISTEMA DE EXPERIENCIA DE CLASE ---

            openClassDetails(id, specificSessionStr = null, capacityInfo = null) {
                const c = DataManager.get().clases.find(x => x.id == id);
                if(!c) return;
                const images = c.gallery || [c.img];

                // 1. HORARIO (Lógica existente)
                let scheduleDisplay = '';
                if (specificSessionStr) {
                    scheduleDisplay = `<p class="text-2xl text-gold font-serif font-bold border-b border-white/10 pb-4 mb-6 animate-pulse">${specificSessionStr}</p>`;
                } else {
                    if (c.showSchedule !== false && c.schedules && c.schedules.length > 0) {
                        const days = ["Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado"];
                        const list = c.schedules.map(s => `<span class="block text-gray-300"><span class="text-gold w-20 inline-block">${days[s.day]}</span> ${s.time}</span>`).join('');
                        scheduleDisplay = `<div class="mb-6 p-4 bg-white/5 rounded-lg border border-white/5">${list}</div>`;
                    }
                }

                // 2. CUPO (CORRECCIÓN: Validamos que capacityInfo sea un número válido)
                let spotsDisplay = '';
                // Solo mostramos el cuadro si capacityInfo es un número (viene de Agenda)
                if (typeof capacityInfo === 'number') { 
                    const color = capacityInfo < 5 ? 'text-rose' : 'text-success';
                    spotsDisplay = `<div class="absolute top-4 left-4 md:top-6 md:right-6 md:left-auto bg-black/90 backdrop-blur-md border border-white/10 px-3 py-2 md:px-4 md:py-2 rounded-lg z-30 flex flex-col items-center shadow-2xl animate-fade-in">
                        <span class="text-xl md:text-2xl font-black ${color}">${capacityInfo}</span>
                        <span class="text-[7px] md:text-[8px] text-gray-400 uppercase font-bold tracking-widest">Disponibles</span>
                    </div>`;
                }
                

                // 1. Procesamiento de Texto Rico (* Título ORO)
                const formatDetails = (text) => {
                    if(!text) return '<p class="text-gray-500 italic">Más detalles próximamente...</p>';
                    return text.split('\n').map(line => {
                        const l = line.trim();
                        // CAMBIO: text-neon a text-gold y border-neon a border-gold
                        if(l.startsWith('*')) return `<h4 class="text-gold font-display font-bold text-lg mt-6 mb-3 border-l-4 border-gold pl-3">${l.substring(1)}</h4>`;
                        if(l.startsWith('-')) return `<li class="flex items-start gap-2 mb-2 ml-1"><span class="text-gold mt-1.5 text-[10px]">●</span> <span class="text-gray-300">${l.substring(1)}</span></li>`;
                        if(l === '') return '<br>';
                        return `<p class="mb-3 leading-relaxed text-gray-300">${line}</p>`;
                    }).join('');
                };

                // 2. Modal HTML (Calibración Móvil: 40% Img / 40% Texto / 20% Botón)
                const modalHTML = `
                    <div id="class-modal-overlay" class="fixed inset-0 z-[200] bg-black/95 backdrop-blur-xl flex items-center justify-center p-0 md:p-8 transition-opacity duration-500 opacity-0" onclick="App.closeClassModal()">
                        <div class="w-full h-full md:h-[85vh] md:max-w-5xl bg-[#08090B] md:border border-white/10 md:rounded-3xl overflow-hidden shadow-2xl relative transform transition-all duration-500 translate-y-10 md:scale-95 flex flex-col md:block" id="class-modal-card" onclick="event.stopPropagation()">
                            
                            <button onclick="App.closeClassModal()" class="absolute top-4 right-4 z-50 w-10 h-10 bg-black/60 text-white rounded-full hover:bg-gold hover:text-black transition-all flex items-center justify-center border border-white/10 backdrop-blur-md">
                                <i class="fa-solid fa-xmark"></i>
                            </button>

                            <div class="flex flex-col md:grid md:grid-cols-2 h-full">
                                
                                <div class="h-[40%] md:h-full relative overflow-hidden group bg-black shrink-0">
                                    
                                    ${spotsDisplay} 
                                    
                                    <div id="modal-carousel" class="flex h-full transition-transform duration-500 ease-out">
                                        ${images.map(img => `<img src="${img}" class="w-full h-full object-cover shrink-0">`).join('')}
                                    </div>
                                    <div class="hidden md:block absolute top-0 right-0 w-32 h-full bg-gradient-to-l from-[#08090B] to-transparent z-10 pointer-events-none"></div>
                                    <div class="absolute inset-0 bg-gradient-to-t from-[#08090B] via-transparent to-transparent opacity-100 md:bg-gradient-to-r z-0"></div>

                                    ${images.length > 1 ? `
                                        <button onclick="App.moveModalCarousel(-1)" class="absolute left-4 top-1/2 -translate-y-1/2 text-white/50 hover:text-white text-3xl z-20"><i class="fa-solid fa-chevron-left"></i></button>
                                        <button onclick="App.moveModalCarousel(1)" class="absolute right-4 top-1/2 -translate-y-1/2 text-white/50 hover:text-white text-3xl z-20"><i class="fa-solid fa-chevron-right"></i></button>
                                        <div class="absolute bottom-4 left-0 right-0 flex justify-center gap-2 z-20">
                                            ${images.map((_, i) => `<div class="w-1.5 h-1.5 rounded-full bg-white/30 transition-colors" id="dot-${i}"></div>`).join('')}
                                        </div>
                                    ` : ''}

                                    <div class="absolute bottom-6 left-6 right-6 animate-slide-up pointer-events-none z-20">
                                        <h2 class="text-3xl md:text-5xl font-serif font-black text-white leading-none mb-3 drop-shadow-lg">${c.name}</h2>
                                        <div class="flex flex-wrap gap-2 items-center">
                                            <span class="px-3 py-1 rounded-full text-[10px] uppercase font-black border backdrop-blur-md shadow-xl ${c.level.includes('Principiante') ? 'bg-emerald-950/80 text-emerald-400 border-emerald-500/50' : c.level.includes('Intermedio') ? 'bg-amber-950/80 text-amber-400 border-amber-500/50' : c.level.includes('Avanzado') ? 'bg-rose-950/80 text-rose-400 border-rose-500/50' : 'bg-blue-950/80 text-blue-400 border-blue-500/50'}">${c.level}</span>
                                            ${c.showPrice ? `<span class="px-3 py-1 rounded-full bg-gold/20 text-gold text-xs font-bold border border-gold/30 backdrop-blur-md currency-dynamic" data-crc="${c.priceCRC || 0}" data-usd="${c.priceUSD || 0}">₡${parseInt(c.priceCRC || 0).toLocaleString()}</span>` : ''}
                                        </div>
                                    </div>
                                </div>

                                <div class="h-[60%] md:h-full flex flex-col bg-[#08090B] relative z-20 overflow-hidden">
                                    
                                    <div class="flex-1 overflow-y-auto p-6 md:p-10 custom-scrollbar">
                                        
                                        <div class="dance-item dance-delay-1">
                                        
                                            <h4 class="text-gold text-xs font-bold uppercase tracking-widest mb-3 flex items-center gap-2">
                                                <i class="fa-regular fa-clock"></i> Horario ${specificSessionStr ? 'Sesión' : 'General'}
                                            </h4>
                                            
                                            ${scheduleDisplay}
                                            <div class="prose prose-invert prose-sm max-w-none text-gray-300 pb-4">${formatDetails(c.details || c.desc)}</div>
                                        </div>
                                        
                                    </div>

                                    <div class="p-6 md:p-8 border-t border-white/10 bg-[#08090B] shrink-0 z-30 dance-item dance-delay-3 shadow-[0_-10px_40px_rgba(0,0,0,0.5)]">
                                        <button onclick="window.open('https://wa.me/50670866080?text=Hola,%20quiero%20inscribirme%20en%20${encodeURIComponent(c.name)}', '_blank')" class="btn-galaxy w-full py-4 rounded-xl font-bold uppercase tracking-widest shadow-xl hover:shadow-gold/30 text-sm flex items-center justify-center gap-3 transform active:scale-95 transition-transform">
                                            <span>Inscribirme Ahora</span>
                                            <i class="fa-brands fa-whatsapp text-lg"></i>
                                        </button>
                                        <p class="text-center text-gray-600 text-[10px] mt-2 uppercase tracking-wider">Cupos Limitados</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
              
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                this.modalImgIdx = 0;
                this.modalImgMax = images.length;
                
                // Activar Animación
                setTimeout(() => {
                    document.getElementById('class-modal-overlay').classList.remove('opacity-0');
                    const card = document.getElementById('class-modal-card');
                    card.classList.remove('translate-y-10', 'md:scale-95'); // Reset inicial
                    // No necesitamos añadir clases, la transición CSS hará el resto al quitar las de "oculto"
                }, 10);
                document.body.style.overflow = 'hidden';
            },

            // Lógica del carrusel del modal
            modalImgIdx: 0,
            modalImgMax: 0,
            moveModalCarousel(dir) {
                this.modalImgIdx = (this.modalImgIdx + dir + this.modalImgMax) % this.modalImgMax;
                document.getElementById('modal-carousel').style.transform = `translateX(-${this.modalImgIdx * 100}%)`;
                // Actualizar puntos
                for(let i=0; i<this.modalImgMax; i++) {
                    const dot = document.getElementById(`dot-${i}`);
                    if(dot) dot.className = `w-1.5 h-1.5 rounded-full transition-colors ${i === this.modalImgIdx ? 'bg-white' : 'bg-white/30'}`;
                }
            },
          
          
            closeClassModal() {
                const overlay = document.getElementById('class-modal-overlay');
                const card = document.getElementById('class-modal-card');
                if(overlay && card) {
                    overlay.classList.add('opacity-0');
                    card.classList.remove('scale-100', 'translate-y-0');
                    card.classList.add('scale-90', 'translate-y-10');
                    setTimeout(() => {
                        overlay.remove();
                        document.body.style.overflow = '';
                    }, 500);
                }
            },


            // --- EXPERIENCIA DE COMPRA (MEMBRESÍAS - LUXURY) ---
            
            openMembershipDetails(id) {
                const m = DataManager.get().membresias.find(x => x.id == id);
                if(!m) return;

                // Formateador de texto rico (Igual que Clases)
                const formatDetails = (text) => {
                    if(!text) return '';
                    return text.split('\n').map(line => {
                        const l = line.trim();
                        if(l.startsWith('*')) return `<h4 class="text-gold font-display font-bold text-sm mt-6 mb-3 border-l-2 border-gold pl-3 uppercase tracking-widest">${l.substring(1)}</h4>`;
                        if(l.startsWith('-')) return `<li class="flex items-start gap-2 mb-2 ml-1"><span class="text-gold mt-1.5 text-[10px]">✦</span> <span class="text-gray-300 font-light">${l.substring(1)}</span></li>`;
                        if(l === '') return '<br>';
                        return `<p class="mb-3 leading-relaxed text-gray-300 font-light">${line}</p>`;
                    }).join('');
                };

                // --- AJUSTE PUNTUAL DE BORDE ---
                // Si es popular: Borde Oro + Sombra Dorada
                // Si no: Borde sutil (white/10) igual a las clases
                const borderStyle = m.popular 
                    ? 'border-gold shadow-[0_0_40px_rgba(212,175,55,0.15)]' 
                    : 'border-white/10 shadow-2xl';


                const modalHTML = `
                    <div id="memb-modal-overlay" class="fixed inset-0 z-[200] bg-black/95 backdrop-blur-xl flex items-center justify-center p-0 md:p-4 transition-opacity duration-500 opacity-0" onclick="App.closeMembModal()">
                        
                        <div class="w-full h-full md:h-auto md:max-h-[85vh] md:max-w-2xl bg-[#08090B] md:border ${borderStyle} md:rounded-3xl overflow-hidden relative transform transition-all duration-500 translate-y-10 md:scale-95 flex flex-col" id="memb-modal-card" onclick="event.stopPropagation()">
                            
                            <div class="relative h-48 shrink-0 overflow-hidden">
                                <div class="absolute inset-0 bg-gradient-to-b from-gold/20 via-[#08090B]/50 to-[#08090B]"></div>
                                <div class="absolute inset-0 flex flex-col items-center justify-center z-10 p-6 text-center animate-slide-up">
                                    <span class="text-gold text-[10px] font-bold uppercase tracking-[0.3em] mb-2 border border-gold/30 px-3 py-1 rounded-full bg-black/50 backdrop-blur-md">Plan Seleccionado</span>
                                    <h2 class="text-4xl font-serif font-black text-gold mb-2 shadow-black drop-shadow-lg">${m.name}</h2>
                                    <div class="flex items-baseline gap-1">
                                        <span class="text-2xl font-bold text-white currency-dynamic" data-crc="${m.priceCRC}" data-usd="${m.priceUSD}">₡${parseInt(m.priceCRC).toLocaleString()}</span>
                                        <span class="text-[10px] text-gray-400 uppercase">/ mes</span>
                                    </div>
                                </div>
                                <div class="absolute inset-0 opacity-20 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')]"></div>
                                
                                <button onclick="App.closeMembModal()" class="absolute top-4 right-4 z-50 w-10 h-10 bg-black/50 text-white rounded-full hover:bg-gold hover:text-black transition-all flex items-center justify-center border border-white/10 backdrop-blur-md">
                                    <i class="fa-solid fa-xmark"></i>
                                </button>
                            </div>

                            <div class="flex-1 overflow-y-auto p-8 custom-scrollbar bg-[#08090B]">
                                <div class="prose prose-invert prose-sm max-w-none text-gray-300">
                                    ${formatDetails(m.details)}
                                </div>
                            </div>

                            <div class="p-6 border-t border-white/10 bg-[#08090B] shrink-0 z-20">
                                <button onclick="window.open('https://wa.me/50670866080?text=Hola,%20deseo%20activar%20el%20plan%20*${encodeURIComponent(m.name)}*', '_blank')" 
                                    class="btn-galaxy w-full py-4 rounded-xl font-bold uppercase tracking-[0.2em] shadow-xl hover:shadow-gold/30 flex items-center justify-center gap-3 transform active:scale-95 transition-transform text-xs">
                                    <span>Solicitar Activación</span>
                                    <i class="fa-brands fa-whatsapp text-lg"></i>
                                </button>
                                <p class="text-[10px] text-center text-gray-600 mt-3">Coordinación de pago segura vía WhatsApp</p>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
                // Animación de Entrada
                setTimeout(() => {
                    document.getElementById('memb-modal-overlay').classList.remove('opacity-0');
                    const card = document.getElementById('memb-modal-card');
                    card.classList.remove('md:scale-95', 'translate-y-10');
                    // En móvil no hacemos nada extra porque ya ocupa el 100%
                }, 10);
                document.body.style.overflow = 'hidden';
            },

            closeMembModal() {
                const overlay = document.getElementById('memb-modal-overlay');
                const card = document.getElementById('memb-modal-card');
                if(overlay && card) {
                    overlay.classList.add('opacity-0');
                    card.classList.add('md:scale-95', 'translate-y-10');
                    setTimeout(() => {
                        overlay.remove();
                        document.body.style.overflow = '';
                    }, 300);
                }
            },

            // --- AGENDA PÚBLICA (TABLA SEMANAL) ---
            agendaOffset: 0, // Semana actual (0), próxima (1), anterior (-1)

            renderAgenda() {
                const container = document.getElementById('agenda-container');
                if(!container) return;

                const d = DataManager.get();
                const sesiones = d.sesiones || [];
                const reservas = d.reservas || []; // Blindaje contra undefined
                
                // FONDO CUSTOM
                const bgImage = d.config.hero.agendaBg || "https://images.unsplash.com/photo-1545959570-a9477eb37265"; 
                const section = document.getElementById('view-agenda');
                if(section) {
                    section.style.backgroundImage = `linear-gradient(to bottom, rgba(2,2,3,0.85) 0%, rgba(2,2,3,0.6) 50%, rgba(2,2,3,0.85) 100%), url('${bgImage}')`;
                    section.style.backgroundSize = 'cover';
                    section.style.backgroundAttachment = 'fixed';
                }

                // CÁLCULOS DE FECHA
                const curr = new Date();
                const day = curr.getDay() || 7; 
                const monday = new Date(curr.setDate(curr.getDate() - day + 1 + (this.agendaOffset * 7)));
                monday.setHours(0,0,0,0);
                const sunday = new Date(monday);
                sunday.setDate(monday.getDate() + 6);

                const weekDays = [];
                for(let i=0; i<7; i++) {
                    const date = new Date(monday);
                    date.setDate(monday.getDate() + i);
                    weekDays.push(date);
                }

                // TÍTULO SEMANA
                const m1 = monday.toLocaleDateString('es-CR', {month:'long'}).toUpperCase();
                const m2 = sunday.toLocaleDateString('es-CR', {month:'long'}).toUpperCase();
                const titleDate = (m1 === m2) 
                    ? `<span class="text-white">${monday.getDate()}</span> - <span class="text-white">${sunday.getDate()}</span> DE <span class="text-gold font-bold">${m1}</span>`
                    : `<span class="text-white">${monday.getDate()} ${m1.slice(0,3)}</span> - <span class="text-white">${sunday.getDate()} ${m2.slice(0,3)}</span>`;

                container.className = "w-full relative z-10"; 
                container.innerHTML = `
                    <div class="flex justify-between items-center mb-12">
                        <button onclick="App.agendaOffset--; App.renderAgenda()" class="w-12 h-12 rounded-full border border-white/10 hover:border-gold text-white hover:text-gold transition-all flex items-center justify-center bg-black/50 backdrop-blur-md"><i class="fa-solid fa-arrow-left"></i></button>
                        <div class="text-center px-10 py-5 bg-black/80 backdrop-blur-xl border-2 border-gold rounded-2xl shadow-[0_0_40px_rgba(212,175,55,0.2)]">
                            <span class="block text-[10px] text-gray-400 uppercase tracking-[0.4em] mb-2">Semana Actual</span>
                            <h3 class="text-xl md:text-3xl font-serif tracking-widest text-gray-400">${titleDate}</h3>
                        </div>
                        <button onclick="App.agendaOffset++; App.renderAgenda()" class="w-12 h-12 rounded-full border border-white/10 hover:border-gold text-white hover:text-gold transition-all flex items-center justify-center bg-black/50 backdrop-blur-md"><i class="fa-solid fa-arrow-right"></i></button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-7 gap-4">
                        ${weekDays.map(date => {
                            const dateStr = date.toDateString();
                            const isToday = new Date().toDateString() === dateStr;
                            
                            // FILTRO SESIONES
                            const daySessions = sesiones.filter(s => new Date(s.date).toDateString() === dateStr)
                                                        .sort((a,b) => a.time.localeCompare(b.time));

                            // ESTILOS DINÁMICOS
                            const cardStyles = isToday 
                                ? 'bg-[#08090B]/95 border-2 border-gold shadow-[0_0_30px_rgba(212,175,55,0.2)] z-10 scale-[1.02]' 
                                : 'bg-[#08090B]/80 border border-white/10 hover:border-gold hover:shadow-[0_0_30px_rgba(212,175,55,0.4)] hover:-translate-y-1';
                            const headerStyles = isToday ? 'bg-gold/10' : 'bg-transparent';
                            const dayColor = isToday ? 'text-gold' : 'text-gray-400 group-hover/day:text-gold transition-colors';
                            const numColor = isToday ? 'text-white drop-shadow-[0_0_10px_rgba(212,175,55,0.5)]' : 'text-white';

                            return `
                                <div class="flex flex-col h-full rounded-2xl overflow-hidden backdrop-blur-md transition-all duration-300 group/day ${cardStyles}">
                                    <div class="text-center p-4 border-b border-white/5 ${headerStyles}">
                                        <span class="block text-[10px] font-bold uppercase tracking-[0.3em] mb-1 ${dayColor}">
                                            ${date.toLocaleDateString('es-CR', {weekday: 'short'})}
                                        </span>
                                        <span class="block text-3xl font-serif font-black leading-none ${numColor}">
                                            ${date.getDate()}
                                        </span>
                                    </div>
                                    <div class="p-2 space-y-2 flex-1 min-h-[120px] flex flex-col justify-start">
                                        ${daySessions.length === 0 ? '<div class="flex-1 flex items-center justify-center opacity-10"><i class="fa-solid fa-diamond text-2xl"></i></div>' : ''}
                                        
                                        ${daySessions.map(s => {
                                            // DEFINICIÓN DE VARIABLES CRÍTICAS (Aquí estaba el error antes)
                                            let c = { name: s.customName || 'Evento Especial', level: 'General', id: null };
                                            if (s.claseId) {
                                                const found = d.clases.find(x => x.id === s.claseId);
                                                if (found) c = found; 
                                            }

                                            // CÁLCULO DE CUPOS
                                            const inscritos = reservas.filter(r => r.sesionId === s.id).length;
                                            const availableSpots = s.capacity - inscritos;
                                            const isFull = inscritos >= s.capacity;

                                            // PREPARAR CLICK
                                            const niceTime = s.time;
                                            const niceDay = date.toLocaleDateString('es-CR', {weekday:'long'});
                                            
                                            // VARIABLES VISUALES
                                            const itemCursor = s.claseId ? 'cursor-pointer hover:border-gold hover:bg-[#0F1115]' : 'cursor-default';
                                            const clickAttr = s.claseId 
                                                ? `onclick="App.openClassDetails(${s.claseId}, '${niceDay} ${niceTime}', ${availableSpots})"` 
                                                : '';

                                            return `
                                                <div class="bg-black/40 border border-white/5 p-3 rounded-lg relative group/item transition-all duration-300 ${itemCursor}" ${clickAttr}>
                                                    <div class="flex justify-between items-center mb-1.5">
                                                        <span class="text-[10px] font-mono text-gold/80 group-hover/item:text-gold">${s.time}</span>
                                                        ${isFull ? '<span class="text-[8px] bg-rose text-white px-1.5 py-0.5 rounded font-bold shadow-sm shadow-rose/20">FULL</span>' : ''}
                                                    </div>
                                                    <h4 class="text-xs font-bold text-white leading-tight mb-2 group-hover/item:text-white transition-colors">
                                                        ${c.name}
                                                    </h4>
                                                    <span class="inline-block text-[8px] font-bold uppercase tracking-wider px-1.5 py-0.5 rounded border ${
                                                        c.level.includes('Principiante') ? 'text-emerald-400 bg-emerald-950/30 border-emerald-500/30' :
                                                        c.level.includes('Intermedio') ? 'text-amber-400 bg-amber-950/30 border-amber-500/30' :
                                                        c.level.includes('Avanzado') ? 'text-rose-400 bg-rose-950/30 border-rose-500/30' :
                                                        'text-blue-400 bg-blue-950/30 border-blue-500/30'
                                                    }">
                                                        ${c.level}
                                                    </span>
                                                    ${s.claseId ? `
                                                    <div class="absolute right-2 bottom-2 opacity-0 group-hover/item:opacity-100 transition-opacity transform translate-x-2 group-hover/item:translate-x-0">
                                                        <i class="fa-solid fa-chevron-right text-[10px] text-gold"></i>
                                                    </div>` : ''}
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            },

            // --- PORTAL ALUMNO 2.0 (NEXUS - LÓGICA REAL) ---
            renderStudentPortal() {
                // 1. Identificar Usuario y Datos
                const studentId = sessionStorage.getItem('current_user_id');
                const d = DataManager.get();
                const alumno = d.alumnos.find(a => a.id === studentId);

                // Seguridad: Si no hay usuario, sacar
                if (!alumno) { App.logout(); return; }
                
                // 2. Datos del Plan
                const plan = d.membresias.find(m => m.id === alumno.planId) || { name: "Sin Plan", weeklyLimit: 0 };
                
                // 3. Inyección de Datos en Header (Nombre en la barra negra superior)
                const nameEl = document.getElementById('student-name');
                if(nameEl) nameEl.innerText = alumno.name;
                
                // 4. Lógica de Créditos (BLINDADA)
                const curr = new Date();
                const day = curr.getDay() || 7; 
                const monday = new Date(curr.setDate(curr.getDate() - day + 1));
                monday.setHours(0,0,0,0);
                const sunday = new Date(monday);
                sunday.setDate(monday.getDate() + 6);
                sunday.setHours(23,59,59,999);

                // FIX: Usamos (d.reservas || []) para evitar el error "undefined"
                const todasReservas = d.reservas || [];
                const todasSesiones = d.sesiones || [];

                const reservasSemana = todasReservas.filter(r => {
                    if (r.alumnoId !== studentId) return false;
                    const sesion = todasSesiones.find(s => s.id === r.sesionId);
                    if (!sesion) return false;
                    const date = new Date(sesion.date);
                    return date >= monday && date <= sunday;
                }).length;

                const limit = plan.weeklyLimit || 0;
                const extra = alumno.extraCredits || 0;
                const totalAvailable = limit + extra;
                const creditosRestantes = Math.max(0, totalAvailable - reservasSemana);
                
                const barWidth = totalAvailable > 0 ? (reservasSemana / totalAvailable) * 100 : 0;

                // 5. RENDERIZADO DEL DASHBOARD (Diseño Corregido)
                const container = document.querySelector('#view-alumno .container'); 
                
                if (container) {
                    container.innerHTML = `
                        <div class="flex justify-between items-start mb-6 fade-in">
                            <span class="text-[9px] text-gray-600 uppercase tracking-[0.2em] pt-2">Panel de Control</span>
                            <button onclick="App.logout()" class="group flex items-center gap-3 px-5 py-2 rounded-full border border-white/5 hover:border-rose-500/30 hover:bg-rose-500/10 transition-all">
                                <span class="text-[10px] font-bold text-gray-500 group-hover:text-rose-500 uppercase tracking-widest transition-colors">Cerrar Sesión</span>
                                <i class="fa-solid fa-power-off text-gray-600 group-hover:text-rose-500 text-xs transition-colors"></i>
                            </button>
                        </div>

                        <div class="grid md:grid-cols-3 gap-6 mb-10 fade-in">
                            <div class="md:col-span-2 flex flex-col justify-end">
                                <h1 class="text-4xl md:text-5xl font-serif font-bold text-white mb-2 leading-none">Hola, <span class="text-neon">${alumno.name.split(' ')[0]}</span></h1>
                                <div class="flex items-center gap-3 text-sm text-gray-400">
                                    <span class="bg-white/10 px-3 py-1 rounded text-white border border-white/10 text-[10px] uppercase tracking-wider font-bold">${plan.name}</span>
                                    <span class="text-gold">•</span>
                                    <span class="text-xs">Ciclo Semanal</span>
                                </div>
                            </div>
                            
                            <div class="bg-panel border border-white/10 p-6 rounded-2xl relative overflow-hidden group shadow-lg">
                                <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><i class="fa-solid fa-chart-pie text-6xl text-gold"></i></div>
                                <span class="text-[9px] text-gold font-bold uppercase tracking-[0.2em] block mb-2">Clases Disponibles</span>
                                <div class="flex items-baseline gap-2 mb-3">
                                    <span class="text-6xl font-serif font-black text-white leading-none">${creditosRestantes}</span>
                                    <span class="text-sm text-gray-600 font-mono font-bold">/ ${totalAvailable}</span>
                                </div>
                                <div class="w-full h-1 bg-white/10 rounded-full overflow-hidden">
                                    <div class="h-full bg-gradient-to-r from-gold to-yellow-600 shadow-[0_0_15px_var(--color-gold)] transition-all duration-1000" style="width: ${barWidth}%"></div>
                                </div>
                            </div>
                        </div>

                        <div class="flex flex-wrap gap-4 mb-12 fade-in" style="animation-delay: 0.1s;">
                            <button onclick="App.startQRScanner()" class="btn-galaxy px-8 py-4 rounded-xl text-xs font-bold shadow-lg flex items-center justify-center gap-3 hover:scale-105 transition-transform flex-1 text-black tracking-widest uppercase">
                                <i class="fa-solid fa-qrcode text-lg"></i> Marcar Asistencia
                            </button>
                            <button onclick="App.openDirectLine()" class="px-8 py-4 rounded-xl text-xs font-bold border border-white/10 hover:border-neon hover:text-neon text-white transition-all flex items-center justify-center gap-3 flex-1 bg-white/5 tracking-widest uppercase hover:bg-white/10">
                                <i class="fa-regular fa-comments text-lg"></i> Soporte Directo
                            </button>
                        </div>

                        <div class="border-b border-white/10 mb-8 flex gap-8 fade-in" style="animation-delay: 0.2s;">
                            <button onclick="App.renderStudentTab('reservar')" id="tab-st-reservar" class="pb-4 text-xs md:text-sm font-bold uppercase tracking-[0.15em] text-gold border-b-2 border-gold transition-colors">
                                Clases Disponibles
                            </button>
                            <button onclick="App.renderStudentTab('historial')" id="tab-st-historial" class="pb-4 text-xs md:text-sm font-bold uppercase tracking-[0.15em] text-gray-500 hover:text-white border-b-2 border-transparent transition-colors">
                                Mis Reservas & Media
                            </button>
                        </div>

                        <div id="student-tab-content" class="min-h-[400px] fade-in" style="animation-delay: 0.3s;"></div>
                    `;
                    
                    this.renderStudentTab('reservar');
                }
            },

            renderStudentTab(tab) {
                const btns = { reservar: $('#tab-st-reservar'), historial: $('#tab-st-historial') };
                Object.values(btns).forEach(b => b.className = "pb-4 text-sm font-bold uppercase tracking-widest text-gray-500 hover:text-white border-b-2 border-transparent transition-colors");
                btns[tab].className = "pb-4 text-sm font-bold uppercase tracking-widest text-gold border-b-2 border-gold transition-colors";

                const content = document.getElementById('student-tab-content');
                const d = DataManager.get();
                const studentId = "alumno"; 
                const now = new Date();

                if (tab === 'reservar') {
                    // FILTRO: Futuras, No reservadas, Con cupo
                    const available = d.sesiones.filter(s => {
                        const date = new Date(s.date);
                        const isFuture = date >= now;
                        const isReserved = d.reservas.some(r => r.sesionId === s.id && r.alumnoId === studentId);
                        const reservedCount = d.reservas.filter(r => r.sesionId === s.id).length;
                        return isFuture && !isReserved && reservedCount < s.capacity;
                    }).sort((a,b) => new Date(a.date) - new Date(b.date));

                    if (available.length === 0) {
                        content.innerHTML = '<div class="p-10 border border-white/5 rounded-xl text-center"><i class="fa-solid fa-calendar-xmark text-4xl text-gray-600 mb-4"></i><p class="text-gray-500">No hay clases disponibles para reservar.</p></div>';
                        return;
                    }

                    content.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
                        ${available.map(s => {
                            const c = s.claseId ? d.clases.find(x => x.id === s.claseId) : {name: s.customName, level: 'Especial', img: d.config.hero.bgImage};
                            const spots = s.capacity - d.reservas.filter(r => r.sesionId === s.id).length;
                            const niceDate = new Date(s.date).toLocaleDateString('es-CR', {weekday: 'short', day: 'numeric', month: 'short'});
                            
                            return `
                                <div class="bg-panel border border-white/5 rounded-2xl overflow-hidden group hover:border-gold/30 transition-all flex flex-col h-full">
                                    <div class="h-32 relative overflow-hidden">
                                        <img src="${c.img}" class="w-full h-full object-cover opacity-60 group-hover:opacity-100 transition-opacity">
                                        <div class="absolute top-2 right-2 bg-black/80 px-2 py-1 rounded text-[10px] text-gold font-bold uppercase border border-gold/20">${niceDate}</div>
                                    </div>
                                    <div class="p-5 flex-1 flex flex-col">
                                        <div class="flex justify-between items-start mb-2">
                                            <h3 class="text-white font-bold text-lg leading-tight line-clamp-2">${c.name}</h3>
                                        </div>
                                        <div class="flex items-center gap-2 mb-4 text-xs text-gray-400 font-mono">
                                            <i class="fa-regular fa-clock text-gold"></i> ${s.time}
                                        </div>
                                        
                                        <div class="mt-auto pt-4 border-t border-white/5 flex justify-between items-center">
                                            <span class="text-[10px] ${spots < 5 ? 'text-rose' : 'text-gray-500'} uppercase font-bold tracking-wider">${spots} Cupos</span>
                                            <button onclick="App.studentReserve(${s.id})" class="bg-white/10 hover:bg-gold hover:text-black text-white px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider transition-colors shadow-lg">Reservar</button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>`;

                } else {
                    // HISTORIAL & MEDIA
                    const myReservations = d.reservas.filter(r => r.alumnoId === studentId);
                    const mySessions = myReservations.map(r => {
                        const s = d.sesiones.find(x => x.id === r.sesionId);
                        return { ...s, reserva: r };
                    }).sort((a,b) => new Date(b.date) - new Date(a.date));

                    if (mySessions.length === 0) {
                        content.innerHTML = '<div class="p-10 border border-white/5 rounded-xl text-center"><p class="text-gray-500">Aún no has reservado clases.</p></div>';
                        return;
                    }

                    content.innerHTML = `<div class="space-y-4">
                        ${mySessions.map(s => {
                            const c = s.claseId ? d.clases.find(x => x.id === s.claseId) : {name: s.customName};
                            const isPast = new Date(s.date) < now;
                            const hasPhotos = s.media?.photos?.[0];
                            const hasVideo = s.media?.videos?.[0];
                            const attended = s.reserva.asistencia;

                            // Lógica de Cancelación con Penalización
                            const hoursDiff = (new Date(s.date) - now) / 36e5;
                            const canCancel = !isPast && hoursDiff > (d.config.cancellationHours || 12);
                            const penaltyWarning = !isPast && !canCancel ? 'Tiempo límite excedido' : '';

                            return `
                                <div class="bg-panel border border-white/5 p-5 rounded-xl flex flex-col md:flex-row items-center justify-between gap-6 hover:bg-white/5 transition-colors relative overflow-hidden">
                                    ${attended ? '<div class="absolute left-0 top-0 bottom-0 w-1 bg-success shadow-[0_0_10px_#00E676]"></div>' : ''}
                                    
                                    <div class="flex items-center gap-6 w-full md:w-auto">
                                        <div class="w-16 h-16 rounded-2xl bg-black flex flex-col items-center justify-center text-gold border border-white/10 shrink-0">
                                            <span class="text-xl font-black leading-none">${new Date(s.date).getDate()}</span>
                                            <span class="text-[9px] uppercase">${new Date(s.date).toLocaleDateString('es-CR', {month:'short'})}</span>
                                        </div>
                                        <div>
                                            <h3 class="text-white font-bold text-lg">${c.name}</h3>
                                            <p class="text-xs text-gray-500 mt-1 flex items-center gap-2">
                                                <span class="bg-white/10 px-2 py-0.5 rounded text-[10px]">${s.time}</span>
                                                ${!isPast && !canCancel ? `<span class="text-rose text-[9px]"><i class="fa-solid fa-triangle-exclamation"></i> ${penaltyWarning}</span>` : ''}
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <div class="flex flex-wrap items-center gap-3 w-full md:w-auto justify-end">
                                        
                                        ${attended ? `
                                            ${hasPhotos ? `
                                                <button onclick="window.open('${s.media.photos[0]}', '_blank')" class="flex items-center gap-2 bg-[#2d3748] hover:bg-[#4299e1] hover:text-white text-blue-300 px-4 py-2 rounded-lg text-xs font-bold transition-all border border-blue-500/30">
                                                    <i class="fa-brands fa-google-drive text-lg"></i> <span class="hidden md:inline">FOTOS</span>
                                                </button>` : ''}
                                            ${hasVideo ? `
                                                <button onclick="App.changeVideo('${s.media.videos[0]}'); App.openVideoModal()" class="flex items-center gap-2 bg-[#4c1d1d] hover:bg-[#e53e3e] hover:text-white text-rose-300 px-4 py-2 rounded-lg text-xs font-bold transition-all border border-rose-500/30">
                                                    <i class="fa-brands fa-youtube text-lg"></i> <span class="hidden md:inline">VIDEO</span>
                                                </button>` : ''}
                                        ` : ''}

                                        ${attended 
                                            ? '<span class="text-success text-[10px] font-bold border border-success/30 px-4 py-2 rounded-lg uppercase tracking-wider bg-success/10">ASISTIÓ</span>' 
                                            : isPast 
                                                ? '<span class="text-rose text-[10px] font-bold border border-rose/30 px-4 py-2 rounded-lg uppercase tracking-wider bg-rose/10">AUSENTE</span>' 
                                                : canCancel
                                                    ? `<button onclick="App.studentCancel(${s.reserva.id})" class="text-rose text-xs font-bold uppercase tracking-wider transition-colors border border-rose/30 px-4 py-2 rounded-lg hover:bg-rose hover:text-white">Cancelar</button>`
                                                    : '<span class="text-gray-500 text-[10px] uppercase font-bold border border-white/5 px-4 py-2 rounded-lg">Cerrado</span>'
                                        }
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>`;
                }
            },

            studentReserve(sessionId) {
                const d = DataManager.get();
                const studentId = "alumno";
                const alumno = d.alumnos.find(a => a.id === studentId);
                const plan = d.membresias.find(m => m.id === alumno.planId);
                
                // VALIDAR LÍMITE SEMANAL
                const curr = new Date();
                const day = curr.getDay() || 7; 
                const monday = new Date(curr.setDate(curr.getDate() - day + 1));
                monday.setHours(0,0,0,0);
                const sunday = new Date(monday);
                sunday.setDate(monday.getDate() + 6);
                sunday.setHours(23,59,59,999);

                const count = d.reservas.filter(r => 
                    r.alumnoId === studentId && 
                    new Date(d.sesiones.find(s=>s.id===r.sesionId)?.date) >= monday &&
                    new Date(d.sesiones.find(s=>s.id===r.sesionId)?.date) <= sunday
                ).length;

                if (count >= (plan.weeklyLimit || 7)) {
                    Swal.fire({ title: 'Límite Alcanzado', text: 'Has usado todos tus créditos de esta semana.', icon: 'warning', background: '#05060b', color: '#fff' });
                    return;
                }

                d.reservas.push({ id: Date.now(), sesionId: sessionId, alumnoId: studentId, asistencia: false });
                DataManager.save(d);
                Swal.fire({ title: '¡Clase Reservada!', text: 'Nos vemos en la pista.', icon: 'success', background: '#05060b', color: '#fff', confirmButtonColor: '#D4AF37', showConfirmButton: false, timer: 1500 });
                this.renderStudentPortal();
            },

            // HELPER PARA VIDEO (Simple, reutiliza tu lógica existente si tienes modal de video, si no, abre en nueva pestaña)
            openVideoModal() {
                // Si tienes un modal de video global, ábrelo aquí. 
                // Si no, podemos hacer un fallback simple:
                const modal = document.getElementById('video-modal'); // Asumiendo que existe o lo creamos
                if(modal) modal.classList.remove('hidden');
                else window.scrollTo(0,0); // Scroll al hero video
            },


            studentCancel(reservaId) {
                const d = DataManager.get();
                d.reservas = d.reservas.filter(r => r.id !== reservaId);
                DataManager.save(d);
                this.renderStudentPortal();
                const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, background: '#000', color: '#fff' });
                Toast.fire({ icon: 'info', title: 'Reserva cancelada' });
            },

            // --- SCANNER QR REAL ---
            startQRScanner() {
                const html = `
                    <div id="qr-reader" class="rounded-xl overflow-hidden border-2 border-gold"></div>
                    <button onclick="App.stopQRScanner()" class="mt-6 w-full text-center text-gray-500 hover:text-white text-xs font-bold uppercase tracking-widest transition-colors">Cerrar Cámara</button>
                `;
                
                // AJUSTE: Usar uni-modal
                const title = document.getElementById('uni-modal-title');
                const body = document.getElementById('uni-modal-body');
                const modal = document.getElementById('modal');

                if(title && body && modal) {
                    title.innerText = "ESCANEAR CÓDIGO";
                    body.innerHTML = html;
                    modal.classList.remove('hidden');
                    setTimeout(() => {
                        modal.classList.remove('opacity-0');
                        modal.querySelector('#modal-panel').classList.remove('scale-95');
                    }, 10);

                    this.html5QrcodeScanner = new Html5QrcodeScanner("qr-reader", { fps: 10, qrbox: 250 });
                    this.html5QrcodeScanner.render((txt) => this.handleQRSuccess(txt));
                }
            },

            stopQRScanner() {
                if(this.html5QrcodeScanner) {
                    this.html5QrcodeScanner.clear().then(() => App.closeModal()).catch(() => App.closeModal());
                } else {
                    App.closeModal();
                }
            },

            handleQRSuccess(token) {
                this.stopQRScanner();
                const d = DataManager.get();
                const session = d.sesiones.find(s => s.qrToken === token);
                
                if (!session) return Swal.fire({ icon: 'error', title: 'Código Inválido', background: '#000', color: '#fff' });

                const studentId = "alumno";
                const reservaIdx = d.reservas.findIndex(r => r.sesionId === session.id && r.alumnoId === studentId);

                if (reservaIdx > -1) {
                    if(d.reservas[reservaIdx].asistencia) {
                        Swal.fire({ icon: 'info', title: 'Ya registrado', text: 'Tu asistencia ya estaba marcada.', background: '#000', color: '#fff' });
                    } else {
                        d.reservas[reservaIdx].asistencia = true;
                        DataManager.save(d);
                        Swal.fire({ icon: 'success', title: '¡Asistencia Confirmada!', text: 'A bailar.', background: '#000', color: '#fff', confirmButtonColor: '#D4AF37' });
                        this.renderStudentPortal();
                    }
                } else {
                    d.reservas.push({ id: Date.now(), sesionId: session.id, alumnoId: studentId, asistencia: true });
                    DataManager.save(d);
                    Swal.fire({ icon: 'success', title: '¡Bienvenido!', text: 'Reserva creada y asistencia marcada.', background: '#000', color: '#fff', confirmButtonColor: '#D4AF37' });
                    this.renderStudentPortal();
                }
            },


            openDirectLine() {
                const d = DataManager.get();
                const msgs = (d.mensajes || []).filter(m => m.studentId === 'alumno').sort((a,b) => b.date - a.date);

                const html = `
                    <div class="h-[50vh] flex flex-col"> <div class="flex-1 overflow-y-auto space-y-4 p-2 custom-scrollbar mb-4 flex flex-col-reverse">
                            ${msgs.length === 0 ? '<p class="text-center text-gray-600 text-xs mt-10">Inicia una conversación con la administración.</p>' : ''}
                            ${msgs.map(m => `
                                <div class="space-y-2">
                                    <div class="flex justify-end">
                                        <div class="bg-gold/10 border border-gold/30 text-gold p-3 rounded-t-xl rounded-bl-xl text-sm max-w-[80%]">
                                            ${m.text}
                                            <div class="text-[9px] opacity-50 mt-1 text-right">${new Date(m.date).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                                        </div>
                                    </div>
                                    ${m.reply ? `
                                    <div class="flex justify-start">
                                        <div class="bg-white/10 border border-white/10 text-white p-3 rounded-t-xl rounded-br-xl text-sm max-w-[80%]">
                                            <span class="text-[9px] text-neon font-bold block mb-1">ADMIN</span>
                                            ${m.reply}
                                        </div>
                                    </div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                        <div class="mt-auto pt-4 border-t border-white/10">
                            <div class="flex gap-2">
                                <input type="text" id="direct-msg-input" class="flex-1 bg-black border border-white/10 rounded-lg px-4 text-sm text-white focus:border-gold outline-none" placeholder="Escribe tu consulta...">
                                <button onclick="App.sendDirectMessage()" class="btn-galaxy px-6 rounded-lg text-xs font-bold"><i class="fa-solid fa-paper-plane"></i></button>
                            </div>
                            <div class="flex justify-center mt-4">
                                <button onclick="window.open('https://wa.me/50670866080', '_blank')" class="text-success text-xs font-bold flex items-center gap-2 hover:underline"><i class="fa-brands fa-whatsapp text-lg"></i> O contactar por WhatsApp</button>
                            </div>
                        </div>
                    </div>
                `;

                // AJUSTE: Usar uni-modal
                const title = document.getElementById('uni-modal-title');
                const body = document.getElementById('uni-modal-body');
                const modal = document.getElementById('modal');

                if(title && body && modal) {
                    title.innerText = "Soporte Directo";
                    body.innerHTML = html;
                    modal.classList.remove('hidden');
                    setTimeout(() => {
                        modal.classList.remove('opacity-0');
                        modal.querySelector('#modal-panel').classList.remove('scale-95');
                    }, 10);
                }
            },

            sendDirectMessage() {
                const txt = $('#direct-msg-input').value;
                if(!txt.trim()) return;
                
                const d = DataManager.get();
                if(!d.mensajes) d.mensajes = [];
                d.mensajes.push({
                    id: Date.now(),
                    studentId: 'alumno',
                    text: txt,
                    reply: null,
                    date: Date.now(),
                    read: false
                });
                DataManager.save(d);
                this.openDirectLine(); // Refrescar chat
            },

            // --- GESTIÓN DE SUSCRIPCIÓN (MODAL FORMULARIO) ---
            openSubscriptionModal(planId, planName) {
                const html = `
                    <div class="space-y-4">
                        <div class="bg-gold/10 p-4 rounded-lg border border-gold text-center">
                            <p class="text-[10px] text-gold uppercase font-bold tracking-widest">Aplicando a:</p>
                            <h3 class="text-xl font-serif text-white mt-1">${planName}</h3>
                        </div>
                        
                        <div>
                            <label class="text-[10px] text-gray-500 uppercase font-bold block mb-1">Cédula (Será tu Usuario)</label>
                            <input type="text" id="sub-id" class="w-full bg-black border border-white/10 p-3 rounded text-white outline-none focus:border-gold font-mono tracking-wider" placeholder="Ej. 118540678">
                        </div>

                        <div>
                            <label class="text-[10px] text-gray-500 uppercase font-bold block mb-1">Nombre Completo</label>
                            <input type="text" id="sub-name" class="w-full bg-black border border-white/10 p-3 rounded text-white outline-none focus:border-gold" placeholder="Nombre y Apellidos">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-[10px] text-gray-500 uppercase font-bold block mb-1">Teléfono</label>
                                <input type="tel" id="sub-phone" class="w-full bg-black border border-white/10 p-3 rounded text-white outline-none focus:border-gold" placeholder="8888-8888">
                            </div>
                            <div>
                                <label class="text-[10px] text-gray-500 uppercase font-bold block mb-1">Fecha Nacimiento</label>
                                <input type="date" id="sub-birth" class="w-full bg-black border border-white/10 p-3 rounded text-white outline-none focus:border-gold relative z-10" onchange="this.blur()">
                            </div>
                        </div>

                        <div>
                            <label class="text-[10px] text-gray-500 uppercase font-bold block mb-1">Correo Electrónico</label>
                            <input type="email" id="sub-email" class="w-full bg-black border border-white/10 p-3 rounded text-white outline-none focus:border-gold" placeholder="correo@ejemplo.com">
                        </div>

                        <button onclick="App.processSubscription(${planId})" class="btn-galaxy w-full py-4 rounded-xl font-bold mt-6 shadow-lg text-xs uppercase tracking-widest text-black hover:scale-105 transition-transform">
                            CONFIRMAR INSCRIPCIÓN
                        </button>
                        <p class="text-[9px] text-gray-600 text-center mt-2">Tu contraseña será: <strong>sensacion</strong></p>
                    </div>
                `;
                
                // 1. Buscamos el contenedor principal
                const modal = document.getElementById('modal');
                
                // 2. Buscamos los elementos por sus NUEVOS IDs ÚNICOS
                const title = document.getElementById('uni-modal-title');
                const body = document.getElementById('uni-modal-body');

                if(modal && title && body) {
                    title.innerText = "Registro de Alumno"; 
                    body.innerHTML = html; 
                    
                    modal.classList.remove('hidden');
                    setTimeout(() => {
                        modal.classList.remove('opacity-0');
                        // Forzamos visualización completa en móvil
                        const panel = modal.querySelector('#modal-panel');
                        if(panel) panel.classList.remove('scale-95');
                    }, 10);
                } else {
                    console.error("Error crítico: No se encontraron los elementos 'uni-modal-title' o 'uni-modal-body'. Verifica el HTML.");
                }
            },

            processSubscription(planId) {
                const id = document.getElementById('sub-id').value.trim();
                const name = document.getElementById('sub-name').value.trim();
                const phone = document.getElementById('sub-phone').value.trim();
                const email = document.getElementById('sub-email').value.trim();
                const birth = document.getElementById('sub-birth').value;

                if(!id || !name || !phone) return Swal.fire({ icon: 'warning', title: 'Datos Faltantes', text: 'Cédula, Nombre y Teléfono son obligatorios.', background: '#000', color: '#fff' });

                const d = DataManager.get();
                // Verificamos duplicados por ID
                if(d.alumnos.find(a => a.id === id)) return Swal.fire({ icon: 'error', title: 'Ya registrado', text: 'Esta cédula ya tiene cuenta.', background: '#000', color: '#fff' });

                // Crear Alumno
                d.alumnos.push({
                    id: id, 
                    name: name, 
                    pass: 'sensacion', // Contraseña Default
                    role: 'student',
                    phone: phone, 
                    email: email, 
                    birthDate: birth,
                    joinDate: new Date().toISOString(),
                    planId: planId, 
                    extraCredits: 0, 
                    active: true
                });
                DataManager.save(d);

                this.closeModal(); // Cerrar modal correctamente
                
                Swal.fire({
                    title: '¡Bienvenido!',
                    html: `Tu usuario es: <strong>${id}</strong><br>Contraseña temporal: <strong>sensacion</strong>`,
                    icon: 'success',
                    background: '#05060b',
                    color: '#fff',
                    confirmButtonColor: '#D4AF37'
                }).then(() => {
                    this.toggleLoginModal();
                    // Autocompletar login
                    setTimeout(() => {
                        const uid = document.getElementById('login-id');
                        const upass = document.getElementById('login-pass');
                        if(uid) uid.value = id;
                        if(upass) upass.value = 'sensacion';
                    }, 300);
                });
            },

            // Función esencial para cerrar modales (Corrige el error "is not a function")
            closeModal() {
                const modal = document.getElementById('modal');
                if(!modal) return;
                modal.classList.add('opacity-0');
                const panel = modal.querySelector('#modal-panel');
                if(panel) panel.classList.add('scale-95');
                
                setTimeout(() => {
                    modal.classList.add('hidden');
                    // AJUSTE: Limpiamos los NUEVOS IDs
                    const title = document.getElementById('uni-modal-title');
                    const body = document.getElementById('uni-modal-body');
                    if(title) title.innerText = '';
                    if(body) body.innerHTML = '';
                    
                    // Detener scanner si estaba activo
                    if(this.html5QrcodeScanner) {
                        this.html5QrcodeScanner.clear().catch(e => console.log(e));
                        this.html5QrcodeScanner = null;
                    }
                }, 300);
            },

        };

        // 4. ROUTER
        // Archivo: script_v8_router_refactored.js
        const Router = {
            go(id) {

                // Buscamos el iframe principal y le enviamos la orden de pausa
                const videoFrame = document.getElementById('main-video-frame');
                if (videoFrame && videoFrame.contentWindow) {
                    videoFrame.contentWindow.postMessage('{"event":"command","func":"pauseVideo","args":""}', '*');
                }

                // 1. GESTIÓN DE SECCIONES (Saneamiento de visibilidad)
                document.querySelectorAll('.app-view').forEach(e => {
                    e.classList.remove('active');
                    e.classList.add('hidden'); // Ocultamos todas para evitar solapamientos
                });

                // 2. ACTIVACIÓN DEL MODO INMERSIVO (Bloqueo de scroll)
                if (id === 'admin') {
                    document.body.classList.add('admin-mode');
                } else {
                    document.body.classList.remove('admin-mode');
                }

                // 3. MOSTRAR SECCIÓN OBJETIVO
                if (id === 'admin') {
                    const adminView = $('#view-admin');
                    adminView.classList.remove('hidden');
                    adminView.classList.add('active'); 
                    Admin.init(); 
                } else {
                    const target = document.getElementById(`view-${id}`) || document.getElementById('view-inicio');
                    if(target) {
                        // AJUSTE AQUÍ: Quitamos "&& id !== 'alumno'"
                        // Ahora el alumno también hará scroll al inicio al entrar, lo cual es correcto.
                        if (id !== 'admin') window.scrollTo(0,0);
                        
                        target.classList.remove('hidden');
                        target.classList.add('active');

                        // AJUSTE: Forzamos el renderizado y aplicamos el acento de color manualmente
                        if (id === 'nosotros') {
                            App.renderNosotros();
                        }

                        if (id === 'agenda') {
                            App.renderAgenda(); 
                        }

                        // Lógica de acento de color para el borde inferior
                        const activeBtn = document.getElementById(`nav-${id}`);
                        if(activeBtn) {
                            activeBtn.classList.add('text-gold', 'border-gold');
                            activeBtn.classList.remove('text-gray-400');
                            // Forzamos el color de la variable CSS para el borde
                            activeBtn.style.borderBottom = `2px solid var(--color-gold)`;
                        }
                    }
                }

                // 4. ACTUALIZACIÓN VISUAL DE BOTONES (Acento de color dinámico)
                document.querySelectorAll('#nav-links button, #mobile-menu button').forEach(btn => {
                    btn.classList.remove('text-gold', 'border-gold');
                    btn.classList.add('text-gray-400');
                    btn.style.borderBottomColor = 'transparent';
                });

                const activeBtn = document.getElementById(`nav-${id}`);
                if(activeBtn) {
                    activeBtn.classList.add('text-gold', 'border-gold');
                    activeBtn.classList.remove('text-gray-400');
                    // Aseguramos que el asento tome la variable definida en DataManager
                    activeBtn.style.borderBottomColor = 'var(--color-gold)';
                }
            },

 
        };

        

 
        // ==========================================
        // 5. ADMIN PANEL (CÓDIGO COMPLETO SIN RECORTES)
        // ==========================================

        const Admin = {
            currentTab: 'dash',
            
            init() { 
                this.renderNav(); 
                // Pequeño delay para asegurar que el DOM del admin está listo
                setTimeout(() => this.renderTab(this.currentTab), 50);
            },

            renderNav() {
                const tabs = [
                    { id: 'dash', icon: 'fa-chart-pie', label: 'Dashboard' },
                    { id: 'web', icon: 'fa-pen-ruler', label: 'Editor Web' },
                    { id: 'nosotros', icon: 'fa-users-gear', label: 'Nosotros' },
                    { id: 'clases', icon: 'fa-person-chalkboard', label: 'Clases' },
                    { id: 'membresias', icon: 'fa-id-card', label: 'Planes' },
                    { id: 'agenda', icon: 'fa-calendar-check', label: 'Agenda' },
                    { id: 'alumnos', icon: 'fa-users', label: 'Alumnos' },
                    { id: 'espacios', icon: 'fa-building', label: 'Espacios' },
                    { id: 'talento', icon: 'fa-star', label: 'Talento' },
                    { id: 'finanzas', icon: 'fa-coins', label: 'Finanzas' },
                    { id: 'config', icon: 'fa-sliders', label: 'Ajustes' }
                ];
                
                const navContainer = $('#admin-nav');
                if(navContainer) {
                    navContainer.innerHTML = tabs.map(t => `
                        <button onclick="Admin.renderTab('${t.id}')" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium text-gray-400 hover:bg-white/5 transition-all border-l-4 border-transparent ${this.currentTab === t.id ? 'border-gold text-white bg-white/5' : ''}">
                            <i class="fa-solid ${t.icon} w-5"></i> ${t.label}
                        </button>
                    `).join('');
                }
            },


            switchTab(id) {
                this.currTab = id;
                
                // 2. Ocultar todas las tabs
                document.querySelectorAll('.admin-tab').forEach(t => t.classList.add('hidden'));
                
                // 3. Buscar o Crear el contenedor del Tab
                let target = document.getElementById(`admin-tab-${id}`);
                
                if (!target) { 
                    // AQUÍ ESTÁ LA CORRECCIÓN: Buscamos tu 'main' existente
                    const main = document.querySelector('#view-admin main');
                    if (main) {
                        main.insertAdjacentHTML('beforeend', `<div id="admin-tab-${id}" class="admin-tab hidden fade-in"></div>`);
                        target = document.getElementById(`admin-tab-${id}`);
                        // Si es nuevo, forzamos el renderizado inicial
                        this.refreshView(id, target); // Pasamos el target para asegurar que pinte
                    } else {
                        console.error("Error Crítico: No se encuentra la etiqueta <main> dentro de #view-admin");
                        return;
                    }
                } else {
                    // Si ya existe, refrescamos el contenido por si hubo cambios
                    this.refreshView(id, target);
                }
                
                // 4. Mostrar
                if(target) target.classList.remove('hidden');

                // 5. Estilos Botones
                document.querySelectorAll('#admin-nav button').forEach(b => {
                    b.classList.remove('bg-gold/10', 'text-gold', 'border-gold');
                    b.classList.add('text-gray-400');
                });
                const btn = document.getElementById(`btn-tab-${id}`);
                if (btn) { 
                    btn.classList.add('bg-gold/10', 'text-gold', 'border-gold'); 
                    btn.classList.remove('text-gray-400'); 
                }
            },





            renderTab(tabId) {

                if (window.innerWidth < 768) {
                    const sidebar = document.querySelector('#view-admin aside');
                    if (sidebar && !sidebar.classList.contains('hidden')) {
                        this.toggleMobileSidebar();
                    }
                }

                this.currentTab = tabId; 
                this.renderNav(); // Actualizar estilos del menú
                
                // Ocultar todas las tabs primero
                document.querySelectorAll('.admin-tab').forEach(t => t.classList.add('hidden'));
                
                // Buscar el contenedor específico
                let target = document.getElementById(`admin-tab-${tabId}`);
                
                // Si no existe, intentar crearlo dentro del main (Fallback de seguridad)
                if (!target) {
                    const main = document.querySelector('#view-admin main');
                    if(main) {
                        main.insertAdjacentHTML('beforeend', `<div id="admin-tab-${tabId}" class="admin-tab hidden"></div>`);
                        target = document.getElementById(`admin-tab-${tabId}`);
                    }
                }

                if (target) {
                    // Mostrar el contenedor
                    target.classList.remove('hidden');
                    
                    // Renderizar contenido solo si está vacío o es dinámico
                    try {
                        if(tabId === 'dash') target.innerHTML = this.genDashboard();
                        else if(tabId === 'web') target.innerHTML = this.renderWebEditor();
                        else if(tabId === 'nosotros') this.renderNosotrosEditor(target); // Pasamos el target directo
                        else if(tabId === 'clases') this.renderClasesEditor(target); // NUEVO ENRUTAMIENTO
                        else if(tabId === 'membresias') this.renderMembresiasEditor(target);
                        else if(tabId === 'agenda') this.renderAgendaEditor(target);
                        else if(tabId === 'alumnos') this.renderAlumnosEditor(target);
                        else if(tabId === 'config') target.innerHTML = this.genConfig();
                        else target.innerHTML = this.genGenericTable(tabId);
                    } catch (e) {
                        console.error(`Error renderizando ${tabId}:`, e);
                        target.innerHTML = `<div class="p-4 text-red-500 border border-red-500 rounded">Error: ${e.message}</div>`;
                    }
                }
            },

            // --- VISTAS GENÉRICAS ---
            genDashboard() {
                const d = DataManager.get().alumnos || [];
                const f = DataManager.get().finanzas || [];
                const totalAlumnos = d.length; 
                const ingresos = f.filter(x => x.type === 'ingreso').reduce((a, b) => a + parseFloat(b.amount || 0), 0);
                return `<h2 class="text-3xl font-display font-bold mb-8">Dashboard</h2><div class="grid md:grid-cols-3 gap-6"><div class="bg-panel p-6 rounded-xl border border-white/10"><div class="text-xs uppercase text-gray-400 font-bold mb-2">Total Alumnos</div><div class="text-4xl font-bold text-white">${totalAlumnos}</div></div><div class="bg-panel p-6 rounded-xl border border-white/10"><div class="text-xs uppercase text-gray-400 font-bold mb-2">Ingresos Mes</div><div class="text-4xl font-bold text-gold">₡${ingresos.toLocaleString()}</div></div><div class="bg-panel p-6 rounded-xl border border-white/10"><div class="text-xs uppercase text-gray-400 font-bold mb-2">Estado</div><div class="text-xl font-bold text-neon">ONLINE</div></div></div>`;
            },

            genGenericTable(key) {
                const data = DataManager.get()[key];
                if(!data || !Array.isArray(data) || data.length === 0) return `<h2 class="text-3xl font-display capitalize mb-6">${key}</h2><p class="text-gray-500">Sin datos.</p><button onclick="Admin.openModal('${key}')" class="btn-galaxy px-4 py-2 rounded text-xs mt-4">CREAR PRIMERO</button>`;
                const cols = Object.keys(data[0]).filter(k => typeof data[0][k] !== 'object');
                return `<div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-display font-bold capitalize">${key}</h2><button class="btn-galaxy px-4 py-2 rounded text-xs" onclick="Admin.openModal('${key}')">AÑADIR</button></div><div class="bg-panel rounded-xl border border-white/10 overflow-hidden overflow-x-auto"><table class="w-full text-left text-sm text-gray-400"><thead class="bg-white/5 text-xs uppercase text-gold"><tr>${cols.map(c=>`<th class="p-4 whitespace-nowrap">${c}</th>`).join('')}<th class="p-4 text-center">Acciones</th></tr></thead><tbody class="divide-y divide-white/5">${data.map(row=>`<tr class="hover:bg-white/5 transition">${cols.map(c=>`<td class="p-4 whitespace-nowrap">${row[c]}</td>`).join('')}<td class="p-4 text-center flex justify-center gap-2"><button onclick="Admin.openModal('${key}',${row.id})" class="text-gray-400 hover:text-white"><i class="fa-solid fa-pen"></i></button><button onclick="Admin.deleteItem('${key}',${row.id})" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-trash"></i></button></td></tr>`).join('')}</tbody></table></div>`;
            },

            genConfig() {
                const c = DataManager.get().config.colors;
                return `<h2 class="text-3xl font-display mb-8">Paleta de Colores</h2><div class="grid md:grid-cols-2 gap-8">${Object.keys(c).map(k=>`<div><label class="admin-label">${k}</label><div class="flex gap-2"><input type="color" value="${c[k]}" oninput="Admin.updColor('${k}',this.value)" class="h-10 w-10 bg-transparent border-none cursor-pointer"><input type="text" class="admin-input uppercase" value="${c[k]}" readonly></div></div>`).join('')}</div>`;
            },
            updColor(k,v) { const d = DataManager.get(); d.config.colors[k]=v; DataManager.save(d); },

            // 1. HELPER DE INPUTS (Negro y IDs correctos)
            inp(id, label, val, area=false) {
                // Estilo negro forzado
                const style = "w-full p-3 bg-[#05060b] border border-white/20 rounded-lg text-white focus:border-gold outline-none text-sm font-mono";
                return `
                    <div class="mb-4">
                        <label class="block text-xs uppercase font-bold text-gray-500 mb-2 tracking-wider">${label}</label>
                        ${area ? 
                            `<textarea id="${id}" class="${style} h-24">${val}</textarea>` : 
                            `<input type="text" id="${id}" class="${style}" value="${val}">`
                        }
                    </div>
                `;
            },

            


            

            // --- PEGAR DENTRO DE ADMIN (Reemplaza la anterior) ---
            saveHeroSettings() {
                // 1. Obtener datos actuales
                const data = DataManager.get();
                
                // 2. Función segura para leer inputs
                const getVal = (id) => {
                    const el = document.getElementById(id);
                    return el ? el.value : '';
                };

                // Funciones de guardar
                data.config.hero.title = getVal('ed-hero-title');
                data.config.hero.subtitle = getVal('ed-hero-sub');
                data.config.hero.bgImage = getVal('ed-hero-img');

                data.config.hero.agendaBg = getVal('ed-agenda-img');
                
                data.config.hero.ctaPrimary.text = getVal('ed-btn1-txt');
                data.config.hero.ctaPrimary.link = getVal('ed-btn1-link');
                
                data.config.hero.ctaSecondary.text = getVal('ed-btn2-txt');
                data.config.hero.ctaSecondary.link = getVal('ed-btn2-link');

                // 4. Guardar y Refrescar
                DataManager.save(data);

                // 2. AGREGA ESTA LÍNEA AQUÍ (Esto fuerza la actualización visual inmediata)
                App.renderPublic();
                
                Swal.fire({
                    title: '¡Guardado!',
                    icon: 'success',
                    background: '#05060b',
                    color: '#fff',
                    confirmButtonColor: '#D4AF37',
                    timer: 1500,
                    showConfirmButton: false
                });
            },


           
           
            renderNosotrosEditor(container) {
                if(!container) container = document.getElementById('admin-tab-nosotros');
                if(!container) return;

                // FORZAMOS LECTURA FRESCA DESDE LA MEMORIA PERSISTENTE
                const data = DataManager.get().config.nosotrosContent;
                
                // ESTILO NEGRO FORZADO (Para eliminar los cuadros blancos)
                const blackStyle = "width: 100%; background-color: #05060b !important; color: white !important; border: 1px solid rgba(255,255,255,0.2); padding: 12px; border-radius: 8px; outline: none; margin-top: 5px;";

                container.innerHTML = `
                    <div class="max-w-5xl mx-auto space-y-8 pb-20 fade-in">
                        <h1 class="text-3xl font-serif font-bold text-white text-center">Gestión "Nosotros"</h1>
                        
                        <div class="bg-panel p-8 rounded-2xl border border-white/10 space-y-6">
                            <h3 class="text-gold font-bold uppercase text-xs border-b border-white/10 pb-2">Narrativa</h3>
                            <div class="grid md:grid-cols-2 gap-6">
                                <div>
                                    <label class="text-xs text-gray-500 uppercase font-bold">Pre-título</label>
                                    <input type="text" id="ed-nos-pre" value="${data.pretitle || ''}" style="${blackStyle}">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-500 uppercase font-bold">Título Principal</label>
                                    <input type="text" id="ed-nos-tit" value="${data.title || ''}" style="${blackStyle}">
                                </div>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 uppercase font-bold">Texto Gigante de Fondo</label>
                                <input type="text" id="ed-nos-bg" value="${data.bgText || 'BOOGALOO'}" style="${blackStyle} letter-spacing: 5px; text-transform: uppercase;">
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 uppercase font-bold">Historia Principal</label>
                                <textarea id="ed-nos-hist" style="${blackStyle} height:100px;">${data.historia || ''}</textarea>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 uppercase font-bold">Cita Destacada</label>
                                <textarea id="ed-nos-cita" style="${blackStyle} height:80px;">${data.cita || ''}</textarea>
                            </div>
                        </div>

                        <div class="bg-panel p-8 rounded-2xl border border-white/10 space-y-4">
                            <div class="flex justify-between items-center">
                                <h3 class="text-neon font-bold uppercase text-xs">Videoteca</h3>
                                <button onclick="Admin.addVideoItem()" class="btn-galaxy px-3 py-1 rounded text-[10px]">+ VIDEO</button>
                            </div>
                            <div class="space-y-3" id="video-list-editor">
                                ${data.videos.map((v, i) => `
                                    <div class="flex flex-col md:flex-row gap-2 items-stretch md:items-center bg-black/40 p-2 rounded-lg border border-white/5 relative">
                                        <span class="text-gray-500 text-xs w-4 hidden md:block">${i+1}</span>
                                        <input type="text" class="w-full md:flex-1 bg-transparent text-xs text-white p-2 border border-white/10 rounded outline-none" value="${v.id}" oninput="Admin.updateVideoArray()" placeholder="ID Youtube">
                                        <input type="text" class="w-full md:flex-1 bg-transparent text-xs text-gray-400 p-2 border border-white/10 rounded outline-none" value="${v.label}" oninput="Admin.updateVideoArray()" placeholder="Etiqueta">
                                        <button onclick="Admin.removeVideoItem(${i})" class="absolute top-2 right-2 md:static text-rose hover:text-white px-2 bg-black/50 md:bg-transparent rounded"><i class="fa-solid fa-trash"></i></button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="bg-panel p-8 rounded-2xl border border-white/10 space-y-4">
                            <div class="flex justify-between items-center">
                                <h3 class="text-gold font-bold uppercase text-xs">Galería (${data.galeria.length} Fotos)</h3>
                                <button onclick="Admin.addGaleriaItem()" class="btn-galaxy px-3 py-1 rounded text-[10px]">+ FOTO</button>
                            </div>
                            <div class="grid grid-cols-1 gap-3" id="galeria-edit-list">
                                ${data.galeria.map((img, i) => `
                                    <div class="flex gap-3 items-center bg-black/40 p-2 rounded-lg border border-white/5">
                                        <img src="${img}" class="w-10 h-10 rounded object-cover border border-white/10 shrink-0">
                                        <input type="text" class="flex-1 bg-transparent text-xs text-white p-1 outline-none" 
                                            value="${img}" 
                                            oninput="this.previousElementSibling.src = this.value; Admin.updateGaleriaArray()">
                                        <button onclick="Admin.removeGaleriaItem(${i})" class="text-rose hover:text-white px-2"><i class="fa-solid fa-trash"></i></button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="bg-panel p-8 rounded-2xl border border-white/10 space-y-4">
                            <div class="flex justify-between items-center">
                                <h3 class="text-rose font-bold uppercase text-xs">Logros</h3>
                                <button onclick="Admin.addLogroItem()" class="btn-galaxy px-3 py-1 rounded text-[10px]">+ LOGRO</button>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="logros-edit-list">
                                ${data.logros.map((l, i) => `
                                    <div class="bg-black/40 p-4 rounded-xl border border-white/5 relative group hover:border-gold/30">
                                        <button onclick="Admin.removeLogroItem(${i})" class="absolute top-2 right-2 text-gray-600 hover:text-rose"><i class="fa-solid fa-xmark"></i></button>
                                        <div class="grid grid-cols-2 gap-2 mb-2">
                                            <input type="text" class="bg-transparent border-b border-white/10 text-gold font-bold text-sm" value="${l.year}" onchange="Admin.updateLogrosArray()">
                                            <select class="bg-black text-gray-400 text-xs text-right border-none outline-none cursor-pointer" onchange="Admin.updateLogrosArray()">
                                                <option value="fa-trophy" ${l.icon==='fa-trophy'?'selected':''}>Trofeo</option>
                                                <option value="fa-globe" ${l.icon==='fa-globe'?'selected':''}>Mundo</option>
                                                <option value="fa-certificate" ${l.icon==='fa-certificate'?'selected':''}>Certificado</option>
                                                <option value="fa-users" ${l.icon==='fa-users'?'selected':''}>Usuarios</option>
                                            </select>
                                        </div>
                                        <input type="text" class="w-full bg-transparent border-b border-white/10 text-white text-sm mb-1" value="${l.title}" onchange="Admin.updateLogrosArray()">
                                        <input type="text" class="w-full bg-transparent border-none text-gray-500 text-xs uppercase" value="${l.sub}" onchange="Admin.updateLogrosArray()">
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <button onclick="Admin.saveNosotrosSettings()" class="btn-galaxy w-full py-4 rounded-xl font-bold shadow-2xl uppercase tracking-widest mt-8">
                            GUARDAR CAMBIOS
                        </button>
                    </div>
                `;
            },
            
            // --- HELPERS ---
            
            addVideoItem() {
                const rows = document.querySelectorAll('#video-list-editor > div');
                const d = DataManager.get();
                
                // 1. CAPTURAR: Guardamos lo que el usuario ya escribió antes de borrar nada
                const currentVideos = Array.from(rows).map(row => {
                    const inputs = row.querySelectorAll('input');
                    return {
                        id: inputs[0].value,
                        label: inputs[1].value,
                        // Mantenemos la miniatura existente o generamos una por defecto si está vacía
                        thumb: inputs[0].value ? `https://img.youtube.com/vi/${inputs[0].value}/0.jpg` : 'https://via.placeholder.com/100'
                    };
                });

                // 2. AGREGAR: Añadimos el nuevo video
                currentVideos.push({id: "dQw4w9WgXcQ", label: "Nuevo Video", thumb: "https://img.youtube.com/vi/dQw4w9WgXcQ/0.jpg"});
                
                // 3. ACTUALIZAR ESTADO
                d.config.nosotrosContent.videos = currentVideos;
                
                DataManager.save(d);
                this.renderNosotrosEditor(); // Recargar editor con datos preservados
                App.renderNosotros();        // Recargar web
            },

            removeVideoItem(i) {
                const d = DataManager.get();
                d.config.nosotrosContent.videos.splice(i, 1);
                DataManager.save(d);
                this.renderNosotrosEditor();
            },

            // --- PEGAR DENTRO DE ADMIN (Reemplaza updateVideoArray) ---
            updateVideoArray() {
                const rows = document.querySelectorAll('#video-list-editor > div');
                const d = DataManager.get();
                
                // MAGIA: Extrae el ID limpio de cualquier link de Youtube
                const getId = (url) => {
                    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
                    const match = url.match(regExp);
                    return (match && match[2].length === 11) ? match[2] : url;
                };

                d.config.nosotrosContent.videos = Array.from(rows).map(row => {
                    const inputs = row.querySelectorAll('input');
                    const rawVal = inputs[0].value; 
                    const vidId = getId(rawVal); // Limpiamos el link aquí mismo

                    return {
                        id: vidId,
                        label: inputs[1].value,
                        // Generamos la miniatura usando el ID limpio
                        thumb: vidId ? `https://img.youtube.com/vi/${vidId}/0.jpg` : 'https://via.placeholder.com/100' 
                    };
                });
                
                DataManager.save(d);
                App.renderNosotros();
            },
            
            
            addGaleriaItem() {
                const d = DataManager.get();
                // Agregamos una imagen de relleno
                d.config.nosotrosContent.galeria.push("https://lh3.googleusercontent.com/d/1gohtlhOlFEEdFHHR23fb5jN4c9RcGsAE");
                DataManager.save(d);
                this.renderNosotrosEditor(); // Recargamos el editor para que aparezca el nuevo campo
                App.renderNosotros(); // Refrescamos la web pública
            },

            removeGaleriaItem(i) {
                const d = DataManager.get();
                d.config.nosotrosContent.galeria.splice(i, 1); // Eliminamos la foto en la posición i
                DataManager.save(d);
                this.renderNosotrosEditor();
                App.renderNosotros();
            },

            // --- PEGAR DENTRO DE ADMIN ---
            updateGaleriaArray() {
                // Selecciona todos los inputs de texto dentro de la lista de galería
                const inputs = document.querySelectorAll('#galeria-edit-list input[type="text"]');
                const d = DataManager.get();
                
                // Crea un nuevo array con los valores actuales
                d.config.nosotrosContent.galeria = Array.from(inputs).map(inp => inp.value);
                
                // Guarda en memoria RAM (sin alerta, guardado silencioso)
                DataManager.save(d);
                
                // IMPORTANTE: No llamamos a renderNosotrosEditor() aquí para no perder el foco del input mientras escribes
                // Solo actualizamos la vista pública
                App.renderNosotros();
            },

            addLogroItem() { const d=DataManager.get(); d.config.nosotrosContent.logros.push({year:"2024",title:"Nuevo",sub:"Detalle",icon:"fa-star",color:"gold"}); DataManager.save(d); this.renderTab('nosotros'); },
            removeLogroItem(i) { const d=DataManager.get(); d.config.nosotrosContent.logros.splice(i,1); DataManager.save(d); this.renderTab('nosotros'); },
            
            // 3. CAPTURA DE DATOS (Adaptada al Select)
            updateLogrosArray() { 
                const containers = document.querySelectorAll('#logros-edit-list > div'); 
                DataManager.get().config.nosotrosContent.logros = Array.from(containers).map(div => { 
                    const inputs = div.querySelectorAll('input');
                    const select = div.querySelector('select'); // Capturamos el select
                    return {
                        year: inputs[0].value, 
                        icon: select.value,     // Leemos del select, no del input
                        title: inputs[1].value, 
                        sub: inputs[2].value, 
                        color: "gold"
                    }; 
                }); 
            },
            

            // --- PEGAR DENTRO DE ADMIN (Reemplaza la función anterior) ---
            saveNosotrosSettings() {
                const d = DataManager.get();
                
                // Función segura para leer
                const val = (id) => { 
                    const el = document.getElementById(id); 
                    return el ? el.value : ''; 
                };

                // Guardar Narrativa (Usando los IDs seguros del AJUSTE 1)
                d.config.nosotrosContent.pretitle = val('ed-nos-pre');
                d.config.nosotrosContent.title    = val('ed-nos-tit');
                d.config.nosotrosContent.historia = val('ed-nos-hist');
                d.config.nosotrosContent.cita     = val('ed-nos-cita');
                d.config.nosotrosContent.bgText   = val('ed-nos-bg');


                // Las listas (galería, videos) ya se actualizaron en memoria con 'update...Array'
                // así que solo guardamos el estado final.

                DataManager.save(d);
                App.renderNosotros(); // Refresco inmediato

                Swal.fire({
                    title: '¡Guardado!',
                    text: 'La sección se ha actualizado correctamente.',
                    icon: 'success',
                    background: '#05060b',
                    color: '#fff',
                    confirmButtonColor: '#D4AF37',
                    timer: 1500,
                    showConfirmButton: false
                });
            },

            // --- TU FUNCIÓN DE SIDEBAR MÓVIL ---
            toggleMobileSidebar() {
                const sidebar = $('#view-admin aside');
                const isHidden = sidebar.classList.contains('hidden');

                if (isHidden) {
                    sidebar.classList.remove('hidden', 'md:flex');
                    sidebar.classList.remove('pt-24'); 
                    sidebar.style.cssText = `display: flex; position: fixed; top: 0; left: 0; width: 280px; height: 100vh; z-index: 120; background: rgba(8, 9, 11, 0.98); backdrop-filter: blur(20px); transform: translateX(-100%); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); padding-top: 5rem;`;
                    setTimeout(() => sidebar.style.transform = 'translateX(0)', 10);
                } else {
                    sidebar.style.transform = 'translateX(-100%)';
                    setTimeout(() => {
                        sidebar.classList.add('hidden', 'md:flex');
                        sidebar.classList.add('pt-24'); 
                        sidebar.style.cssText = '';
                    }, 400);
                }
            },
            
            // CRUD Genérico (MODAL)
            openModal(type, id=null) {
                const data = id ? Store[type].find(i=>i.id===id) : {};
                $('#modal-title').innerText = id ? 'EDITAR' : 'NUEVO';
                const sample = Store[type] && Store[type].length > 0 ? Store[type][0] : { name: '' }; 
                const fields = Object.keys(sample).filter(k => typeof sample[k] !== 'object' && k !== 'id').map(k => 
                    `<div class="mb-4"><label class="admin-label">${k}</label><input type="text" class="admin-input" id="field-${k}" value="${data[k]||''}"></div>`
                ).join('');
                $('#modal-body').innerHTML = fields || `<div class="mb-4"><label class="admin-label">Nombre</label><input type="text" class="admin-input" id="field-name" value=""></div>`;
                $('#admin-modal').classList.remove('hidden');
                setTimeout(()=>{$('#modal-backdrop').classList.remove('opacity-0'); $('#modal-panel').classList.remove('scale-95','opacity-0')},10);
                $('#modal-save-btn').onclick = () => {
                    const newItem = { id: data.id || Date.now() };
                    const keysToCollect = fields ? Object.keys(sample).filter(k => typeof sample[k] !== 'object' && k !== 'id') : ['name'];
                    keysToCollect.forEach(k => { const el = $(`#field-${k}`); if(el) newItem[k] = el.value; });
                    if(!Store[type]) Store[type]=[];
                    const idx = Store[type].findIndex(i=>i.id===newItem.id);
                    if(idx>-1) Store[type][idx]=newItem; else Store[type].push(newItem);
                    DataManager.save(Store); this.closeModal(); this.renderTab(this.currentTab);
                };
            },
            closeModal() { $('#modal-backdrop').classList.add('opacity-0'); $('#modal-panel').classList.add('scale-95','opacity-0'); setTimeout(()=>$('#admin-modal').classList.add('hidden'),300); },
            deleteItem(t, id) { 
                Swal.fire({ title: '¿Eliminar?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#3085d6', confirmButtonText: 'Sí, borrar' }).then((result) => {
                    if (result.isConfirmed) { Store[t]=Store[t].filter(i=>i.id!==id); DataManager.save(Store); this.renderTab(this.currentTab); }
                });
            },

            // 1. HELPER DE INPUTS (Negro y IDs correctos)
            input(id, label, value = '') {
                return `
                    <div class="mb-4">
                        <label class="block text-xs uppercase font-bold text-gray-500 mb-2 tracking-wider">${label}</label>
                        <input type="text" id="${id}" value="${value}" 
                            style="width: 100%; padding: 12px; background-color: #000 !important; color: white !important; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; outline: none;">
                    </div>
                `;
            },

            // 2. EDITOR WEB (Con Listas Desplegables)
            renderWebEditor() {
                const conf = DataManager.get().config;
                // Estilos Negros Forzados
                const blackInput = "width:100%; padding:12px; background-color:#05060b !important; color:#fff !important; border:1px solid rgba(255,255,255,0.2); border-radius:8px; outline:none;";
                
                // Helper para Selects Negros
                const sections = ['inicio', 'nosotros', 'clases', 'membresias', 'agenda', 'alquiler', 'talento'];
                const makeSelect = (id, val) => `
                    <div class="mb-4">
                        <label class="block text-xs uppercase font-bold text-gray-500 mb-2 tracking-wider">Acción</label>
                        <select id="${id}" style="${blackInput} cursor:pointer;">
                            ${sections.map(s => `<option value="${s}" ${s === val ? 'selected' : ''}>Ir a: ${s.toUpperCase()}</option>`).join('')}
                        </select>
                    </div>
                `;

                // Helper para Inputs Negros (Local para esta función)
                const inp = (id, label, value) => `
                    <div class="mb-4">
                        <label class="block text-xs uppercase font-bold text-gray-500 mb-2 tracking-wider">${label}</label>
                        <input type="text" id="${id}" value="${value}" style="${blackInput}">
                    </div>
                `;

                return `
                    <div class="max-w-4xl mx-auto space-y-12 pb-20 fade-in">
                        <h2 class="text-3xl font-display font-bold mb-6 text-white">Editor de Contenido</h2>
                        <div class="bg-panel p-8 rounded-2xl border border-white/10 space-y-6">
                            <h3 class="text-gold font-bold uppercase text-xs mb-6 border-b border-white/10 pb-2">Portada (Hero Section)</h3>

                            ${inp('ed-hero-title', 'Título Principal', conf.hero.title)}
                            ${inp('ed-hero-sub', 'Subtítulo', conf.hero.subtitle)}
                            ${inp('ed-hero-img', 'URL Imagen de Fondo', conf.hero.bgImage)}
                            ${inp('ed-agenda-img', 'Fondo Sección Agenda', conf.hero.agendaBg || '')}

                            <div class="grid md:grid-cols-2 gap-6 pt-6 border-t border-white/10 mt-6">
                                
                                
                                <div class="bg-white/5 p-4 rounded-xl border border-white/5">
                                    <h4 class="text-gold text-[10px] font-bold uppercase mb-3">Botón Principal</h4>
                                    ${inp('ed-btn1-txt', 'Texto', conf.hero.ctaPrimary.text)}
                                    ${makeSelect('ed-btn1-link', conf.hero.ctaPrimary.link)}
                                </div>
                                <div class="bg-white/5 p-4 rounded-xl border border-white/5">
                                    <h4 class="text-neon text-[10px] font-bold uppercase mb-3">Botón Secundario</h4>
                                    ${inp('ed-btn2-txt', 'Texto', conf.hero.ctaSecondary.text)}
                                    ${makeSelect('ed-btn2-link', conf.hero.ctaSecondary.link)}
                                </div>

                                <div class="bg-white/5 p-4 rounded-xl border border-white/5 mt-4 flex justify-between items-center">
                                    <span class="text-xs font-bold text-gray-400 uppercase">Animación de Galería (Auto-Scroll)</span>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="ed-anim-toggle" class="sr-only peer" ${conf.enableAnimations ? 'checked' : ''} onchange="const d=DataManager.get(); d.config.enableAnimations=this.checked; DataManager.save(d); App.renderPublic();">
                                        <div class="w-9 h-5 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-gold"></div>
                                    </label>
                                </div>

                            </div>

                            <div class="bg-rose-900/10 p-4 rounded-xl border border-rose-500/20 mt-4">
                                <label class="text-[10px] text-rose-400 uppercase font-bold block mb-2">Política de Cancelación (Horas)</label>
                                <p class="text-[10px] text-gray-500 mb-2">Tiempo mínimo antes de la clase para cancelar y recuperar el crédito.</p>
                                <input type="number" id="ed-cancel-hours" class="w-full bg-black p-3 rounded text-xs text-white border border-white/10 outline-none focus:border-rose-500" value="${conf.cancellationHours || 12}">
                            </div>

                            <button onclick="Admin.saveHeroSettings()" class="btn-galaxy w-full py-4 rounded-lg font-bold mt-6 uppercase tracking-widest shadow-lg text-black hover:scale-[1.01] transition-transform">
                                GUARDAR CAMBIOS
                            </button>
                        </div>
                    </div>
                `;
            },

            // --- GESTIÓN DE CLASES (NUEVO MÓDULO) ---
            renderClasesEditor(container) {
                if(!container) return;
                const data = DataManager.get().clases || [];
                const blackStyle = "width: 100%; background-color: #05060b !important; color: white !important; border: 1px solid rgba(255,255,255,0.2); padding: 10px; border-radius: 6px; outline: none; font-size: 0.85rem;";

                container.innerHTML = `
                    <div class="max-w-6xl mx-auto pb-20 fade-in">
                        <div class="flex justify-between items-end mb-8">
                            <div>
                                <h1 class="text-3xl font-serif font-bold text-white">Oferta Académica</h1>
                                <p class="text-gray-400 text-sm mt-1">Gestiona los programas educativos activos.</p>
                            </div>
                            <button onclick="Admin.addClaseItem()" class="btn-galaxy px-6 py-3 rounded-lg text-xs font-bold shadow-lg hover:scale-105 transition-transform">+ NUEVA CLASE</button>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="clases-edit-list">
                            ${data.map((c, i) => `
                                <div class="bg-panel p-6 rounded-2xl border border-white/10 group hover:border-gold/30 transition-all relative">
                                    <button onclick="Admin.removeClaseItem(${i})" class="absolute top-4 right-4 text-gray-600 hover:text-rose bg-black/50 w-8 h-8 rounded-full flex items-center justify-center transition-colors z-20"><i class="fa-solid fa-trash text-xs"></i></button>
                                    
                                    <div class="flex gap-4 mb-4">
                                        <div class="w-24 h-24 rounded-lg overflow-hidden border border-white/10 shrink-0 relative group-hover:border-gold/50 transition-colors z-10">
                                            <img src="${c.img}" class="w-full h-full object-cover">
                                            <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity">
                                                <i class="fa-solid fa-image text-white"></i>
                                            </div>
                                            <input type="text" class="absolute inset-0 opacity-0 cursor-pointer main-img-input" value="${c.img}" oninput="this.previousElementSibling.previousElementSibling.src = this.value; Admin.updateClasesArray()">
                                        </div>

                                        <div class="flex-1 space-y-2 relative z-10">
                                            <input type="text" class="bg-transparent text-lg font-bold text-white w-full border-b border-transparent focus:border-gold outline-none placeholder-gray-600 name-input h-10" value="${c.name}" oninput="Admin.updateClasesArray()" placeholder="Nombre de la Clase">
                                            
                                            <div class="flex justify-end">
                                                <label class="flex items-center gap-2 cursor-pointer bg-black/50 px-3 py-1 rounded border border-white/10 hover:border-gold/50 transition-colors">
                                                    <span class="text-[9px] text-gray-400 uppercase font-bold">Visible</span>
                                                    <input type="checkbox" class="accent-success w-3 h-3 toggle-visible" ${c.visible !== false ? 'checked' : ''} onchange="Admin.updateClasesArray()">
                                                </label>
                                            </div>

                                            <div class="flex flex-wrap gap-2 items-center">
                                                <select class="bg-[#05060b] text-[10px] text-neon border border-white/10 rounded px-2 py-1 outline-none uppercase font-bold level-select" onchange="Admin.updateClasesArray()">
                                                    <option value="Principiante" ${c.level==='Principiante'?'selected':''}>Principiante</option>
                                                    <option value="Intermedio" ${c.level==='Intermedio'?'selected':''}>Intermedio</option>
                                                    <option value="Avanzado" ${c.level==='Avanzado'?'selected':''}>Avanzado</option>
                                                    <option value="Open Level" ${c.level==='Open Level'?'selected':''}>Open Level</option>
                                                </select>
                                                
                                                <div class="flex items-center gap-2 bg-black/40 px-2 py-1 rounded border border-white/5">
                                                    <span class="text-[9px] text-gray-500 uppercase font-bold">Cupo:</span>
                                                    <input type="number" class="bg-transparent text-xs text-white w-8 text-center outline-none cap-input" value="${c.defaultCapacity || 25}" oninput="Admin.updateClasesArray()">
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-2 flex justify-end">
                                        <label class="flex items-center gap-1 cursor-pointer">
                                            <input type="checkbox" class="accent-gold w-3 h-3 toggle-price" ${c.showPrice ? 'checked' : ''} onchange="Admin.updateClasesArray()">
                                            <span class="text-[10px] text-gold uppercase font-bold">Mostrar Precio</span>
                                        </label>
                                    </div>

                                    <div class="mt-2 bg-black/20 p-2 rounded border border-white/5 relative z-10">
                                        <div class="flex justify-between items-center mb-2 pb-2 border-b border-white/5">
                                            <label class="flex items-center gap-2 cursor-pointer">
                                                <input type="checkbox" class="accent-neon w-3 h-3 toggle-schedule" ${c.showSchedule !== false ? 'checked' : ''} onchange="Admin.updateClasesArray()">
                                                <span class="text-[9px] text-gray-500 uppercase font-bold">Mostrar en Web</span>
                                            </label>
                                            <button onclick="Admin.addSchedule(${i})" class="text-[9px] bg-neon/10 text-neon hover:bg-neon hover:text-black px-2 py-0.5 rounded transition-colors font-bold">+ HORARIO</button>
                                        </div>
                                        
                                        <div class="space-y-1 schedule-container">
                                            ${(c.schedules || []).map((s, sIdx) => `
                                                <div class="flex gap-2 items-center group/sch">
                                                    <select class="bg-[#05060b] text-[10px] text-gray-300 border border-white/10 rounded px-1 outline-none sch-day" onchange="Admin.updateClasesArray()">
                                                        <option value="1" ${s.day==1?'selected':''}>Lun</option>
                                                        <option value="2" ${s.day==2?'selected':''}>Mar</option>
                                                        <option value="3" ${s.day==3?'selected':''}>Mié</option>
                                                        <option value="4" ${s.day==4?'selected':''}>Jue</option>
                                                        <option value="5" ${s.day==5?'selected':''}>Vie</option>
                                                        <option value="6" ${s.day==6?'selected':''}>Sáb</option>
                                                        <option value="0" ${s.day==0?'selected':''}>Dom</option>
                                                    </select>
                                                    <input type="time" class="bg-[#05060b] text-[10px] text-white border border-white/10 rounded px-1 outline-none sch-time" value="${s.time}" oninput="Admin.updateClasesArray()">
                                                    <button onclick="Admin.removeSchedule(${i}, ${sIdx})" class="text-rose hover:text-white px-1"><i class="fa-solid fa-times text-[10px]"></i></button>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-2 gap-2 mt-2 relative z-10">
                                        <div class="relative">
                                            <span class="absolute left-2 top-1.5 text-[10px] text-gray-500">CRC</span>
                                            <input type="text" class="w-full bg-[#05060b] text-xs text-white p-1.5 pl-8 rounded border border-white/10 outline-none price-crc-input" value="${c.priceCRC || ''}" oninput="Admin.updateClasesArray()" placeholder="25000">
                                        </div>
                                        <div class="relative">
                                            <span class="absolute left-2 top-1.5 text-[10px] text-gray-500">USD</span>
                                            <input type="text" class="w-full bg-[#05060b] text-xs text-white p-1.5 pl-8 rounded border border-white/10 outline-none price-usd-input" value="${c.priceUSD || ''}" oninput="Admin.updateClasesArray()" placeholder="50">
                                        </div>
                                    </div>

                                    <div class="mt-3 bg-black/20 p-2 rounded border border-white/5 relative z-10">
                                        <div class="flex justify-between items-center mb-2">
                                            <label class="text-[9px] text-gray-500 uppercase font-bold">Galería de Imágenes</label>
                                            <button onclick="Admin.addClaseImg(${i})" class="text-[9px] bg-white/10 hover:bg-gold hover:text-black text-white px-2 py-0.5 rounded transition-colors">+ FOTO</button>
                                        </div>
                                        <div class="space-y-1 gallery-container">
                                            ${(c.gallery || [c.img]).map((imgUrl, imgIdx) => `
                                                <div class="flex gap-2 items-center group/img">
                                                    <img src="${imgUrl}" class="w-6 h-6 rounded object-cover border border-white/10">
                                                    <input type="text" class="flex-1 bg-transparent text-[10px] text-gray-400 border-b border-white/5 focus:border-gold outline-none gal-url-input" value="${imgUrl}" oninput="this.previousElementSibling.src = this.value; Admin.updateClasesArray()">
                                                    <button onclick="Admin.removeClaseImg(${i}, ${imgIdx})" class="text-gray-600 hover:text-rose"><i class="fa-solid fa-times text-xs"></i></button>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>

                                    <div class="mt-2 relative z-10">
                                        <textarea class="desc-input w-full bg-black/30 text-gray-400 text-sm p-3 rounded-lg border border-white/5 outline-none focus:border-gold/30 resize-none h-20 mb-2" oninput="Admin.updateClasesArray()" placeholder="Descripción Corta (Para la tarjeta)...">${c.desc || ''}</textarea>
                                        
                                        <label class="text-[10px] uppercase font-bold text-gold tracking-widest mb-1 block">Detalles del Programa (Inclusiones, Requisitos)</label>
                                        <textarea class="detail-input w-full bg-black/50 text-gray-300 text-sm p-4 rounded-lg border border-white/10 outline-none focus:border-gold/50 resize-y h-40 font-mono leading-relaxed" oninput="Admin.updateClasesArray()" placeholder="Escribe aquí todo el detalle. Usa guiones (-) para listas.">${c.details || ''}</textarea>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            },

            addClaseItem() {
                const d = DataManager.get();
                if(!d.clases) d.clases = [];
                d.clases.push({
                    id: Date.now(),
                    name: "Nueva Clase",
                    level: "Principiante",
                    schedule: "Por definir",
                    img: "https://images.unsplash.com/photo-1545959570-a9477eb37265?auto=format&fit=crop&w=400",
                    desc: "Descripción del nuevo programa académico."
                });
                DataManager.save(d);
                this.renderClasesEditor(document.getElementById('admin-tab-clases'));
                App.renderPublic();
            },

            removeClaseItem(index) {
                const d = DataManager.get();
                d.clases.splice(index, 1);
                DataManager.save(d);
                this.renderClasesEditor(document.getElementById('admin-tab-clases'));
                App.renderPublic();
            },
            
            // Funciones para gestionar la galería interna de cada clase
            addClaseImg(classIdx) {
                const d = DataManager.get();
                if(!d.clases[classIdx].gallery) d.clases[classIdx].gallery = [d.clases[classIdx].img];
                d.clases[classIdx].gallery.push("https://lh3.googleusercontent.com/d/1gohtlhOlFEEdFHHR23fb5jN4c9RcGsAE"); // Placeholder
                DataManager.save(d);
                this.renderClasesEditor(document.getElementById('admin-tab-clases'));
                App.renderPublic();
            },

            removeClaseImg(classIdx, imgIdx) {
                const d = DataManager.get();
                // Verificamos que exista la galería
                if(d.clases[classIdx].gallery) {
                    // 1. Eliminar la imagen seleccionada del array
                    d.clases[classIdx].gallery.splice(imgIdx, 1);
                    
                    // 2. LÓGICA DE RELEVO:
                    // Si quedan imágenes, la nueva portada (img) es AUTOMÁTICAMENTE la primera de la lista
                    if (d.clases[classIdx].gallery.length > 0) {
                        d.clases[classIdx].img = d.clases[classIdx].gallery[0];
                    } else {
                        // Si borró todas, ponemos un placeholder o vacío
                        d.clases[classIdx].img = "https://lh3.googleusercontent.com/d/1gohtlhOlFEEdFHHR23fb5jN4c9RcGsAE"; 
                    }

                    // 3. Guardar y Re-renderizar todo para ver el cambio visual al instante
                    DataManager.save(d);
                    this.renderClasesEditor(document.getElementById('admin-tab-clases'));
                    App.renderPublic();
                }
            },

            updateClasesArray() {
                const container = document.getElementById('clases-edit-list');
                const cards = container.querySelectorAll('.bg-panel'); 
                const d = DataManager.get();
                
                d.clases = Array.from(cards).map((card, index) => {
                    const originalId = d.clases[index] ? d.clases[index].id : Date.now();
                    
                    // 1. CAPTURA DE IMÁGENES
                    const galInputs = card.querySelectorAll('.gal-url-input');
                    const galleryArr = Array.from(galInputs).map(inp => inp.value).filter(s => s.trim() !== "");
                    
                    // LÓGICA MAESTRA: La imagen principal es SIEMPRE la foto #1 de la galería
                    // Si la galería está vacía, usamos el valor del input oculto como respaldo
                    const mainImg = galleryArr.length > 0 ? galleryArr[0] : card.querySelector('.main-img-input').value;

                    // --- ACTUALIZACIÓN VISUAL EN TIEMPO REAL (ADMIN) ---
                    // Buscamos la primera etiqueta <img> de la tarjeta (que es la preview grande)
                    const previewImg = card.querySelector('img'); 
                    // Si la imagen cambió, actualizamos el SRC visualmente ahora mismo
                    if(previewImg && previewImg.src !== mainImg) {
                        previewImg.src = mainImg;
                    }

                    const schContainer = card.querySelector('.schedule-container');
                    const schedules = Array.from(schContainer.querySelectorAll('.group\\/sch')).map(row => ({
                        day: parseInt(row.querySelector('.sch-day').value),
                        time: row.querySelector('.sch-time').value
                    }));

                    // ---------------------------------------------------

                    // 2. RETORNO DE DATOS
                    return {
                        id: originalId,
                        img: mainImg,
                        gallery: galleryArr.length > 0 ? galleryArr : [mainImg],
                        
                        name: card.querySelector('.name-input').value,
                        visible: card.querySelector('.toggle-visible').checked,

                        level: card.querySelector('.level-select').value,

                        schedules: schedules,
                        showSchedule: card.querySelector('.toggle-schedule').checked,
                        defaultCapacity: parseInt(card.querySelector('.cap-input').value) || 25,

                        priceCRC: card.querySelector('.price-crc-input').value,
                        priceUSD: card.querySelector('.price-usd-input').value,
                        showPrice: card.querySelector('.toggle-price').checked,

                        desc: card.querySelector('.desc-input').value,
                        details: card.querySelector('.detail-input').value
                    };
                });
                
                // 3. GUARDADO Y REFRESCO
                DataManager.save(d); 
                App.renderPublic();  
            },

            // --- GESTIÓN DE MEMBRESÍAS (NUEVO MÓDULO PREMIUM) ---
            renderMembresiasEditor(container) {
                if(!container) return;
                const data = DataManager.get().membresias || [];
                
                container.innerHTML = `
                    <div class="max-w-6xl mx-auto pb-20 fade-in">
                        <div class="flex justify-between items-end mb-8">
                            <div>
                                <h1 class="text-3xl font-serif font-bold text-white">Planes de Inversión</h1>
                                <p class="text-gray-400 text-sm mt-1">Configura los paquetes y suscripciones.</p>
                            </div>
                            <button onclick="Admin.addMembresiaItem()" class="btn-galaxy px-6 py-3 rounded-lg text-xs font-bold shadow-lg hover:scale-105 transition-transform">+ NUEVO PLAN</button>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="membresias-edit-list">
                            ${data.map((m, i) => `
                                <div class="bg-panel p-6 rounded-2xl border border-white/10 group hover:border-gold/30 transition-all relative flex flex-col h-full">
                                    <button onclick="Admin.removeMembresiaItem(${i})" class="absolute top-4 right-4 text-gray-600 hover:text-rose bg-black/50 w-8 h-8 rounded-full flex items-center justify-center transition-colors z-10"><i class="fa-solid fa-trash text-xs"></i></button>
                                    
                                    <div class="mb-4 text-center border-b border-white/5 pb-4">
                                        <input type="text" class="bg-transparent text-xl font-serif font-bold text-white w-full text-center border-b border-transparent focus:border-gold outline-none placeholder-gray-600 m-name" value="${m.name}" oninput="Admin.updateMembresiasArray()" placeholder="Nombre del Plan">
                                        
                                        <div class="grid grid-cols-2 gap-2 mt-4">
                                            <div class="relative">
                                                <span class="absolute left-2 top-1.5 text-[10px] text-gray-500">CRC</span>
                                                <input type="text" class="w-full bg-[#05060b] text-xs text-white p-1.5 pl-8 rounded border border-white/10 outline-none m-price-crc" value="${m.priceCRC || ''}" oninput="Admin.updateMembresiasArray()" placeholder="35000">
                                            </div>
                                            <div class="relative">
                                                <span class="absolute left-2 top-1.5 text-[10px] text-gray-500">USD</span>
                                                <input type="text" class="w-full bg-[#05060b] text-xs text-white p-1.5 pl-8 rounded border border-white/10 outline-none m-price-usd" value="${m.priceUSD || ''}" oninput="Admin.updateMembresiasArray()" placeholder="70">
                                            </div>
                                        </div>
                                        
                                        <div class="relative mt-2">
                                            <span class="absolute left-2 top-1.5 text-[10px] text-gray-500">CLASES/SEM</span>
                                            <input type="number" class="w-full bg-[#05060b] text-xs text-white p-1.5 pl-20 rounded border border-white/10 outline-none m-limit" value="${m.weeklyLimit || 7}" oninput="Admin.updateMembresiasArray()">
                                        </div>
                                        <div class="mt-3 flex justify-center items-center gap-2">
                                            <label class="flex items-center gap-2 cursor-pointer bg-white/5 px-3 py-1 rounded-full border border-white/5 hover:border-gold/30 transition-colors">
                                                <input type="checkbox" class="accent-gold w-3 h-3 m-popular" ${m.popular ? 'checked' : ''} onchange="Admin.updateMembresiasArray()">
                                                <span class="text-[10px] text-gray-400 uppercase font-bold">Destacar como Popular</span>
                                            </label>
                                        </div>
                                    </div>




                                    <div class="flex-1 space-y-4">
                                        <div>
                                            <label class="text-[9px] text-gold uppercase font-bold block mb-1">Resumen (Tarjeta)</label>
                                            <textarea class="w-full bg-black/30 text-gray-300 text-xs p-3 rounded-lg border border-white/5 outline-none focus:border-gold/30 resize-none h-24 font-mono m-summary" oninput="Admin.updateMembresiasArray()" placeholder="- Item Resumen">${m.summary || ''}</textarea>
                                        </div>
                                        <div>
                                            <label class="text-[9px] text-neon uppercase font-bold block mb-1">Detalle Completo (Modal)</label>
                                            <textarea class="w-full bg-black/30 text-gray-300 text-xs p-3 rounded-lg border border-white/5 outline-none focus:border-gold/30 resize-none h-32 font-mono m-details" oninput="Admin.updateMembresiasArray()" placeholder="* TÍTULO&#10;- Detalle">${m.details || ''}</textarea>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-4 pt-4 border-t border-white/5">
                                        <label class="text-[9px] text-gray-600 uppercase font-bold block mb-1">Nota Legal</label>
                                        <input type="text" class="w-full bg-transparent text-[10px] text-gray-500 border-b border-white/5 focus:border-gold outline-none m-legal" value="${m.legal || ''}" oninput="Admin.updateMembresiasArray()" placeholder="Letra chica...">
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            },

            addMembresiaItem() {
                const d = DataManager.get();
                if(!d.membresias) d.membresias = [];
                d.membresias.push({
                    id: Date.now(),
                    name: "Nuevo Plan",
                    priceCRC: "0",
                    priceUSD: "0",
                    summary: "- Beneficio Clave",
                    details: "* DETALLES\n- Descripción completa",
                    popular: false
                });
                DataManager.save(d);
                this.renderMembresiasEditor(document.getElementById('admin-tab-membresias'));
                App.renderPublic();
            },

            removeMembresiaItem(index) {
                const d = DataManager.get();
                d.membresias.splice(index, 1);
                DataManager.save(d);
                this.renderMembresiasEditor(document.getElementById('admin-tab-membresias'));
                App.renderPublic();
            },

            updateMembresiasArray() {
                const container = document.getElementById('membresias-edit-list');
                const cards = container.querySelectorAll('.bg-panel');
                const d = DataManager.get();
                
                d.membresias = Array.from(cards).map((card, index) => {
                    const originalId = d.membresias[index] ? d.membresias[index].id : Date.now();
                    return {
                        id: originalId,
                        name: card.querySelector('.m-name').value,
                        priceCRC: card.querySelector('.m-price-crc').value,
                        priceUSD: card.querySelector('.m-price-usd').value,
                        popular: card.querySelector('.m-popular').checked,
                        summary: card.querySelector('.m-summary').value,
                        details: card.querySelector('.m-details').value,
                        legal: card.querySelector('.m-legal').value,
                        weeklyLimit: parseInt(card.querySelector('.m-limit').value) || 7
                    };
                });
                
                DataManager.save(d);
                App.renderPublic();
            },

            // --- GESTIÓN AGENDA (FIXED & STYLED) ---
            renderAgendaEditor(container) {
                if(!container) return;
                const sesiones = DataManager.get().sesiones || [];
                const todayStart = new Date().setHours(0,0,0,0);
                const upcoming = sesiones.filter(s => new Date(s.date) >= todayStart).sort((a,b) => new Date(a.date) - new Date(b.date));

                container.innerHTML = `
                    <div class="max-w-6xl mx-auto pb-20 fade-in">
                        <div class="flex flex-col md:flex-row justify-between items-end mb-8 gap-4">
                            <div>
                                <h1 class="text-3xl font-serif font-bold text-white">Agenda Maestra</h1>
                                <p class="text-gray-400 text-sm mt-1">Gestión operativa y contenido.</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="Admin.addCustomSession()" class="bg-white/10 hover:bg-gold hover:text-black text-white px-4 py-3 rounded-lg text-xs font-bold transition-colors">+ EXTRA</button>
                                <button onclick="Admin.seedAgenda()" class="btn-galaxy px-6 py-3 rounded-lg text-xs font-bold shadow-lg hover:scale-105 transition-transform"><i class="fa-solid fa-sync mr-2"></i> SINCRONIZAR MES</button>
                            </div>
                        </div>

                        <div class="space-y-3">
                            ${upcoming.map(s => {
                                const clasePadre = s.claseId ? DataManager.get().clases.find(c => c.id === s.claseId) : null;
                                const nombre = s.customName || (clasePadre ? clasePadre.name : 'Evento');
                                const reservados = (DataManager.get().reservas || []).filter(r => r.sesionId === s.id).length;
                                const isToday = new Date(s.date).toDateString() === new Date().toDateString();
                                const borderClass = isToday ? 'border-gold bg-gold/5' : 'border-white/10 bg-panel';

                                return `
                                <div class="p-4 rounded-xl border ${borderClass} flex flex-col md:flex-row items-center gap-4 group hover:bg-white/5 transition-colors relative">
                                    <button onclick="Admin.deleteSession(${s.id})" class="absolute top-2 right-2 text-white/20 hover:text-rose transition-colors z-10"><i class="fa-solid fa-times"></i></button>

                                    <div class="flex items-center gap-6 flex-1 w-full">
                                        <div class="flex flex-col gap-2 min-w-[110px]">
                                            <div class="flex items-center gap-3 text-gold relative input-wrapper group/date">
                                                <i class="fa-regular fa-calendar text-lg group-hover/date:scale-110 transition-transform pointer-events-none"></i>
                                                <input type="date" class="bg-transparent text-[11px] text-gold font-bold border-none outline-none w-full uppercase cursor-pointer" 
                                                    value="${new Date(s.date).toISOString().split('T')[0]}" 
                                                    onchange="Admin.updateSessionField(${s.id}, 'date', this.value)">
                                            </div>
                                            
                                            <div class="flex items-center gap-3 text-white relative input-wrapper group/time">
                                                <i class="fa-regular fa-clock text-gold text-lg group-hover/time:scale-110 transition-transform pointer-events-none"></i>
                                                <input type="time" class="bg-transparent text-sm font-mono text-white border-none outline-none w-full cursor-pointer" 
                                                    value="${s.time}" 
                                                    onchange="Admin.updateSessionField(${s.id}, 'time', this.value)">
                                            </div>
                                        </div>
                                        
                                        <div class="flex-1 border-l border-white/10 pl-6">
                                            
                                            <div class="mb-2">
                                                <select onchange="Admin.linkSessionClass(${s.id}, this.value)" class="bg-[#05060b] text-xs text-gold border border-white/10 rounded px-2 py-1 outline-none w-full max-w-[200px] cursor-pointer hover:border-gold transition-colors">
                                                    <option value="custom" ${!s.claseId ? 'selected' : ''}>★ Evento Personalizado</option>
                                                    ${DataManager.get().clases.map(c => `
                                                        <option value="${c.id}" ${s.claseId === c.id ? 'selected' : ''}>${c.name}</option>
                                                    `).join('')}
                                                </select>
                                            </div>

                                            ${!s.claseId ? `
                                                <input type="text" class="bg-transparent text-lg font-bold text-white border-b border-white/10 focus:border-gold outline-none w-full placeholder-gray-500 mb-1" value="${s.customName || ''}" placeholder="Escribe el nombre del evento..." onchange="Admin.updateSessionField(${s.id}, 'customName', this.value)">
                                            ` : `
                                                <h3 class="text-lg font-bold text-white mb-1">${DataManager.get().clases.find(c=>c.id===s.claseId)?.name || 'Clase'}</h3>
                                            `}
                                            
                                            <div class="flex items-center gap-3 mt-1">
                                                <div class="flex items-center gap-1 bg-black/40 px-2 py-1 rounded border border-white/5">
                                                    <span class="text-[9px] text-gray-500 uppercase">Cupo</span>
                                                    <input type="number" class="bg-transparent text-xs text-white w-8 text-center outline-none" value="${s.capacity}" onchange="Admin.updateSessionField(${s.id}, 'capacity', this.value)">
                                                </div>
                                                <span class="text-[10px] text-neon uppercase tracking-wider font-bold">Inscritos: ${reservados}</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="flex gap-2 shrink-0">
                                        <button onclick="Admin.manageAttendance(${s.id})" class="bg-white/10 hover:bg-neon hover:text-black text-white w-10 h-10 rounded-lg transition-colors flex items-center justify-center tooltip" title="Lista de Asistencia">
                                            <i class="fa-solid fa-users"></i>
                                        </button>
                                        <button onclick="Admin.manageMedia(${s.id})" class="bg-white/10 hover:bg-rose hover:text-white text-white w-10 h-10 rounded-lg transition-colors flex items-center justify-center tooltip" title="Contenido Multimedia">
                                            <i class="fa-solid fa-photo-film"></i>
                                        </button>
                                        <button onclick="Admin.projectQR('${s.qrToken}', '${nombre}')" class="bg-white/10 hover:bg-white hover:text-black text-white w-10 h-10 rounded-lg transition-colors flex items-center justify-center tooltip" title="QR Pantalla Completa">
                                            <i class="fa-solid fa-qrcode"></i>
                                        </button>
                                    </div>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            },

            // 1. MODAL DE ASISTENCIA (SEPARADO)
            manageAttendance(id) {
                const s = DataManager.get().sesiones.find(x => x.id === id);
                const nombre = s.customName || (s.claseId ? DataManager.get().clases.find(c => c.id === s.claseId).name : 'Evento');
                
                // Aseguramos que reservas esté inicializado para evitar el error del filter
                const allReservas = DataManager.get().reservas || [];
                const reservas = allReservas.filter(r => r.sesionId === s.id);

                const html = `
                    <div class="bg-black/50 rounded-xl border border-white/10 overflow-hidden">
                        <div class="p-3 border-b border-white/10 bg-white/5 flex justify-between">
                            <span class="text-xs text-gray-400 uppercase font-bold">Alumno</span>
                            <span class="text-xs text-gray-400 uppercase font-bold">Estado</span>
                        </div>
                        <ul class="max-h-60 overflow-y-auto custom-scrollbar p-2 space-y-1">
                            ${reservas.length === 0 ? '<li class="text-gray-600 text-xs text-center py-4">Sin inscripciones</li>' : ''}
                            ${reservas.map(r => {
                                const alumno = DataManager.get().alumnos.find(a => a.id == r.alumnoId);
                                return `<li class="flex justify-between items-center p-2 rounded hover:bg-white/5">
                                    <span class="text-sm text-white">${alumno ? alumno.name : 'Invitado'}</span>
                                    <span class="px-2 py-0.5 rounded text-[9px] font-bold ${r.asistencia ? 'bg-success/20 text-success' : 'bg-white/5 text-gray-500'}">${r.asistencia ? 'CONFIRMADO' : 'PENDIENTE'}</span>
                                </li>`;
                            }).join('')}
                        </ul>
                    </div>
                `;
                
                $('#modal-title').innerText = nombre;
                $('#modal-subtitle').innerText = "LISTA DE ASISTENCIA";
                $('#modal-body').innerHTML = html;
                $('#modal-save-btn').classList.add('hidden'); 
                $('#admin-modal').classList.remove('hidden');
                setTimeout(()=>{$('#modal-backdrop').classList.remove('opacity-0'); $('#modal-panel').classList.remove('scale-95','opacity-0')},10);
            },

            // 2. MODAL DE MEDIA (SEPARADO)
            manageMedia(id) {
                const s = DataManager.get().sesiones.find(x => x.id === id);
                
                const html = `
                    <div class="space-y-4">
                        <div class="bg-blue-900/10 p-4 rounded-xl border border-blue-500/20">
                            <label class="text-[10px] text-blue-400 uppercase font-bold block mb-2"><i class="fa-brands fa-google-drive mr-1"></i> Carpeta de Fotos (Drive)</label>
                            <input type="text" id="sess-media-photo" class="w-full bg-black p-3 rounded text-xs text-white border border-white/10 focus:border-blue-500 outline-none" value="${s.media?.photos?.[0] || ''}" placeholder="https://drive.google.com/...">
                        </div>
                        <div class="bg-red-900/10 p-4 rounded-xl border border-red-500/20">
                            <label class="text-[10px] text-red-400 uppercase font-bold block mb-2"><i class="fa-brands fa-youtube mr-1"></i> Video de Clase (Youtube)</label>
                            <input type="text" id="sess-media-video" class="w-full bg-black p-3 rounded text-xs text-white border border-white/10 focus:border-red-500 outline-none" value="${s.media?.videos?.[0] || ''}" placeholder="https://youtube.com/...">
                        </div>
                        <button onclick="Admin.saveSessionMedia(${s.id})" class="btn-galaxy w-full py-3 rounded-lg text-xs font-bold shadow-lg">GUARDAR CONTENIDO</button>
                    </div>
                `;
                
                $('#modal-title').innerText = "Multimedia";
                $('#modal-subtitle').innerText = "Compartir con alumnos";
                $('#modal-body').innerHTML = html;
                $('#modal-save-btn').classList.add('hidden'); 
                $('#admin-modal').classList.remove('hidden');
                setTimeout(()=>{$('#modal-backdrop').classList.remove('opacity-0'); $('#modal-panel').classList.remove('scale-95','opacity-0')},10);
            },

            // MOTOR DE SINCRONIZACIÓN INTELIGENTE V3.0
            seedAgenda() {
                const d = DataManager.get();
                const clases = d.clases || [];
                let existing = d.sesiones || [];
                const reservas = d.reservas || [];
                
                // FECHAS DE CONTROL
                const today = new Date();
                today.setHours(0,0,0,0); // Inicio del día de hoy

                // ======================================================
                // FASE 1: LIMPIEZA INTELIGENTE (PRUNING)
                // ======================================================
                // Regla: Solo borramos sesiones FUTURAS que:
                // 1. Fueron creadas automáticamente (auto: true)
                // 2. Pertenecen a una clase que AHORA está oculta (visible: false) o eliminada.
                // 3. CRÍTICO: NO TIENEN RESERVAS (Si hay alumnos, se respeta).
                
                const initialCount = existing.length;
                
                existing = existing.filter(s => {
                    const sessionDate = new Date(s.date);
                    
                    // A. INMUTABILIDAD DEL PASADO: Si ya pasó, se queda.
                    if (sessionDate < today) return true;

                    // B. PROTECCIÓN MANUAL: Si es custom/extra (no tiene flag auto), se queda.
                    if (s.auto !== true) return true;

                    // C. ANÁLISIS DE LA CLASE MADRE
                    const parentClass = clases.find(c => c.id === s.claseId);
                    
                    // Si la clase madre existe Y es visible, la sesión es válida. Se queda.
                    if (parentClass && parentClass.visible !== false) return true;

                    // D. PROTECCIÓN DE RESERVAS (El "Freno de Emergencia")
                    // Llegamos aquí si la clase fue borrada u ocultada.
                    // Verificamos si hay alumnos inscritos.
                    const inscritos = reservas.filter(r => r.sesionId === s.id).length;
                    
                    if (inscritos > 0) {
                        // ¡ALERTA! Hay alumnos. NO BORRAR.
                        // (Opcional: Podríamos quitarle el flag 'auto' para que se vuelva manual y permanente)
                        return true; 
                    }

                    // Si llegamos aquí: Es futura, automática, de clase oculta y SIN alumnos.
                    // ADIÓS.
                    return false;
                });

                const deletedCount = initialCount - existing.length;

                // ======================================================
                // FASE 2: SEMBRADO (SEEDING)
                // ======================================================
                // Regla: Solo generamos para clases VISIBLES en los huecos vacíos.
                
                let addedCount = 0;
                const visibleClasses = clases.filter(c => c.visible !== false);
                const daysMap = { 'domingo': 0, 'lunes': 1, 'martes': 2, 'miércoles': 3, 'miercoles': 3, 'jueves': 4, 'viernes': 5, 'sábado': 6, 'sabado': 6 }; // Fallback para legacy
                
                // Generar próximos 30 días
                for (let i = 0; i < 30; i++) {
                    const checkDate = new Date(today);
                    checkDate.setDate(today.getDate() + i);
                    const dayOfWeek = checkDate.getDay(); // 0-6

                    visibleClasses.forEach(c => {
                        // Soporte Dual: schedules (nuevo array) o schedule (viejo string)
                        let activeSchedules = [];
                        
                        if (c.schedules && c.schedules.length > 0) {
                            // Usar sistema nuevo
                            activeSchedules = c.schedules.filter(sch => sch.day === dayOfWeek);
                        } else if (c.schedule) {
                            // Fallback sistema viejo (por si acaso)
                            const parts = c.schedule.split(' ');
                            const dayName = parts[0].toLowerCase();
                            if (daysMap[dayName] === dayOfWeek) {
                                activeSchedules.push({ time: parts.slice(1).join(' ') });
                            }
                        }

                        activeSchedules.forEach(sch => {
                            // VERIFICAR DUPLICADOS
                            // ¿Existe ya una sesión de esta clase, en esta fecha y hora?
                            const duplicate = existing.some(s => 
                                s.claseId === c.id && 
                                new Date(s.date).toDateString() === checkDate.toDateString() &&
                                s.time === sch.time
                            );

                            if (!duplicate) {
                                existing.push({
                                    id: Date.now() + Math.random(), 
                                    claseId: c.id,
                                    date: checkDate.toISOString(), 
                                    time: sch.time, 
                                    capacity: c.defaultCapacity || 25, 
                                    qrToken: 'SB-' + Math.random().toString(36).substr(2, 9).toUpperCase(),
                                    media: { photos: [], videos: [] },
                                    auto: true // <--- MARCA DE AGUA: Creado por el robot
                                });
                                addedCount++;
                            }
                        });
                    });
                }

                // ======================================================
                // FASE 3: GUARDADO Y REPORTE
                // ======================================================
                
                // Ordenar cronológicamente antes de guardar
                d.sesiones = existing.sort((a,b) => new Date(a.date) - new Date(b.date));
                DataManager.save(d);
                this.renderAgendaEditor(document.getElementById('admin-tab-agenda'));

                // Mensaje Inteligente
                let msg = '';
                if (addedCount === 0 && deletedCount === 0) msg = 'La agenda ya está perfectamente sincronizada.';
                else {
                    if (deletedCount > 0) msg += `Se limpiaron ${deletedCount} sesiones vacías de clases ocultas.<br>`;
                    if (addedCount > 0) msg += `Se programaron ${addedCount} nuevas sesiones futuras.`;
                }

                Swal.fire({ 
                    title: 'Sincronización Inteligente', 
                    html: msg, // Usamos HTML para saltos de linea
                    icon: 'success', 
                    background: '#05060b', 
                    color: '#fff', 
                    confirmButtonColor: '#D4AF37' 
                });
            },


            addCustomSession() {
                const d = DataManager.get();
                d.sesiones.push({
                    id: Date.now(),
                    claseId: null, 
                    customName: "Evento Especial",
                    date: new Date().toISOString(),
                    time: "19:00",
                    capacity: 20,
                    qrToken: 'SB-' + Math.random().toString(36).substr(2, 9).toUpperCase(),
                    media: { photos: [], videos: [] },
                    auto: false // <--- MARCA DE SEGURIDAD: Esto es manual, el sync no lo toca
                });
                DataManager.save(d);
                this.renderAgendaEditor(document.getElementById('admin-tab-agenda'));
            },

            updateSessionField(id, field, value) {
                const d = DataManager.get();
                const s = d.sesiones.find(x => x.id === id);
                if(s) {
                    if(field === 'date') {
                        // FIX: Agregamos T12:00:00 para forzar mediodía y evitar que la zona horaria reste un día
                        s.date = new Date(value + 'T12:00:00').toISOString();
                    } else {
                        s[field] = value;
                    }
                    DataManager.save(d);
                    // No re-renderizamos para mantener el foco, excepto si cambiamos asociación
                }
            },

            // 3. ELIMINAR (CORREGIDO + TEMA OSCURO)
            deleteSession(id) {
                Swal.fire({ 
                    title: '¿Eliminar Sesión?', 
                    text: 'Esto borrará las reservas asociadas permanentemente.', 
                    icon: 'warning', 
                    showCancelButton: true, 
                    confirmButtonColor: '#d33', 
                    cancelButtonColor: '#333', // Cancelar oscuro
                    background: '#05060b', // Fondo oscuro
                    color: '#fff' 
                }).then((r) => {
                    if(r.isConfirmed) {
                        const d = DataManager.get();
                        // CORRECCIÓN DEL BUG: Asegurar que los arrays existan antes de filtrar
                        if(d.sesiones) d.sesiones = d.sesiones.filter(s => s.id !== id);
                        if(d.reservas) d.reservas = d.reservas.filter(r => r.sesionId !== id); 
                        
                        DataManager.save(d);
                        this.renderAgendaEditor(document.getElementById('admin-tab-agenda'));
                        Swal.fire({ title: 'Eliminado', icon: 'success', background: '#05060b', color: '#fff', confirmButtonColor: '#D4AF37', showConfirmButton: false, timer: 1500 });
                    }
                });
            },


            clearPastSessions() {
                const d = DataManager.get();
                const today = new Date().setHours(0,0,0,0);
                d.sesiones = d.sesiones.filter(s => new Date(s.date) >= today);
                DataManager.save(d);
                this.renderAgendaEditor(document.getElementById('admin-tab-agenda'));
            },

            // GESTIÓN DE SESIÓN (Modal Interno)
            manageSession(id) {
                const s = DataManager.get().sesiones.find(x => x.id === id);
                if(!s) return;
                const c = DataManager.get().clases.find(x => x.id === s.claseId);
                
                const html = `
                    <div class="space-y-6">
                        <div class="bg-white/5 p-4 rounded-lg border border-white/10">
                            <h4 class="text-gold font-bold uppercase text-xs mb-2">Contenido Multimedia (Para Alumnos)</h4>
                            <input type="text" id="sess-media-photo" class="w-full bg-black p-2 rounded text-xs text-white border border-white/10 mb-2" placeholder="URL Carpeta Fotos (Drive/Dropbox)" value="${s.media?.photos?.[0] || ''}">
                            <input type="text" id="sess-media-video" class="w-full bg-black p-2 rounded text-xs text-white border border-white/10" placeholder="URL Video (Youtube/Vimeo)" value="${s.media?.videos?.[0] || ''}">
                            <button onclick="Admin.saveSessionMedia(${s.id})" class="btn-galaxy w-full mt-2 py-2 rounded text-xs font-bold">GUARDAR LINKS</button>
                        </div>
                        
                        <div>
                            <h4 class="text-neon font-bold uppercase text-xs mb-2">Lista de Asistencia</h4>
                            <div class="bg-black/50 rounded-lg p-2 max-h-40 overflow-y-auto border border-white/5">
                                <ul class="text-xs text-gray-300 space-y-2" id="session-attendance-list"></ul>
                            </div>
                        </div>
                    </div>
                `;
                
                $('#modal-title').innerText = `${c.name}`;
                $('#modal-subtitle').innerText = new Date(s.date).toLocaleDateString();
                $('#modal-body').innerHTML = html;
                $('#admin-modal').classList.remove('hidden');
                setTimeout(()=>{$('#modal-backdrop').classList.remove('opacity-0'); $('#modal-panel').classList.remove('scale-95','opacity-0')},10);
                $('#modal-save-btn').classList.add('hidden'); 

                // Llenar lista
                const reservas = DataManager.get().reservas.filter(r => r.sesionId === s.id);
                const listEl = document.getElementById('session-attendance-list');
                if(reservas.length === 0) listEl.innerHTML = '<li class="text-gray-500 italic text-center p-2">Nadie inscrito aún.</li>';
                else {
                    listEl.innerHTML = reservas.map(r => {
                        const alumno = DataManager.get().alumnos.find(a => a.id == r.alumnoId);
                        return `<li class="flex justify-between items-center border-b border-white/5 pb-1 last:border-0">
                            <span>${alumno ? alumno.name : 'Invitado'}</span>
                            <span class="px-2 py-0.5 rounded text-[9px] font-bold ${r.asistencia ? 'bg-success/20 text-success' : 'bg-white/5 text-gray-500'}">${r.asistencia ? 'ASISTIÓ' : 'PENDIENTE'}</span>
                        </li>`;
                    }).join('');
                }
            },

            saveSessionMedia(id) {
                const d = DataManager.get();
                const idx = d.sesiones.findIndex(s => s.id === id);
                if(idx > -1) {
                    const p = document.getElementById('sess-media-photo').value;
                    const v = document.getElementById('sess-media-video').value;
                    d.sesiones[idx].media = { photos: [p], videos: [v] };
                    DataManager.save(d);
                    Swal.fire({ title: 'Guardado', text: 'Contenido disponible para alumnos asistentes.', icon: 'success', confirmButtonColor: '#D4AF37' });
                }
            },

            projectQR(token, className) {
                // Modal a pantalla completa (Overlay z-index maximo)
                const overlay = document.createElement('div');
                overlay.className = "fixed inset-0 z-[9999] bg-black flex flex-col items-center justify-center p-8";
                overlay.innerHTML = `
                    <button onclick="this.parentElement.remove()" class="absolute top-8 right-8 text-white text-4xl hover:text-rose transition-colors"><i class="fa-solid fa-times"></i></button>
                    <h1 class="text-gold font-serif text-4xl md:text-6xl mb-8 text-center animate-pulse">${className}</h1>
                    <div class="bg-white p-4 rounded-xl shadow-[0_0_100px_rgba(212,175,55,0.5)]">
                        <div id="fs-qrcode"></div>
                    </div>
                    <p class="text-white/50 mt-8 text-xl uppercase tracking-[0.5em]">Escanea para Asistencia</p>
                `;
                document.body.appendChild(overlay);
                
                new QRCode(document.getElementById("fs-qrcode"), {
                    text: token,
                    width: window.innerHeight * 0.5, // 50% de la altura de la pantalla
                    height: window.innerHeight * 0.5,
                    colorDark : "#000000",
                    colorLight : "#ffffff"
                });
            },

            addSchedule(classIdx) {
                const d = DataManager.get();
                if(!d.clases[classIdx].schedules) d.clases[classIdx].schedules = [];
                d.clases[classIdx].schedules.push({day: 1, time: "19:00"});
                DataManager.save(d);
                this.renderClasesEditor(document.getElementById('admin-tab-clases'));
            },
            removeSchedule(classIdx, schIdx) {
                const d = DataManager.get();
                d.clases[classIdx].schedules.splice(schIdx, 1);
                DataManager.save(d);
                this.renderClasesEditor(document.getElementById('admin-tab-clases'));
            },

            linkSessionClass(sessionId, val) {
                const d = DataManager.get();
                const s = d.sesiones.find(x => x.id === sessionId);
                if(s) {
                    if (val === 'custom') {
                        s.claseId = null; // Se desvincula
                        s.customName = "Evento Especial"; // Nombre default
                    } else {
                        s.claseId = parseInt(val); // Se vincula a la clase
                        s.customName = null; // Borramos nombre custom para usar el de la clase
                    }
                    DataManager.save(d);
                    this.renderAgendaEditor(document.getElementById('admin-tab-agenda')); // Refrescamos para ver cambios de UI
                }
            },

            // --- GESTIÓN DE ALUMNOS (CRM) ---
            
            renderAlumnosEditor(container) {
                if(!container) return;
                const d = DataManager.get();
                const alumnos = d.alumnos || [];
                const planes = d.membresias || [];
                const reservas = d.reservas || [];
                const sesiones = d.sesiones || [];

                // 1. CÁLCULO DE FECHAS (Semana Actual)
                const curr = new Date();
                const day = curr.getDay() || 7; 
                const monday = new Date(curr.setDate(curr.getDate() - day + 1));
                monday.setHours(0,0,0,0);
                const sunday = new Date(monday);
                sunday.setDate(monday.getDate() + 6);
                sunday.setHours(23,59,59,999);

                container.innerHTML = `
                    <div class="max-w-6xl mx-auto pb-20 fade-in">
                        <div class="flex justify-between items-end mb-8">
                            <div>
                                <h1 class="text-3xl font-serif font-bold text-white">Comunidad Estudiantil</h1>
                                <p class="text-gray-400 text-sm mt-1">Base de datos de clientes y profesores.</p>
                            </div>
                            <button onclick="Admin.openStudentModal()" class="btn-galaxy px-6 py-3 rounded-lg text-xs font-bold shadow-lg hover:scale-105 transition-transform">+ NUEVO</button>
                        </div>

                        <div class="bg-transparent md:bg-panel rounded-xl md:border border-white/10 overflow-hidden">
                            <table class="w-full text-left text-sm text-gray-400">
                                <thead class="bg-white/5 text-xs uppercase text-gold hidden md:table-header-group">
                                    <tr>
                                        <th class="p-4">Cliente / Cédula</th>
                                        <th class="p-4">Contacto</th>
                                        <th class="p-4">Plan Actual</th>
                                        <th class="p-4 text-center">Saldo Semanal</th>
                                        <th class="p-4 text-center">Extras</th>
                                        <th class="p-4 text-center">Acciones</th>
                                    </tr>
                                </thead>
                                
                                <tbody class="divide-y divide-white/5 block md:table-row-group space-y-4 md:space-y-0">
                                    ${alumnos.map(a => {
                                        const plan = planes.find(p => p.id === a.planId) || {name: 'Sin Plan', weeklyLimit: 0};
                                        const isTeacher = a.role === 'admin';
                                        
                                        // 2. CÁLCULO DE SALDO INDIVIDUAL
                                        let saldoDisplay = '-';
                                        if (!isTeacher) {
                                            const usadas = reservas.filter(r => {
                                                if (r.alumnoId !== a.id) return false;
                                                const sesion = sesiones.find(s => s.id === r.sesionId);
                                                if (!sesion) return false;
                                                const fechaSesion = new Date(sesion.date);
                                                return fechaSesion >= monday && fechaSesion <= sunday;
                                            }).length;

                                            const total = (plan.weeklyLimit || 0) + (a.extraCredits || 0);
                                            const restantes = Math.max(0, total - usadas);
                                            
                                            // Formato visual: "3 / 5"
                                            saldoDisplay = `<span class="text-white font-bold text-lg">${restantes}</span> <span class="text-gray-600 text-xs">/ ${total}</span>`;
                                        }

                                        return `
                                        <tr class="hover:bg-white/5 transition block md:table-row bg-panel md:bg-transparent border border-white/10 md:border-0 rounded-xl p-5 md:p-0 relative shadow-lg md:shadow-none">
                                            
                                            <td class="p-0 md:p-4 block md:table-cell mb-4 md:mb-0 border-b border-white/5 md:border-none pb-3 md:pb-0">
                                                <div class="flex items-center gap-3">
                                                    <div class="w-10 h-10 rounded-full ${isTeacher ? 'bg-gold/20 border-gold text-gold' : 'bg-white/10 border-white/20 text-white'} border flex items-center justify-center shrink-0 text-sm font-bold font-serif">
                                                        ${isTeacher ? '<i class="fa-solid fa-crown"></i>' : a.name.charAt(0).toUpperCase()}
                                                    </div>
                                                    <div>
                                                        <div class="font-bold text-white text-base leading-tight">${a.name}</div>
                                                        <div class="text-xs font-mono text-gray-500 tracking-wider">${a.id}</div>
                                                    </div>
                                                </div>
                                            </td>

                                            <td class="p-0 md:p-4 block md:table-cell mb-2 md:mb-0">
                                                <div class="flex flex-col text-xs gap-1.5">
                                                    ${a.birthDate ? `<span class="text-gray-400 flex items-center gap-2" title="Cumpleaños"><i class="fa-solid fa-cake-candles text-rose-400 w-4 text-center"></i> ${new Date(a.birthDate + 'T12:00:00').toLocaleDateString()}</span>` : ''}
                                                    
                                                    ${a.phone ? `<span class="text-white flex items-center gap-2"><i class="fa-brands fa-whatsapp text-success w-4 text-center text-sm"></i> ${a.phone}</span>` : '<span class="text-gray-600 pl-6">-</span>'}
                                                    
                                                    ${a.email ? `<span class="text-gray-500 truncate max-w-[150px] flex items-center gap-2" title="${a.email}"><i class="fa-regular fa-envelope text-gray-400 w-4 text-center"></i> ${a.email}</span>` : ''}
                                                </div>
                                            </td>

                                            <td class="p-0 md:p-4 block md:table-cell mb-2 md:mb-0">
                                                <div class="flex justify-between items-center md:block">
                                                    <span class="md:hidden text-[10px] uppercase font-bold text-gray-500">Plan:</span>
                                                    ${isTeacher 
                                                        ? '<span class="text-gold text-[10px] font-bold border border-gold/30 px-2 py-0.5 rounded uppercase">Profesor</span>' 
                                                        : `<span class="bg-white/10 px-3 py-1 rounded text-xs text-neon border border-white/10">${plan.name}</span>`
                                                    }
                                                </div>
                                            </td>

                                            <td class="p-0 md:p-4 block md:table-cell text-right md:text-center mb-2 md:mb-0">
                                                <div class="flex justify-between items-center md:justify-center">
                                                    <span class="md:hidden text-[10px] uppercase font-bold text-gray-500">Saldo Disp.:</span>
                                                    <div>${saldoDisplay}</div>
                                                </div>
                                            </td>

                                            <td class="p-0 md:p-4 block md:table-cell text-center mb-4 md:mb-0">
                                                ${!isTeacher ? `
                                                <div class="flex justify-between items-center md:justify-center">
                                                    <span class="md:hidden text-[10px] uppercase font-bold text-gray-500">Compensar:</span>
                                                    <div class="flex items-center gap-2 bg-black/40 rounded-lg p-1 border border-white/5">
                                                        <button onclick="Admin.adjustCredits('${a.id}', -1)" class="text-rose-500 hover:text-white w-6 h-6 flex items-center justify-center">-</button>
                                                        <span class="text-white font-bold w-4 text-center text-xs">${a.extraCredits || 0}</span>
                                                        <button onclick="Admin.adjustCredits('${a.id}', 1)" class="text-success hover:text-white w-6 h-6 flex items-center justify-center">+</button>
                                                    </div>
                                                </div>` : ''}
                                            </td>

                                            <td class="p-0 md:p-4 block md:table-cell text-center border-t border-white/10 md:border-none pt-3 md:pt-0">
                                                <div class="flex justify-end gap-3 md:justify-center">
                                                    <button onclick="Admin.openStudentModal('${a.id}')" class="w-8 h-8 rounded bg-white/5 hover:bg-gold hover:text-black text-gray-400 transition-colors flex items-center justify-center">
                                                        <i class="fa-solid fa-pen text-xs"></i>
                                                    </button>
                                                    <button onclick="Admin.deleteItem('alumnos', '${a.id}')" class="w-8 h-8 rounded bg-rose-950/20 hover:bg-rose-600 hover:text-white text-rose-500 border border-rose-500/20 transition-colors flex items-center justify-center">
                                                        <i class="fa-solid fa-trash text-xs"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>`;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            },

            adjustCredits(studentId, amount) {
                const d = DataManager.get();
                const s = d.alumnos.find(a => a.id === studentId);
                if(s) {
                    if(!s.extraCredits) s.extraCredits = 0;
                    s.extraCredits += amount;
                    DataManager.save(d);
                    this.renderAlumnosEditor(document.getElementById('admin-tab-alumnos'));
                }
            },

            openStudentModal(id = null) {
                const d = DataManager.get();
                const student = id ? d.alumnos.find(a => a.id === id) : {};
                const plans = d.membresias || [];
                const isNew = !id;

                // Lógica UI
                window.togglePlanSelect = (roleVal) => {
                    const planDiv = document.getElementById('plan-container');
                    if(roleVal === 'admin') planDiv.classList.add('hidden');
                    else planDiv.classList.remove('hidden');
                };

                const html = `
                    <div class="space-y-4">
                        <div>
                            <label class="admin-label text-gold">Número de Cédula (Será el Usuario)</label>
                            <input type="text" id="st-id" class="admin-input w-full bg-black border border-white/10 p-3 rounded text-white font-mono tracking-wider focus:border-gold outline-none" 
                                value="${student.id || ''}" 
                                placeholder="Ej. 118540678" 
                                ${!isNew ? 'readonly class="opacity-50 cursor-not-allowed"' : ''}>
                        </div>

                        <div>
                            <label class="admin-label">Nombre y Apellidos</label>
                            <input type="text" id="st-name" class="admin-input w-full bg-black border border-white/10 p-3 rounded text-white outline-none focus:border-gold" value="${student.name || ''}" placeholder="Nombre completo">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="admin-label">Teléfono / WhatsApp</label>
                                <input type="tel" id="st-phone" class="admin-input w-full bg-black border border-white/10 p-3 rounded text-white outline-none focus:border-gold" value="${student.phone || ''}" placeholder="8888-8888">
                            </div>
                            <div>
                                <label class="admin-label">Correo Electrónico</label>
                                <input type="email" id="st-email" class="admin-input w-full bg-black border border-white/10 p-3 rounded text-white outline-none focus:border-gold" value="${student.email || ''}" placeholder="correo@ejemplo.com">
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="admin-label">Fecha de Nacimiento <span class="text-gray-600">(Opcional)</span></label>
                                <input type="date" id="st-birth" class="admin-input w-full bg-black border border-white/10 p-3 rounded text-white outline-none focus:border-gold relative z-10" value="${student.birthDate || ''}" onchange="this.blur()">
                            </div>
                            <div class="flex flex-col justify-end pb-3">
                                <span class="text-[10px] text-gray-500 uppercase font-bold">Fecha de Ingreso</span>
                                <span class="text-sm text-gold font-mono">${student.joinDate ? new Date(student.joinDate).toLocaleDateString() : 'Se registrará hoy'}</span>
                            </div>
                        </div>
                        
                        <div class="border-t border-white/10 my-2"></div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="admin-label text-gold">Rol del Usuario</label>
                                <select id="st-role" class="w-full bg-black border border-gold/30 p-3 rounded text-white outline-none focus:border-gold" onchange="window.togglePlanSelect(this.value)">
                                    <option value="student" ${student.role !== 'admin' ? 'selected' : ''}>Estudiante</option>
                                    <option value="admin" ${student.role === 'admin' ? 'selected' : ''}>Profesor / Admin</option>
                                </select>
                            </div>
                            <div>
                                <label class="admin-label">Contraseña</label>
                                <input type="text" id="st-pass" class="admin-input w-full bg-black border border-white/10 p-3 rounded text-white outline-none focus:border-gold" value="${student.pass || 'sensacion'}" placeholder="sensacion">
                            </div>
                        </div>

                        <div id="plan-container" class="${student.role === 'admin' ? 'hidden' : ''}">
                            <label class="admin-label">Membresía Activa</label>
                            <select id="st-plan" class="w-full bg-black border border-white/10 p-3 rounded text-white outline-none">
                                <option value="">-- Sin Membresía --</option>
                                ${plans.map(p => `<option value="${p.id}" ${student.planId === p.id ? 'selected' : ''}>${p.name} (${p.weeklyLimit} clases/sem)</option>`).join('')}
                            </select>
                        </div>
                    </div>
                `;

                $('#modal-title').innerText = isNew ? "NUEVO USUARIO" : "EXPEDIENTE";
                $('#modal-subtitle').innerText = isNew ? "Registro Inicial" : `Cédula: ${student.id}`;
                $('#modal-body').innerHTML = html;
                
                $('#admin-modal').classList.remove('hidden');
                setTimeout(()=>{$('#modal-backdrop').classList.remove('opacity-0'); $('#modal-panel').classList.remove('scale-95','opacity-0')},10);

                $('#modal-save-btn').classList.remove('hidden');
                
                $('#modal-save-btn').onclick = () => {
                    const newId = $('#st-id').value.trim();
                    const name = $('#st-name').value.trim();
                    
                    if(!newId || !name) return Swal.fire({title: 'Datos Incompletos', text: 'Cédula y Nombre son obligatorios', icon: 'warning', background: '#05060b', color: '#fff'});

                    const newStudent = {
                        id: newId, // La cédula es el ID
                        name: name,
                        phone: $('#st-phone').value,
                        email: $('#st-email').value,
                        birthDate: $('#st-birth').value,
                        joinDate: student.joinDate || new Date().toISOString(), // Mantiene la vieja o crea hoy
                        pass: $('#st-pass').value || 'sensacion', // Mantiene o usa default
                        role: $('#st-role').value,
                        planId: ($('#st-role').value === 'student' && $('#st-plan').value) ? parseInt($('#st-plan').value) : null,
                        extraCredits: student.extraCredits || 0,
                        active: true
                    };

                    if(id) {
                        const idx = d.alumnos.findIndex(a => a.id === id);
                        d.alumnos[idx] = newStudent;
                    } else {
                        if(d.alumnos.find(a => a.id === newId)) return Swal.fire({title: 'Duplicado', text: 'Esta cédula ya está registrada', icon: 'error', background: '#05060b', color: '#fff'});
                        d.alumnos.push(newStudent);
                    }
                    DataManager.save(d);
                    Admin.closeModal();
                    Admin.renderAlumnosEditor(document.getElementById('admin-tab-alumnos'));
                };
            },

        };

        window.onload = () => { App.init(); setTimeout(() => { $('#app-preloader').style.opacity='0'; setTimeout(()=>$('#app-preloader').remove(),1000); }, 2000); };

        // Escuchador de redimensionamiento para limpiar estados móviles al maximizar
        window.addEventListener('resize', () => {
            if (window.innerWidth >= 768) {
                const sidebar = $('#view-admin aside');
                // Si el sidebar tiene estilos en línea (indicativo de modo móvil activo)
                if (sidebar.style.position === 'fixed') {
                    sidebar.classList.add('hidden', 'md:flex');
                    sidebar.classList.add('pt-20'); 
                    sidebar.style.cssText = ''; // Limpieza total de estilos inyectados
                }
            }
        });
    
    
    </script>
</body>
</html>
